<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å’Œå¼¦è¾¨è­˜ç§»èª¿å¯¦é©—ç‰ˆ</title>
  <link rel="stylesheet" href="assets/app.css">
  <link rel="stylesheet" href="assets/app-experimental.css">
  <script type="module" src="assets/js/main.js"></script>
  <!-- ä»¥ä¸Šæ¨£å¼æ•´åˆå¾Œçš†å·²æŠ½é›¢åˆ° app.css / app-experimental.css -->
</head>
<body>
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans);
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var(--ease-standard),
                  color var(--dur-base) var(--ease-standard),
                  box-shadow var(--dur-fast) var(--ease-standard),
                  border-color var(--dur-base);
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    .btn.small { padding: 6px 12px; font-size: 13px; }

    /* Gemini API Key å¡ç‰‡ */
    .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
  /* ä½¿ç”¨çµ±ä¸€çš„ #api-key æ¬„ä½ */
  #api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* æ–°å¢çš„æ¨£å¼å€åŸŸ */
    /* å®‰å…¨é ç·¨è­¯ï¼šå–®ä¸€ä¾†æºï¼Œé¿å…å­—ä¸²æ‹¼æ¥éºå¤±è·³è„« */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* é€šç”¨æ¨£å¼ */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans);
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var(--ease-standard),
                  color var(--dur-base) var(--ease-standard),
                  box-shadow var(--dur-fast) var(--ease-standard),
                  border-color var(--dur-base) var(--ease-standard);
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    <!-- å·²ç§»é™¤é‡è¤‡å…§åµŒæ¨£å¼ï¼šflow ç›¸é—œæ¨£å¼ä½æ–¼ app.css -->
    <!-- åˆ†é å°è¦½åˆ— -->
  <!-- UI èª¿æ•´ï¼šåŠ å…¥é ‚éƒ¨ 20px é–“è·ï¼Œç¬¦åˆéœ€æ±‚ 1 -->
  <nav id="app-tabs" style="max-width:var(--layout-max);margin:20px auto 8px;padding:0 32px;display:flex;gap:8px;justify-content:center;">
      <button class="tab-btn-modern" data-view="upload" aria-selected="true">ä¸Šå‚³</button>
      <button class="tab-btn-modern" data-view="recognition" aria-selected="false">è¾¨è­˜</button>
      <button class="tab-btn-modern" data-view="transpose" aria-selected="false">ç§»èª¿</button>
      <button class="tab-btn-modern" data-view="export" aria-selected="false">åŒ¯å‡º</button>
    </nav>
    <style>
  /* UI èª¿æ•´ï¼šæŒ‰éˆ•æ”¹ç‚ºé•·æ–¹æ¡†åœ“è§’ (éœ€æ±‚ 2) */
  .tab-btn-modern{flex:0 0 auto;padding:10px 22px;border:1px solid var(--color-border);background:#fff;border-radius:14px;font:500 14px var(--font-sans);cursor:pointer;transition:background .25s, color .25s, box-shadow .25s;}
      .tab-btn-modern[aria-selected="true"]{background:var(--color-accent);color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.15);} 
      .tab-btn-modern:not([aria-selected="true"]):hover{background:var(--color-surface-alt);} 
      /* è½‰å ´å‹•ç•« */
      .view-panel-enter{opacity:0;transform:translateY(12px);}
      .view-panel-active{opacity:1;transform:translateY(0);transition:opacity .38s var(--ease-standard),transform .38s var(--ease-standard);} 
  /* UI èª¿æ•´ï¼šçµ±ä¸€å„é é¢é«˜åº¦ï¼Œä¸¦é ç•™ä¸‹æ–¹ç©ºç™½ï¼›min-height ä»¥è¦–çª—é«˜åº¦è¨ˆç®— (éœ€æ±‚ 3 éƒ¨åˆ†) */
  .flow-page{min-height:calc(100vh - 160px);} /* 160px ç´„ç•¥æ‰£æ‰å°è¦½èˆ‡å…§é‚Šè·ï¼Œå¿…è¦æ™‚å†å¾®èª¿ */
  #flow-container .panel-modern{margin-top:32px;} /* èª¿æ•´ï¼šé¢æ¿é–“è· 32px (ç”± 10px æå‡) */
    </style>
    <div id="flow-container">
      <div class="flow-track" id="flow-track">
  <!-- ç§»é™¤å…§åµŒ margin-top:8px; äº¤ç”±å…¨åŸŸ #flow-container .panel-modern æ§åˆ¶ 32px é–“è· -->
  <section id="upload-section" class="flow-page"><div class="flow-page-inner app-section-wrapper panel-modern">
      <h2 class="section-title" style="margin-top:0;">ä¸Šå‚³æ¨‚è­œ</h2>
      <p style="color:var(--color-text-secondary);max-width:640px;">é¸æ“‡åœ–ç‰‡æˆ– PDFï¼Œå¾ŒçºŒå¯ä½¿ç”¨ AI é€²è¡Œå’Œå¼¦ / æ­Œè©è¾¨è­˜ï¼Œä¸¦é€²å…¥ç§»èª¿èˆ‡åŒ¯å‡ºæµç¨‹ã€‚</p>
      <div style="margin-top:28px;display:flex;gap:32px;flex-wrap:wrap;align-items:flex-start;">
        <div class="paper-surface" style="flex:1 1 320px;min-width:300px;">
          <label class="upload-btn" style="margin-bottom:14px;">
            <input type="file" id="file-input" hidden accept="image/*,.pdf" />
            <span>é¸æ“‡æª”æ¡ˆ</span>
          </label>
          <div style="display:flex;flex-direction:column;gap:10px;margin:8px 0 4px;">
            <input id="api-key" type="password" placeholder="è¼¸å…¥ Gemini API Key" style="padding:8px 10px;border:1px solid var(--color-border);border-radius:8px;font:14px var(--font-sans);">
            
            <label style="font-size:11px;color:var(--color-text-secondary);display:flex;align-items:center;gap:4px;">
              <input type="checkbox" id="use-gemini-ai" checked style="margin:0;transform:scale(.9);" /> å•Ÿç”¨ Gemini (æ¸¬è©¦)
            </label>
            <label style="font-size:12px;color:var(--color-text-secondary);display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="show-key" style="margin:0;"> é¡¯ç¤ºé‡‘é‘°
            </label>
          </div>
          <div id="upload-hint" style="font-size:13px;color:var(--color-text-secondary);line-height:1.5;">æ”¯æ´ JPG / PNG / PDFã€‚é¸æ“‡å¾Œå¯æ–¼ä¸Šæ–¹ Hero é è¦½ï¼Œä¸¦å•Ÿç”¨ AI è¾¨è­˜ã€‚</div>
          <div style="margin-top:18px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <button id="recognize-btn-secondary" class="btn-primary" disabled>AI è¾¨è­˜</button>
            <!-- æ¸¬è©¦ç›¸å®¹ä¸»æŒ‰éˆ• alias -->
            <button id="recognize-ai-btn" style="display:none;" disabled>AI è¾¨è­˜</button>
            <span id="gemini-status" style="font-size:12px;color:var(--color-text-secondary);"></span>
          </div>
          <pre id="recognize-output" style="background:#111;color:#f5f5f7;padding:12px;border-radius:12px;font-size:12px;line-height:1.4;max-height:260px;overflow:auto;display:none;margin-top:16px;white-space:pre-wrap;"></pre>
        </div>
        <div id="upload-preview-box" class="paper-surface" style="flex:1 1 420px;min-height:280px;display:flex;align-items:center;justify-content:center;position:relative;">
          <div id="upload-preview-empty" style="text-align:center;color:var(--color-text-secondary);font-size:14px;">
            <div style="font-size:46px;opacity:.15;">ğŸ¼</div>
            å°šæœªé¸æ“‡æª”æ¡ˆ
          </div>
        </div>
        </div></div></section>
              <section id="recognition-section" class="flow-page"><div class="flow-page-inner app-section-wrapper panel-modern">
            <h2 class="section-title" style="margin-top:0;">AI è¾¨è­˜çµæœç·¨è¼¯</h2>
            <div style="display:flex;flex-wrap:wrap;gap:20px;margin:4px 0 28px;align-items:flex-end;">
              <div style="flex:2 1 320px;min-width:260px;display:flex;flex-direction:column;gap:6px;">
                <label class="subtle-label" for="song-title">æ­Œè­œæ¨™é¡Œ</label>
                <input id="song-title" placeholder="(AI è§£æå¾Œè‡ªå‹•å¡«å…¥ï¼Œå¯ä¿®æ”¹)" style="padding:10px 12px;border:1px solid var(--color-border);border-radius:12px;font:14px var(--font-sans);" />
              </div>
              <div style="flex:0 0 140px;display:flex;flex-direction:column;gap:6px;">
                <label class="subtle-label" for="from-key">åµæ¸¬èª¿æ€§</label>
                <input id="detected-key" placeholder="--" title="å¯æ‰‹å‹•ä¿®æ­£èª¿æ€§ (ä¾‹å¦‚: Bb, F#, Eb)" style="padding:10px 12px;border:1px solid var(--color-border);border-radius:12px;font:14px var(--font-sans);width:100%;" />
              </div>
            </div>
            <div style="display:flex;flex-direction:row;gap:32px;flex-wrap:wrap;align-items:stretch;">
              <div class="paper-surface" style="flex:1 1 380px;min-width:340px;max-height:520px;overflow:hidden;display:flex;flex-direction:column;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;gap:8px;">
                  <span class="subtle-label" style="margin:0;">åŸå§‹å½±åƒ</span>
                  <div id="zoom-controls" style="display:flex;gap:6px;">
                    <button type="button" class="btn small" data-zoom="fit" title="é©æ‡‰å¯¬åº¦">é©æ‡‰å¯¬</button>
                    <button type="button" class="btn small" data-zoom="actual" title="åŸå°ºå¯¸æ»¾å‹•">åŸå°ºå¯¸</button>
                  </div>
                </div>
                <div id="recognition-original" class="zoom-fit" style="border:1px solid var(--color-border);border-radius:12px;min-height:320px;flex:1 1 auto;display:flex;align-items:flex-start;justify-content:flex-start;overflow:auto;background:#fff;">
                  <div style="text-align:center;color:var(--color-text-secondary);font-size:13px;">å°šæœªè¼‰å…¥</div>
                </div>
              </div>
              <div class="paper-surface" style="flex:2 1 520px;min-width:380px;display:flex;flex-direction:column;">
                <span class="subtle-label">æ–‡å­—ç·¨è¼¯</span>
                <div id="text-editor-wrap">
                  <textarea id="text-editor" placeholder="ç­‰å¾… AI è¾¨è­˜çµæœ..." spellcheck="false"></textarea>
                </div>
                <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-end;margin-top:16px;">
                  <button class="btn ghost" id="back-to-upload">è¿”å›ä¸Šå‚³</button>
                  <button class="btn primary" id="go-to-transpose" disabled>å‰å¾€ç§»èª¿ â–¶</button>
                </div>
              </div>
            </div>
              </div></section>
              <section id="transpose-section" class="flow-page"><div class="flow-page-inner app-section-wrapper panel-modern">
            <h2 class="section-title" style="margin-top:0;">ç§»èª¿è¨­å®š</h2>
            <div style="display:flex;flex-wrap:wrap;gap:32px;align-items:flex-start;">
              <div class="paper-surface" style="flex:1 1 320px;min-width:300px;display:flex;flex-direction:column;gap:18px;">
                <div>
                  <label class="subtle-label">åŸèª¿</label>
                  <select id="from-key" style="padding:8px 10px;border:1px solid var(--color-border);border-radius:8px;">
                    <option>C</option><option>C#</option><option>D</option><option>Eb</option><option>E</option><option>F</option><option>F#</option><option>G</option><option>Ab</option><option>A</option><option>Bb</option><option>B</option>
                  </select>
                </div>
                <div>
                  <label class="subtle-label">ç›®æ¨™èª¿</label>
                  <select id="to-key" style="padding:8px 10px;border:1px solid var(--color-border);border-radius:8px;">
                    <option>C</option><option>C#</option><option>D</option><option>Eb</option><option>E</option><option>F</option><option>F#</option><option>G</option><option>Ab</option><option>A</option><option>Bb</option><option>B</option>
                  </select>
                </div>
                <button class="btn primary" id="do-transpose" disabled>åŸ·è¡Œç§»èª¿</button>
                <div style="font-size:12px;color:var(--color-text-secondary);line-height:1.5;">åƒ…å°ã€Œçœ‹èµ·ä¾†åƒå’Œå¼¦ã€çš„ token é€²è¡Œè½‰èª¿ï¼Œæ­Œè©èˆ‡å…¶å®ƒç¬¦è™Ÿä¸è®Šã€‚</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  <button class="btn ghost" id="transpose-back">â—€ è¿”å›ç·¨è¼¯</button>
                  <button class="btn" id="transpose-finish" disabled>å‰å¾€åŒ¯å‡º â–¶</button>
                </div>
              </div>
              <div class="paper-surface" style="flex:2 1 520px;min-width:380px;display:flex;flex-direction:column;">
                <span class="subtle-label">ç§»èª¿å¾Œå…§å®¹</span>
                  <textarea id="transpose-output" class="big-textarea" placeholder="å°šæœªç§»èª¿"></textarea>
              </div>
            </div>
          </div>
        </div></section>
        <section id="export-section" class="flow-page"><div class="flow-page-inner app-section-wrapper panel-modern">
      <h2 class="section-title" style="margin-top:0;">åŒ¯å‡º</h2>
      <div style="display:flex;flex-wrap:wrap;gap:32px;align-items:flex-start;">
        <div class="paper-surface" style="flex:1 1 100%;min-width:620px;display:flex;flex-direction:column;">
                <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between;margin-bottom:8px;">
            <span class="subtle-label">åŒ¯å‡ºé è¦½ï¼ˆä½¿ç”¨ç§»èª¿å¾Œå…§å®¹ï¼Œè‹¥ç„¡å‰‡åŸå§‹è¾¨è­˜ï¼‰</span>
            <label style="font-size:12px;color:var(--color-text-secondary);display:inline-flex;align-items:center;gap:6px;">
              <input type="checkbox" id="export-bold-toggle" /> ç²—é«”
            </label>
                  <label style="font-size:12px;color:var(--color-text-secondary);display:inline-flex;align-items:center;gap:6px;">
                    <input type="checkbox" id="export-mono-toggle" checked /> ç­‰å¯¬å­—å‹
                  </label>
          </div>
          <textarea id="export-preview-text" class="big-textarea" placeholder="å°šæœªæœ‰å…§å®¹" style="font-family:'Microsoft JhengHei','å¾®è»Ÿæ­£é»‘é«”','Noto Sans TC','PingFang TC','Segoe UI',Arial,sans-serif;"></textarea>
          <div id="export-info"></div>
          <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-end;margin-top:16px;">
            <button class="btn" id="export-refresh">é‡æ–°è¼‰å…¥å…§å®¹</button>
            <button class="btn primary" id="export-download-png">ä¸‹è¼‰ PNG</button>
            <button class="btn" id="export-download-jpg">ä¸‹è¼‰ JPG</button>
            <button class="btn primary" id="export-download-pdf">ä¸‹è¼‰ PDF</button>
          </div>
        </div>
      </div>
        </div></section>
      </div>
    </div>
  <script>
    (function(g,d){
      // éŒ¯èª¤ç›£è½ï¼ˆé˜²æ­¢éœé»˜å¤±æ•—ï¼‰
      if(!g.__UI_ERR_TRAP__){
        g.__UI_ERR_TRAP__=true;
        g.addEventListener('error',e=>{
          console.warn('[InitError]', e.message, e.filename+':'+e.lineno);
          const box = d.getElementById('gemini-status') || d.querySelector('[data-role="status"]');
          if(box) box.textContent = 'åˆå§‹åŒ–éŒ¯èª¤ï¼š' + e.message;
        });
      }

    // è‹¥ switchView ç¼ºå¤± â†’ å»ºç«‹ç°¡æ˜“ç‰ˆ
    // ç§»é™¤èˆŠç‰ˆ switchView (hidden) ä¿ç•™æ–°æ°´å¹³åˆ‡æ›

    // åˆå§‹å®šä½åˆ°ç¬¬ä¸€é 
    g.switchView && g.switchView('upload');

      // --- æ–°å¢ï¼šä¸Šå‚³é è¦½èˆ‡ Hero/æ¬¡æŒ‰éˆ•åŒæ­¥é‚è¼¯ ---
      function syncPreview(file){
        const heroBox = d.getElementById('hero-preview');
        const uploadBox = d.getElementById('upload-preview-box');
        const empty1 = d.getElementById('upload-preview-empty');
        if(!file){
          empty1 && (empty1.style.display='');
          if(heroBox) heroBox.innerHTML = '<div class="hero__placeholder"><div style="font-size:46px;opacity:.12;">ğŸ¼</div><span>ç­‰å¾…ä¸Šå‚³æ¨‚è­œå½±åƒ</span></div>';
          if(uploadBox) uploadBox.innerHTML = '<div id="upload-preview-empty" style="text-align:center;color:var(--color-text-secondary);font-size:14px;"><div style="font-size:46px;opacity:.15;">ğŸ¼</div>å°šæœªé¸æ“‡æª”æ¡ˆ</div>';
          return;
        }
        const url = URL.createObjectURL(file);
        const imgHTML = file.type==='application/pdf'
          ? '<div style="text-align:center;color:var(--color-text-secondary);font-size:13px;">PDF å·²é¸æ“‡ï¼Œç¨å¾Œæ–¼è¾¨è­˜é é è¦½ç¬¬ä¸€é ã€‚</div>'
          : `<img src="${url}" alt="preview" style="max-width:100%;height:auto;display:block;">`;
        if(heroBox){
          heroBox.innerHTML = `<div style="padding:12px;width:100%;height:100%;display:flex;align-items:center;justify-content:center;">${imgHTML}</div>`;
        }
        if(uploadBox){
          uploadBox.innerHTML = `<div style="width:100%;">${imgHTML}</div>`;
        }
      }

      function enableRecognize(enable){
        const btn1 = d.getElementById('recognize-btn');
        const btn2 = d.getElementById('recognize-btn-secondary');
        const btn3 = d.getElementById('recognize-ai-btn');
        [btn1,btn2,btn3].forEach(b=>{ if(b){ b.disabled = !enable; if(!enable) b.setAttribute('disabled',''); else b.removeAttribute('disabled'); }});
      }

      const fi = d.getElementById('file-input');
      if(fi && !fi.__wired){
        fi.addEventListener('change',()=>{
          const f = fi.files && fi.files[0];
          syncPreview(f);
          enableRecognize(!!f);
        });
        fi.__wired = true;
      }

      // ä¸€é–‹å§‹æª¢æŸ¥æ˜¯å¦å·²æœ‰é å…ˆçš„æª”æ¡ˆ URLï¼ˆä¾‹å¦‚å¾ä¸Šæ¬¡ç‹€æ…‹æ¢å¾©ï¼‰
      if(fi && fi.files && fi.files[0]){
        syncPreview(fi.files[0]);
        enableRecognize(true);
      }

      // === åˆ†é åˆ‡æ›æ§åˆ¶ ===
      g.switchView = function(view){
        const order=['upload','recognition','transpose','export'];
        const idx = order.indexOf(view);
        if(idx<0){ console.warn('[switchView] unknown view', view); return; }
        const track = d.getElementById('flow-track');
        // è‡ªæˆ‘ä¿®å¾©ï¼šç¢ºä¿å››é éƒ½åœ¨ track å…§
        if(track){ ['upload-section','recognition-section','transpose-section','export-section'].forEach(id=>{ const el=d.getElementById(id); if(el && el.parentElement!==track) track.appendChild(el); }); }
        if(track){
          const container = d.getElementById('flow-container');
          const gapValue = 40; // èˆ‡ .flow-track gap ä¿æŒä¸€è‡´ (experimental sync)
          const pages = track.querySelectorAll('.flow-page');
          if(container && pages.length){
            // å–å¾—å–®é å¯¦éš›å¯¬åº¦ï¼ˆcalc å¾Œçµæœï¼‰
            const pageWidth = pages[0].getBoundingClientRect().width;
            // è¨ˆç®—å‰é¢é é¢ç¸½ä½ç§» (æ¯é å¯¬ + gap)
            const offset = idx * (pageWidth + gapValue);
            // ç½®ä¸­èª¿æ•´ï¼šå®¹å™¨å‰©é¤˜ç©ºé–“çš„ä¸€åŠ
            const centerAdjust = (container.clientWidth - pageWidth)/2;
            track.style.transform = `translateX(${-(offset - centerAdjust)}px)`;
          } else {
            // å›é€€ç­–ç•¥
            track.style.transform = `translateX(-${idx*100}%)`;
          }
        }
        // ä¸Šæ–¹åœ“è§’ tab aria-selected åŒæ­¥
        d.querySelectorAll('#app-tabs .tab-btn-modern').forEach(btn=>{
          const active = btn.getAttribute('data-view')===view;
          btn.setAttribute('aria-selected', active?'true':'false');
        });
        try{ localStorage.setItem('chordapp.activeView',view);}catch(_){ }
        if(view==='export'){
          try { refreshExportPreview(); } catch(e){ console.warn('[switchView] refresh export fail', e); }
        }
      };
      d.querySelectorAll('#app-tabs .tab-btn-modern').forEach(btn=>{
        if(btn.__wired) return; btn.addEventListener('click',()=>{ const v=btn.getAttribute('data-view'); g.switchView(v); }); btn.__wired=true; });
      // åˆå§‹åŒ–æˆ–é‚„åŸä¸Šä¸€æ¬¡é é¢
      (function(){
        let first='upload';
        try{ const last=localStorage.getItem('chordapp.activeView'); if(last) first=last; }catch(_){ }
        g.switchView(first);
      })();

      // è¦–çª—æ”¹è®Šæ™‚é‡æ–°ç½®ä¸­ç•¶å‰é 
      g.addEventListener('resize',()=>{
        try{
          const current = localStorage.getItem('chordapp.activeView')||'upload';
          g.switchView(current);
        }catch(_){ }
      });

      // æ–¹å‘éµå¿«æ·åˆ‡æ›ï¼šæ”¹ç‚º Shift + ArrowLeft/ArrowRight
      g.addEventListener('keydown', (e)=>{
        if(e.altKey || e.metaKey || e.ctrlKey) return;
        if(!(e.shiftKey && (e.key==='ArrowLeft' || e.key==='ArrowRight'))) return;
        const order=['upload','recognition','transpose','export'];
        const current = (localStorage.getItem('chordapp.activeView')||'upload');
        const idx = order.indexOf(current);
        if(e.key==='ArrowRight' && idx < order.length-1){ e.preventDefault(); g.switchView(order[idx+1]); }
        else if(e.key==='ArrowLeft' && idx>0){ e.preventDefault(); g.switchView(order[idx-1]); }
      });

      // === åŒ¯å‡ºåŠŸèƒ½ ===
      function ensureExportLibs(){
        if(!g.html2canvas){
          const s=d.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js'; d.head.appendChild(s); }
        if(!g.jspdf){
          const s2=d.createElement('script'); s2.src='https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js'; d.head.appendChild(s2); }
      }
      function gatherCurrentContent(){
        // ä»¥ç§»èª¿è¼¸å‡ºå„ªå…ˆï¼Œå…¶æ¬¡ç·¨è¼¯å™¨ï¼Œå†æ¬¡ AI åŸå§‹ out
        const transOut = d.getElementById('transpose-output')?.value?.trim();
        const editor = d.getElementById('text-editor')?.value?.trim();
        const raw = d.getElementById('recognize-output')?.textContent?.trim();
        return transOut || editor || raw || '';
      }
      function refreshExportPreview(){
        const box = d.getElementById('export-preview-text');
        if(box){ box.value = gatherCurrentContent(); }
        // é è¦½å­—å‹èˆ‡ç²—é«”
        try{
          if(box){
            const useMono = d.getElementById('export-mono-toggle')?.checked !== false; // é è¨­ true
            box.style.fontFamily= useMono ? 'ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace' : '"Microsoft JhengHei","å¾®è»Ÿæ­£é»‘é«”","Noto Sans TC","PingFang TC","Segoe UI",Arial,sans-serif';
            const bold = !!d.getElementById('export-bold-toggle')?.checked; box.style.fontWeight = bold ? '700' : '400';
          }
        }catch(_){ }
        // é æª¢çµ±è¨ˆ
        try {
          const txt = box ? box.value : '';
          const lines = txt.split(/\n/).length;
            const chars = txt.length;
            // ç°¡æ˜“å’Œå¼¦ token æª¢æ¸¬ (å¤§å¯«å­—æ¯ + å¯é¸ #/b + å¯é¸ m / dim / aug / sus / 7 ç­‰)
            const chordMatches = txt.match(/\b([A-G](?:#|b)?(?:m|maj7|maj|dim|aug|sus2|sus4|add9|m7|7|m9|9|m6|6|dim7)?(?:\/[A-G](?:#|b)?)?)\b/g) || [];
            // PDF é ä¼°é æ•¸ï¼šå‡è¨­ä¸€é ç´„ 60 è¡Œï¼ˆç²—ä¼°ï¼‰
            const estPages = Math.max(1, Math.ceil(lines / 60));
            const infoEl = d.getElementById('export-info');
            if(infoEl){
              infoEl.innerHTML = `å­—å…ƒæ•¸: ${chars} | è¡Œæ•¸: ${lines} | åµæ¸¬å’Œå¼¦: ${chordMatches.length} | é ä¼° PDF é æ•¸: ${estPages}`;
            }
        } catch(err){ console.warn('[export preflight] fail', err); }
        ensureExportLibs();
      }
      const refreshBtn = d.getElementById('export-refresh');
      refreshBtn && !refreshBtn.__wired && (refreshBtn.addEventListener('click',refreshExportPreview), refreshBtn.__wired=true);
      const dlPng = d.getElementById('export-download-png');
      const dlPdf = d.getElementById('export-download-pdf');
      function createExportWrap(text){
        const pre = d.createElement('pre');
        pre.textContent = text; // ä¿ç•™æ‰€æœ‰ç©ºç™½èˆ‡æ›è¡Œ
        pre.style.margin='0';
        pre.style.whiteSpace='pre';
        pre.style.tabSize='4';
        const useMono = d.getElementById('export-mono-toggle')?.checked !== false;
        pre.style.fontFamily= useMono ? 'ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace' : '"Microsoft JhengHei","å¾®è»Ÿæ­£é»‘é«”","Noto Sans TC","PingFang TC","Segoe UI",Arial,sans-serif';
        pre.style.fontSize='14px';
        pre.style.lineHeight='1.55';
        const bold = !!d.getElementById('export-bold-toggle')?.checked; pre.style.fontWeight = bold ? '700' : '400';
        const wrap = d.createElement('div');
        wrap.style.position='fixed';wrap.style.left='-9999px';wrap.style.top='0';wrap.style.width='860px';wrap.style.padding='32px';wrap.style.background='#fff';wrap.style.boxSizing='border-box';
        wrap.appendChild(pre);
        return wrap;
      }
      dlPng && !dlPng.__wired && (dlPng.addEventListener('click', async ()=>{
        refreshExportPreview(); await new Promise(r=>setTimeout(r,50));
        if(!g.html2canvas){alert('html2canvas è¼‰å…¥ä¸­ï¼Œç¨å¾Œå†è©¦');return;}
        const txt = d.getElementById('export-preview-text');
        const wrap = createExportWrap(txt.value);
        d.body.appendChild(wrap);
        const canvas = await g.html2canvas(wrap,{scale:2,backgroundColor:'#ffffff'});
        d.body.removeChild(wrap);
        const a=d.createElement('a');
        const title = (d.getElementById('song-title')?.value||'chords').replace(/\s+/g,'_');
        const key = (d.getElementById('to-key')?.value||d.getElementById('from-key')?.value||'C');
        a.href = canvas.toDataURL('image/png'); a.download=`${title}_${key}_export.png`; a.click();
      }), dlPng.__wired=true);
      dlPdf && !dlPdf.__wired && (dlPdf.addEventListener('click', async ()=>{
        refreshExportPreview(); await new Promise(r=>setTimeout(r,50));
        if(!g.jspdf || !g.html2canvas){alert('åŒ¯å‡ºå‡½å¼åº«è¼‰å…¥ä¸­ï¼Œç¨å¾Œå†è©¦');return;}
        const { jsPDF } = g.jspdf; const txt = d.getElementById('export-preview-text');
        const wrap = createExportWrap(txt.value); d.body.appendChild(wrap);
        const canvas = await g.html2canvas(wrap,{scale:2,backgroundColor:'#ffffff'}); d.body.removeChild(wrap);
        const pdf = new jsPDF({unit:'pt',format:'a4'});
        const pageWidth = pdf.internal.pageSize.getWidth();
        const margin=40; const imgWidth=pageWidth-margin*2; const imgHeight = canvas.height * (imgWidth/canvas.width);
        const sliceHeight = pdf.internal.pageSize.getHeight() - margin*2;
        if(imgHeight <= sliceHeight){
          pdf.addImage(canvas.toDataURL('image/png'),'PNG',margin,margin,imgWidth,imgHeight);
        } else {
          let position=0; while(position < canvas.height){
            const pageCanvas=d.createElement('canvas'); pageCanvas.width=canvas.width; const slicePx=Math.min(canvas.height-position, Math.floor(sliceHeight*(canvas.width/imgWidth))); pageCanvas.height=slicePx; const ctx=pageCanvas.getContext('2d'); ctx.drawImage(canvas,0,position,canvas.width,slicePx,0,0,canvas.width,slicePx); const pageImg=pageCanvas.toDataURL('image/png'); if(position>0) pdf.addPage(); pdf.addImage(pageImg,'PNG',margin,margin,imgWidth,slicePx*(imgWidth/canvas.width)); position+=slicePx; }
        }
        const title = (d.getElementById('song-title')?.value||'chords').replace(/\s+/g,'_');
        const key = (d.getElementById('to-key')?.value||d.getElementById('from-key')?.value||'C');
        pdf.save(`${title}_${key}_export.pdf`);
      }), dlPdf.__wired=true);

      // === åŸå§‹å½±åƒç¸®æ”¾æ§åˆ¶ ===
      (function(){
        const container = d.getElementById('recognition-original');
        const controlsBox = d.getElementById('zoom-controls');
        if(!container || !controlsBox) return;
        function applyZoom(mode){
          container.classList.remove('zoom-fit','zoom-actual');
            if(mode==='actual') container.classList.add('zoom-actual'); else container.classList.add('zoom-fit');
          try{ localStorage.setItem('chordapp.zoomMode', mode);}catch(_){ }
          controlsBox.querySelectorAll('button').forEach(b=>{
            const active = b.getAttribute('data-zoom')===mode;
            b.style.background = active ? 'var(--color-accent)' : '#fff';
            b.style.color = active ? '#fff' : 'var(--color-text)';
            b.style.borderColor = active ? 'var(--color-accent)' : 'var(--color-border)';
          });
        }
        controlsBox.addEventListener('click',e=>{
          const btn = e.target.closest('button[data-zoom]'); if(!btn) return;
          applyZoom(btn.getAttribute('data-zoom'));
        });
        // åˆå§‹åŒ– zoom æ¨¡å¼
        let start='fit';
        try{ const saved=localStorage.getItem('chordapp.zoomMode'); if(saved) start=saved; }catch(_){ }
        applyZoom(start);
        // æš´éœ²ä»¥ä¾¿è¾¨è­˜å®Œæˆå¾Œä¸è¦†è“‹æ¨¡å¼
        g.__applyRecognitionZoom = applyZoom;
      })();


      // === API Key é¡¯ç¤ºåˆ‡æ› ===
      const showKeyChk = d.getElementById('show-key');
      const apiKeyInput = d.getElementById('api-key');
      if(showKeyChk && apiKeyInput && !showKeyChk.__wired){
        showKeyChk.addEventListener('change',()=>{ apiKeyInput.type = showKeyChk.checked ? 'text':'password'; });
        showKeyChk.__wired = true;
      }

      // === Gemini API å‘¼å«æ ¸å¿ƒï¼ˆç²¾ç°¡ç‰ˆï¼‰ ===
      async function fileToBase64Mime(file){
        return new Promise((resolve,reject)=>{
          const r=new FileReader();
            r.onerror=()=>reject(new Error('è®€å–æª”æ¡ˆå¤±æ•—'));
            r.onload=()=>{
              const res=r.result;
              const m=String(res).match(/^data:([^;]+);base64,(.*)$/);
              if(!m) return reject(new Error('ç„¡æ³•è§£æ base64'));
              resolve({mimeType:m[1],base64:m[2]});
            };
          r.readAsDataURL(file);
        });
      }
      function buildPrompt(){
        return (
          'ä½ æ˜¯ä¸€å€‹æ¨‚è­œ OCR å°ˆå®¶ã€‚è«‹å¾åœ–åƒåµæ¸¬ä¸¦è¼¸å‡ºï¼š\n' +
          '1) æ¨‚æ›²æ¨™é¡Œ (Title)\n' +
          '2) æ¨‚æ›²ä¸»èª¿ (Key) è‹¥ç„¡æ˜ç¤ºï¼Œæ ¹æ“šå’Œå¼¦æ¨æ¸¬æœ€å¯èƒ½èª¿æ€§ (åªè¼¸å‡ºä¸€å€‹ï¼Œå¦‚ C / G / F# / Bb)ã€‚\n' +
          '3) ä¸»è¦å…§å®¹ (å’Œå¼¦ + æ­Œè©)\n\n' +
          'è¼¸å‡ºæ ¼å¼è«‹ç”¨ä¸‹åˆ— JSON åŒ…åœ¨æœ€å¤–å±¤çš„ ```json ç¨‹å¼ç¢¼å€å¡Šï¼š\n' +
          '```json\n' +
          '{"title":"...","key":"...","content":"å¤šè¡Œå’Œå¼¦èˆ‡æ­Œè©"}\n' +
          '```\n' +
          'è¦å‰‡ï¼šå’Œå¼¦è¡Œä¿ç•™è±ç·š |ï¼Œæ­Œè©è¡Œç§»é™¤ |ï¼›ä¿æŒåŸæ®µè½é †åºèˆ‡ç©ºç™½ï¼›ä¸è¦åŠ å…¥å¤šé¤˜è¨»è§£ã€‚'
        );
      }
      async function callGeminiAPIFromFile(file, apiKey){
        const {mimeType,base64}= await fileToBase64Mime(file);
        const body={contents:[{parts:[{text:buildPrompt()},{inlineData:{mimeType,data:base64}}]}],generationConfig:{temperature:0.1,maxOutputTokens:2048}};
        const url=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${encodeURIComponent(apiKey)}`;
        const resp= await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        if(!resp.ok){ const t=await resp.text(); throw new Error('Gemini API éŒ¯èª¤ '+resp.status+': '+t.slice(0,200)); }
        const json= await resp.json();
        const text=json?.candidates?.[0]?.content?.parts?.map(p=>p.text).filter(Boolean).join('\n')||'';
        return text;
      }
      function formatDisplay(raw){
        const basic = String(raw).split('\n').map(line=>{ if(/\|/.test(line) && /[A-G][#b]?/.test(line)) return line; return line.replace(/\|/g,''); }).join('\n');
        if(window.restructureChordLyricsBlock){
          try { return window.restructureChordLyricsBlock(basic); } catch(_){ return basic; }
        }
        return basic;
      }
      function parseMetadataFromText(text){
        const meta={title:'',key:'',content:text};
        // å˜—è©¦æŠ“å– ```json å€å¡Š
        const blockMatch = text.match(/```json[\s\S]*?({[\s\S]*?})\s*```/i);
        if(blockMatch){
          try {
            const obj = JSON.parse(blockMatch[1]);
            meta.title = obj.title || ''; meta.key = obj.key || ''; meta.content = obj.content || text;
            return meta;
          } catch{ /* ignore */ }
        }
        // å‚™æ´ï¼šç°¡å–®æ­£å‰‡æŠ“æ¨™é¡Œèˆ‡ Key
        const titleLine = text.split(/\n/).find(l=>/title\s*[:ï¼š]/i.test(l)) || '';
        const mTitle = titleLine.match(/title\s*[:ï¼š]\s*(.+)/i);
        if(mTitle) meta.title = mTitle[1].trim();
        const keyLine = text.split(/\n/).find(l=>/key\s*[:ï¼š]/i.test(l)) || '';
        const mKey = keyLine.match(/key\s*[:ï¼š]\s*([A-G][#b]?)/i);
        if(mKey) meta.key = mKey[1].toUpperCase();
        return meta;
      }
      async function handleRecognize(){
        const file = fi?.files?.[0];
        const apiKey = apiKeyInput?.value.trim();
        const statusEl = d.getElementById('gemini-status');
        const out = d.getElementById('recognize-output');
        if(!file){ statusEl.textContent='è«‹å…ˆé¸æ“‡æª”æ¡ˆ'; return; }
        if(!apiKey){ statusEl.textContent='è«‹è¼¸å…¥ API Key'; return; }
        statusEl.textContent='è¾¨è­˜ä¸­...'; out.style.display='none'; out.textContent='';
        try { const text = await callGeminiAPIFromFile(file, apiKey); const display = formatDisplay(text); out.textContent = display || '(ç„¡å…§å®¹)'; out.style.display='block'; statusEl.textContent='å®Œæˆ'; }
        catch(err){ statusEl.textContent='éŒ¯èª¤: '+err.message; }
      }
      const rbtn1 = d.getElementById('recognize-btn');
      const rbtn2 = d.getElementById('recognize-btn-secondary');
      [rbtn1,rbtn2].forEach(btn=>{ if(btn && !btn.__wired){ btn.addEventListener('click',handleRecognize); btn.__wired=true; }});
  const rbtn3 = d.getElementById('recognize-ai-btn');
  if(rbtn3 && !rbtn3.__wired){ rbtn3.addEventListener('click',handleRecognize); rbtn3.__wired=true; }

  // ç§»é™¤æ¸¬è©¦åˆ¥åæ¬„ä½ï¼ˆåƒ…ä¿ç•™ #api-keyï¼‰
      // åµæ¸¬èª¿æ€§æ‰‹å‹•ä¿®æ”¹åŒæ­¥
      const detectedKeyInput = d.getElementById('detected-key');
      if(detectedKeyInput && !detectedKeyInput.__wired){
        detectedKeyInput.addEventListener('change',()=>{
          let val = detectedKeyInput.value.trim();
          if(!val) return;
          // æ­£è¦åŒ–ï¼šé¦–å­—æ¯å¤§å¯« å…¶é¤˜è½‰å°å¯«ï¼Œå†è™•ç† b/#
            val = val.replace(/[^A-Ga-g#b]/g,'').toUpperCase().replace(/B(?!B)/,'B');
          // æ˜ å°„é™è™Ÿ to æ­£å¼ï¼ˆä¿ç•™åŸæ¨£è‹¥åˆæ³•ï¼‰
          const allow = ['C','C#','D','Eb','D#','E','F','F#','G','Ab','G#','A','Bb','A#','B'];
          // è‹¥åŒæ™‚å­˜åœ¨å‡é™é‡è¤‡ï¼Œå„ªå…ˆä½¿ç”¨å¸¸è¦‹é™è™Ÿåç¨±
          const preferMap={'A#':'Bb','D#':'Eb','G#':'Ab'};
          if(preferMap[val]) val = preferMap[val];
          if(!allow.includes(val)) { detectedKeyInput.style.borderColor = '#e11d48'; return; }
          detectedKeyInput.style.borderColor = 'var(--color-border)';
          const fromSel = d.getElementById('from-key');
          if(fromSel){ [...fromSel.options].forEach(o=>{ if(o.value.toUpperCase()===val.toUpperCase()) fromSel.value=o.value; }); }
        });
        detectedKeyInput.__wired = true;
      }

      // === æˆåŠŸå¾Œå¯«å…¥ç·¨è¼¯å™¨ä¸¦åˆ‡æ› ===
      const origImgBox = d.getElementById('recognition-original');
      async function handleRecognize(){
        const file = fi?.files?.[0];
        const apiKey = apiKeyInput?.value.trim();
        const statusEl = d.getElementById('gemini-status');
        const out = d.getElementById('recognize-output');
        if(!file){ statusEl.textContent='è«‹å…ˆé¸æ“‡æª”æ¡ˆ'; return; }
        if(!apiKey){ statusEl.textContent='è«‹è¼¸å…¥ API Key'; return; }
        statusEl.textContent='è¾¨è­˜ä¸­...'; out.style.display='none'; out.textContent='';
        try { 
          const text = await callGeminiAPIFromFile(file, apiKey); 
          const meta = parseMetadataFromText(text);
          let display = formatDisplay(meta.content); 
          // æ’å…¥æ¨™é¡Œèˆ‡ Key header
          const headerTitle = (meta.title||'').trim();
          const headerKey = (meta.key||'').trim();
          if(headerTitle || headerKey){
            const headerLines = [];
            if(headerTitle) headerLines.push(headerTitle);
            if(headerKey) headerLines.push('Key: ' + headerKey);
            display = headerLines.join('\n') + '\n\n' + display;
          }
          out.textContent = display || '(ç„¡å…§å®¹)'; out.style.display='block'; statusEl.textContent='å®Œæˆ';
          // å­˜å…¥å…¨åŸŸç‹€æ…‹
          g.__LAST_AI_RESULT__ = display;
          if(meta.title) { const ti = d.getElementById('song-title'); ti && (ti.value = meta.title); }
          if(meta.key) { const dk = d.getElementById('from-key'); dk && (dk.value = meta.key); const dk2=d.getElementById('detected-key'); dk2 && (dk2.value=meta.key); }
          const editor = d.getElementById('text-editor');
          if(editor){ editor.value = display; d.getElementById('go-to-transpose')?.removeAttribute('disabled'); }
          // åŸåœ–åŒæ­¥
          if(origImgBox){
            if(file.type==='application/pdf') origImgBox.innerHTML='<div style="padding:40px;text-align:center;font-size:13px;color:var(--color-text-secondary);">PDF å·²ä¸Šå‚³ï¼ˆå¯æ“´å……é è¦½ï¼‰</div>';
            else {
              const url = URL.createObjectURL(file);
              origImgBox.innerHTML = `<img src="${url}" style="max-width:100%;height:auto;display:block;">`;
            }
          }
          g.switchView && g.switchView('recognition');
        }
        catch(err){ statusEl.textContent='éŒ¯èª¤: '+err.message; }
      }

      // === ç§»èª¿åŠŸèƒ½ ===
      function transposeNote(note, diff){
        const notes=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
        const mapFlat={'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Bb':'A#'};
        const n=mapFlat[note]||note; const i=notes.indexOf(n); if(i<0) return note; return notes[(i+diff+12)%12];
      }
      function transposeChord(ch, diff){
        const m = ch.match(/^([A-G][b#]?)(.*)$/);
        if(!m) return ch;
        const root = transposeNote(m[1], diff);
        let rest = m[2]||'';
        // å…è¨± slash èˆ‡ä½éŸ³ä¹‹é–“ç©ºç™½ï¼Œä¸¦ä¿ç•™
        rest = rest.replace(/\/(\s*)([A-G][b#]?)/g, (s, sp, bass)=> '/' + sp + transposeNote(bass,diff));
        return root + rest;
      }
  function detectChordToken(tok){ return /^[A-G][#b]?[a-zA-Z0-9()\/\s]*$/.test(tok); }
      function transposeText(txt, fromKey, toKey){
        const notes=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
        const flatToSharp={'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Bb':'A#'};
        function norm(k){return flatToSharp[k]||k;}
        const diff = (notes.indexOf(norm(toKey)) - notes.indexOf(norm(fromKey)) + 12) % 12;
        return txt.split(/\n/).map(line=>{
          // ä¿ç•™ header è¡Œï¼ˆTitle/Keyï¼‰ä¸è½‰
          if(/^Key:\s*/i.test(line) || line.trim()=== '' || line.length<2) return line;
            // åˆ¤æ–·æ˜¯å¦ç‚ºå’Œå¼¦å¯†é›†è¡Œï¼ˆå«è±ç·šæˆ–å¤šå€‹å’Œå¼¦ç‰‡æ®µï¼‰
            const slashChord = /[A-G][#b]?\s*\/\s*[A-G][#b]?/.test(line);
            const chordLike = /\|/.test(line) || slashChord || (line.match(/[A-G][#b]?/g)||[]).length>2;
            if(!chordLike) return line; 
            return line.replace(/([A-G][#b]?)([a-zA-Z0-9()#\/\s]*)/g,(m,root,rest)=>{
              const token = root+rest;
              if(!detectChordToken(token)) return m;
              return transposeChord(token,diff);
            });
        }).join('\n');
      }
      const goTrans = d.getElementById('go-to-transpose');
      const backUpload = d.getElementById('back-to-upload');
      const doTrans = d.getElementById('do-transpose');
      const backEdit = d.getElementById('transpose-back');
      const finishBtn = d.getElementById('transpose-finish');
      const outArea = d.getElementById('transpose-output');
  // è¿”å›æŒ‰éˆ•ï¼šä¸Šå‚³é èˆ‡ç·¨è¼¯é åˆ†é–‹å°å‘
  backUpload && backUpload.addEventListener('click',()=> g.switchView && g.switchView('upload'));
  backEdit && backEdit.addEventListener('click',()=> g.switchView && g.switchView('recognition'));
  goTrans && goTrans.addEventListener('click',()=>{ 
        doTrans && (doTrans.disabled=false); 
        g.switchView && g.switchView('transpose'); 
        const src = d.getElementById('text-editor')?.value||''; 
        outArea.value = src; 
        finishBtn && (finishBtn.disabled=false); 
        const ti = d.getElementById('song-title')?.value; if(ti) document.title = ti + ' - ç§»èª¿'; 
      });
      doTrans && doTrans.addEventListener('click',()=>{ 
        const src = d.getElementById('text-editor')?.value||''; 
        const fk = d.getElementById('from-key').value; 
        const tk = d.getElementById('to-key').value; 
        const api = (window.__transpose__ && window.__transpose__.transposeText) || transposeText;
        let transposed = api(src,fk,tk);
        // æ›´æ–°/æ’å…¥ Key header è¡Œ
        let lines = transposed.split(/\n/);
        const keyLineIndex = lines.findIndex(l=>/^Key:\s*/i.test(l));
        const newKeyLine = 'Key: '+tk;
        if(keyLineIndex>=0) lines[keyLineIndex]=newKeyLine; else lines.splice( lines[0].trim()?1:0,0,newKeyLine );
        outArea.value = lines.join('\n');
      });

      // å‰å¾€åŒ¯å‡ºï¼šå•Ÿç”¨å¾Œå¯ç›´æ¥æ»‘åˆ°ç¬¬å››é ä¸¦åˆ·æ–°é è¦½
      finishBtn && finishBtn.addEventListener('click',()=>{
        g.switchView && g.switchView('export');
        try { typeof refreshExportPreview==='function' && refreshExportPreview(); } catch(_){ }
      });

      // æ¨™é¡Œ / èª¿æ€§è®Šæ›´å³æ™‚å¥—ç”¨åˆ°æ­£æ–‡é¦–éƒ¨ï¼ˆä¸å½±éŸ¿ç§»èª¿çµæœé™¤éé‡è·‘ï¼‰
      const songTitleInput = d.getElementById('song-title');
      function updateHeaderInEditor(){
        const editor = d.getElementById('text-editor'); if(!editor) return;
        const val = editor.value.split(/\n/);
        let idxKey = val.findIndex(l=>/^Key:\s*/i.test(l));
        let idxTitle = val.findIndex(l=>l.trim() && !/^Key:/i.test(l));
        if(idxTitle<0) idxTitle=0;
        const title = (songTitleInput?.value||'').trim();
        if(title){ if(idxTitle===0) val[0]=title; else val.unshift(title); }
        if(detectedKeyInput){ const k = detectedKeyInput.value.trim(); if(k){ if(idxKey>=0) val[idxKey]='Key: '+k; else val.splice( (title?1:0),0,'Key: '+k); } }
        editor.value = val.join('\n');
      }
      songTitleInput && songTitleInput.addEventListener('change',updateHeaderInEditor);
      detectedKeyInput && detectedKeyInput.addEventListener('change',updateHeaderInEditor);

  })(window,document);
</script>
</body>
</html>