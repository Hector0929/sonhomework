<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šåœ–æ›¸å€Ÿé–±ç³»çµ±</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            background: #f0f2f5;
            text-align: center;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            margin: 0 auto;
        }

        h1 {
            margin-bottom: 20px;
            font-size: 1.5rem;
            color: #333;
        }

        input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 80%;
            margin-bottom: 10px;
            font-size: 16px;
        }

        #reader {
            width: 100%;
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 6px;
            color: white;
            text-decoration: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }

        .btn-blue {
            background: #007bff;
        }

        .btn-green {
            background: #28a745;
        }

        .btn-orange {
            background: #fd7e14;
        }

        .btn-red {
            background: #dc3545;
        }

        #result-area {
            margin-top: 20px;
            display: none;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
        }

        .status-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-available {
            background: #d4edda;
            color: #155724;
        }

        .status-borrowed {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            color: #666;
            font-style: italic;
        }
    </style>
</head>

<body>

    <div class="card">
        <h1>ğŸ“š ç­ç´šåœ–æ›¸æƒæ</h1>

        <div>
            <label>æˆ‘çš„å­¸è™Ÿï¼š</label><br>
            <input type="text" id="student_id" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ (å¦‚ A001)">
        </div>

        <div id="reader"></div>
        <p id="camera-msg" style="font-size:12px; color:#888;">è«‹å…è¨±ä½¿ç”¨ç›¸æ©Ÿ</p>

        <div id="result-area">
            <h3 id="book-title">æ›¸åè¼‰å…¥ä¸­...</h3>
            <p>ç‹€æ…‹ï¼š<span id="book-status" class="status-tag">æŸ¥è©¢ä¸­</span></p>
            <p id="status-msg" style="font-size:14px; color:#555;"></p>

            <div id="actions">
            </div>
        </div>
    </div>

    <script>
        // â˜…â˜…â˜… è¨­å®šå€ï¼šè«‹æŠŠé€™è£¡æ›æˆæ‚¨ Render çš„ç¶²å€ (çµå°¾ä¸è¦æœ‰æ–œç·š) â˜…â˜…â˜…
        const API_BASE_URL = "https://class-library.onrender.com";

        // --- ç¨‹å¼é‚è¼¯ ---
        const studentInput = document.getElementById('student_id');
        const resultArea = document.getElementById('result-area');
        const actionsDiv = document.getElementById('actions');
        let currentBookId = null;

        // 1. è‡ªå‹•è®€å–/å„²å­˜å­¸è™Ÿ
        if (localStorage.getItem('student_id')) {
            studentInput.value = localStorage.getItem('student_id');
        }
        studentInput.addEventListener('change', () => {
            localStorage.setItem('student_id', studentInput.value);
        });

        // 2. æƒææˆåŠŸå¾Œçš„å‹•ä½œ
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`æƒæåˆ°: ${decodedText}`);

            if (!studentInput.value) {
                alert("è«‹å…ˆè¼¸å…¥å­¸è™Ÿï¼");
                return;
            }

            // æš«åœæƒæï¼Œé¿å…é‡è¤‡è§¸ç™¼
            html5QrcodeScanner.clear();
            document.getElementById('camera-msg').innerText = "æƒææˆåŠŸï¼è™•ç†ä¸­...";

            // å‘¼å«å¾Œç«¯æŸ¥è©¢æ›¸ç±
            fetchBookInfo(decodedText);
        }

        // 3. æŸ¥è©¢æ›¸ç± API
        async function fetchBookInfo(bookId) {
            resultArea.style.display = 'block';
            actionsDiv.innerHTML = '<p class="loading">æ­£åœ¨æŸ¥è©¢æ›¸ç±ç‹€æ…‹...</p>';

            try {
                const response = await fetch(`${API_BASE_URL}/scan/${bookId}`);
                if (!response.ok) throw new Error("æ‰¾ä¸åˆ°æ›¸ç±æˆ–é€£ç·šéŒ¯èª¤");

                const data = await response.json();
                currentBookId = data.book_id;

                // æ›´æ–°ç•«é¢
                document.getElementById('book-title').innerText = data.title;
                const statusEl = document.getElementById('book-status');
                const msgEl = document.getElementById('status-msg');

                statusEl.innerText = data.status;
                msgEl.innerText = data.message;

                statusEl.className = 'status-tag ' + (data.status === 'Available' ? 'status-available' : 'status-borrowed');

                // ç”¢ç”ŸæŒ‰éˆ•
                renderButtons(data.status);

            } catch (error) {
                alert("éŒ¯èª¤ï¼š" + error.message);
                location.reload(); // é‡æ–°æ•´ç†è®“æƒæå™¨å›ä¾†
            }
        }

        // 4. æ ¹æ“šç‹€æ…‹é¡¯ç¤ºæŒ‰éˆ•
        function renderButtons(status) {
            let html = '';

            if (status === 'Available') {
                html += `<button class="btn btn-green" onclick="doAction('borrow')">æˆ‘è¦å€Ÿæ›¸</button>`;
            } else if (status === 'Borrowed' || status === 'Reserved') {
                // å¦‚æœæ˜¯è¢«å€Ÿèµ°ï¼Œå¯èƒ½è¦é‚„æ›¸ï¼Œä¹Ÿå¯èƒ½è¦æ’éšŠ
                html += `<button class="btn btn-orange" onclick="doAction('return')">æˆ‘è¦é‚„æ›¸</button>`;
                html += `<div style="height:10px"></div>`; // é–“éš”
                html += `<button class="btn btn-blue" onclick="doAction('queue')">æˆ‘è¦æ’éšŠ</button>`;
            }

            html += `<div style="height:10px"></div>`;
            html += `<button class="btn btn-red" onclick="location.reload()">é‡æ–°æƒæ</button>`;

            actionsDiv.innerHTML = html;
        }

        // 5. åŸ·è¡Œ å€Ÿ/é‚„/æ’éšŠ å‹•ä½œ
        async function doAction(actionType) {
            const studentId = studentInput.value;
            actionsDiv.innerHTML = '<p class="loading">æ­£åœ¨è™•ç†è«‹æ±‚...</p>';

            try {
                const response = await fetch(`${API_BASE_URL}/${actionType}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ book_id: currentBookId, student_id: studentId })
                });

                const result = await response.json();

                if (result.success) {
                    alert("æˆåŠŸï¼š" + result.message);
                    location.reload(); // æˆåŠŸå¾Œé‡æ•´é é¢
                } else {
                    alert("å¤±æ•—ï¼š" + result.message);
                    // å¤±æ•—å¯èƒ½è¦é‡æ–°é¡¯ç¤ºæŒ‰éˆ•ï¼Œé€™è£¡ç°¡å–®è™•ç†ç›´æ¥é‡æ•´
                    location.reload();
                }
            } catch (error) {
                alert("é€£ç·šå¤±æ•—ï¼š" + error.message);
                location.reload();
            }
        }

        // åˆå§‹åŒ–æƒæå™¨
        let html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", { fps: 10, qrbox: 250 });
        html5QrcodeScanner.render(onScanSuccess);

    </script>

</body>

</html>