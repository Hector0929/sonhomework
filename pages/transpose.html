<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>移調｜Chord Pages</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Arial, sans-serif; background:#f8fafc; }
    .upload-card { max-width:980px; margin:18px auto; padding:20px; border:2px dashed #e2e8f0; border-radius:14px; background:#fff; }
    .preview-stage { margin-top: 8px; border: 2px dashed #e2e8f0; border-radius: 12px; background: #fff; padding: 12px; min-height: 260px; overflow: auto; }
    .overlay-stage { position: relative; display: inline-block; transform-origin: top left; }
    .overlay-stage > img { display: block; max-width: 100%; height: auto; }
    .tag { position: absolute; box-sizing: border-box; border-radius: 4px; padding: 0 4px; line-height: 1; display: flex; align-items: center; justify-content: center; font-family: monospace; }
    .tag.chord { background: rgba(0,0,0,.88); color: #ffd700; font-weight: 700; }
    .tag.lyric { background: rgba(255,255,255,.75); color: #111; border: 1px solid #e5e7eb; }
    .row { display:flex; gap:8px; align-items:center; margin-top:8px; }
    select { padding:6px 8px; }
    .btn { padding:8px 12px; border-radius:8px; border:1px solid #e5e7eb; background:#f8fafc; cursor:pointer; }
    .btn.primary { background:#2563eb; color:#fff; border:none; }
  </style>
  <script src="../assets/chords_shared.js"></script>
</head>
<body>
  <div class="upload-card">
    <h2 style="margin:0;">移調</h2>
    <div class="row">
      <label>原調
        <select id="original-key">
          <option>C</option><option>C#</option><option>D</option><option>D#</option><option>E</option><option>F</option>
          <option>F#</option><option>G</option><option>G#</option><option>A</option><option>A#</option><option>B</option>
        </select>
      </label>
      <label>→ 目標
        <select id="target-key">
          <option>C</option><option>C#</option><option>D</option><option>D#</option><option>E</option><option>F</option>
          <option>F#</option><option>G</option><option>G#</option><option>A</option><option>A#</option><option>B</option>
        </select>
      </label>
      <button id="apply" class="btn">套用移調</button>
      <button id="to-export" class="btn primary">下一步：匯出</button>
    </div>
    <div id="transposed-result" class="preview-stage"></div>
  </div>
  <script>
    const state = App.loadAppState();
    if(!state?.rawURL){ location.replace('scan.html'); }

    const origSel = document.getElementById('original-key');
    const targSel = document.getElementById('target-key');
    const container = document.getElementById('transposed-result');

    // 預設鍵值（若 AppState 有保存便還原）
    if(state.originalKey) origSel.value = state.originalKey;
    if(state.targetKey)   targSel.value = state.targetKey;

    // 初次渲染
    Chords.renderStage(container, state.preURL || state.rawURL, state.tokens || []);

    document.getElementById('apply').addEventListener('click', ()=>{
      const off = Chords.currentOffset(origSel.value, targSel.value);
      Chords.applyTransposeInPlace(container, off);
      App.saveAppState({ originalKey: origSel.value, targetKey: targSel.value });
    });

    document.getElementById('to-export').addEventListener('click', ()=>{
      // 儲存選調，下一頁可再次套用（或直接沿用渲染結果）
      App.saveAppState({ originalKey: origSel.value, targetKey: targSel.value });
      location.href = 'export.html';
    });
  </script>
</body>
</html>