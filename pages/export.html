<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>匯出預覽｜Chord Pages</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Arial, sans-serif; background:#f8fafc; }
    .upload-card { max-width:980px; margin:18px auto; padding:20px; border:2px dashed #e2e8f0; border-radius:14px; background:#fff; }
    .preview-stage { margin-top: 8px; border: 2px dashed #e2e8f0; border-radius: 12px; background: #fff; padding: 12px; min-height: 260px; overflow: auto; }
    .overlay-stage { position: relative; display: inline-block; transform-origin: top left; }
    .overlay-stage > img { display: block; max-width: 100%; height: auto; }
    .tag { position: absolute; box-sizing: border-box; border-radius: 4px; padding: 0 4px; line-height: 1; display: flex; align-items: center; justify-content: center; font-family: monospace; }
    .tag.chord { background: rgba(0,0,0,.88); color: #ffd700; font-weight: 700; }
    .tag.lyric { background: rgba(255,255,255,.75); color: #111; border: 1px solid #e5e7eb; }
    .row { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .btn { padding:8px 12px; border-radius:8px; border:1px solid #e5e7eb; background:#f8fafc; cursor:pointer; }
  </style>
  <script src="../assets/chords_shared.js"></script>
</head>
<body>
  <div class="upload-card">
    <h2 style="margin:0;">匯出預覽</h2>
    <div class="row">
      <button id="back-transpose" class="btn" onclick="location.href='transpose.html'">返回移調</button>
      <!-- 可擴充：下載 PNG/PDF -->
    </div>
    <div id="final-preview" class="preview-stage"></div>
  </div>
  <script>
    const state = App.loadAppState();
    if(!state?.rawURL){ location.replace('scan.html'); }

    const container = document.getElementById('final-preview');
    // 先渲染，再套移調（若上一頁已套過，這裡再次套用也會以 dataset.original 為基準）
    Chords.renderStage(container, state.preURL || state.rawURL, state.tokens || []);
    const off = Chords.currentOffset(state.originalKey || 'C', state.targetKey || 'C');
    if(off) Chords.applyTransposeInPlace(container, off);
  </script>
</body>
</html>