<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>圖取｜Chord Pages</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Arial, sans-serif; background:#f8fafc; }
    .upload-hero { text-align:center; padding:40px 0 16px; }
    .upload-hero h1 { font-size:28px; font-weight:800; margin:0; color:#0f172a; }
    .upload-hero p { margin-top:8px; color:#475569; }

    .upload-card {
      max-width:720px; margin:18px auto; padding:28px 22px; text-align:center;
      border:2px dashed #e2e8f0; border-radius:14px; background:#fff; cursor:pointer; transition: all .2s ease;
    }
    .upload-card:hover, .upload-card.dragover { background:#f8fafc; border-color:#cbd5e1; }
    .upload-card .icon { width:60px; height:60px; margin:0 auto 14px; border-radius:9999px; background:#fff7ed; display:flex; align-items:center; justify-content:center; border:1px solid #fed7aa; }
    .upload-card h3 { margin:0; font-weight:700; color:#111827; }
    .upload-card .hint { margin-top:6px; color:#64748b; font-size:13px; }

    .preview-pane { max-width:820px; margin:18px auto 0; padding:14px; border:1px solid #e5e7eb; border-radius:12px; background:#fafafa; }
    .preview-grid { display:flex; gap:16px; align-items:flex-start; }
    .preview-img { max-height:320px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; }
    .file-meta { font-size:14px; color:#334155; }
    .file-meta .muted { color:#64748b; }
    .actions { text-align:center; margin:18px 0 24px; }
    .btn-primary { padding:10px 14px; border-radius:8px; background:#2563eb; color:#fff; border:none; cursor:pointer; }
    .btn-primary[disabled] { opacity:.5; cursor:not-allowed; }
    .hidden{ display:none; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
    }
  </script>
  <script src="../assets/chords_shared.js"></script>
</head>
<body>
  <div class="upload-hero">
    <h1>圖取（上傳/預覽）</h1>
    <p>拖拉檔案到下方或點擊選擇。支援 JPG/PNG/PDF。</p>
  </div>

  <div id="drop-area" class="upload-card" tabindex="0" aria-label="Upload area">
    <div class="icon" aria-hidden="true">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
        <path d="M12 16V4m0 0l-4 4m4-4l4 4" stroke="#ea580c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M20 16v2a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-2" stroke="#ea580c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <h3>Drop files here or click to upload</h3>
    <div class="hint">Supported formats: JPG, PNG, PDF</div>
    <input id="file-input" type="file" accept=".jpg,.jpeg,.png,.pdf" style="display:none;" />
  </div>

  <div id="preview-pane" class="preview-pane hidden">
    <div class="preview-grid">
      <img id="preview-image" alt="預覽" class="preview-img" />
      <div class="file-meta">
        <div><strong>檔案名稱：</strong><span id="file-name">—</span></div>
        <div class="muted" style="margin-top:6px;"><strong>大小：</strong><span id="file-size">—</span></div>
        <div class="muted" style="margin-top:6px;"><strong>格式：</strong><span id="file-type">—</span></div>
        <div id="preview-status" class="muted" style="margin-top:6px;"></div>
      </div>
    </div>
  </div>

  <div class="actions">
    <button id="go-recognize" class="btn-primary" disabled>下一步：辨識結果</button>
  </div>

  <script>
    const dropAreaEl  = document.getElementById('drop-area');
    const fileInputEl = document.getElementById('file-input');
    const previewPane = document.getElementById('preview-pane');
    const previewImg  = document.getElementById('preview-image');
    const fileNameEl  = document.getElementById('file-name');
    const fileSizeEl  = document.getElementById('file-size');
    const fileTypeEl  = document.getElementById('file-type');
    const statusEl    = document.getElementById('preview-status');
    const nextBtn     = document.getElementById('go-recognize');

    function humanBytes(v){ const kb=(Number(v)||0)/1024; return kb<1024?`${kb.toFixed(1)} KB`:`${(kb/1024).toFixed(2)} MB`; }
    function setStatus(msg, kind='info'){ statusEl.textContent=msg||''; statusEl.style.color=(kind==='error')?'#b91c1c':'#64748b'; }

    dropAreaEl.addEventListener('click', ()=> fileInputEl.click());
    dropAreaEl.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); fileInputEl.click(); } });
    dropAreaEl.addEventListener('dragover', e=>{ e.preventDefault(); dropAreaEl.classList.add('dragover'); });
    dropAreaEl.addEventListener('dragleave', ()=> dropAreaEl.classList.remove('dragover'));
    dropAreaEl.addEventListener('drop', async e=>{ e.preventDefault(); dropAreaEl.classList.remove('dragover'); const f=e.dataTransfer?.files?.[0]; if(f) await handleFile(f); });
    fileInputEl.addEventListener('change', async e=>{ const f=e.target.files?.[0]; if(f) await handleFile(f); });

    async function fileToDataURL(file){
      if (file.type==='application/pdf' || /\.pdf$/i.test(file.name||'')){
        if(!window.pdfjsLib) throw new Error('pdfjsLib not loaded');
        const buffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 2.0 });
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;
        return canvas.toDataURL('image/png');
      } else {
        const reader = new FileReader();
        const p = new Promise((res,rej)=>{ reader.onerror=rej; reader.onload=()=>res(reader.result); });
        reader.readAsDataURL(file);
        return p;
      }
    }

    async function handleFile(file){
      nextBtn.disabled = true; setStatus('');
      fileNameEl.textContent = file.name || '(未命名)';
      fileSizeEl.textContent = humanBytes(file.size || 0);
      fileTypeEl.textContent = (file.type || 'unknown').toUpperCase();

      try{
        setStatus('載入中…');
        const dataURL = await fileToDataURL(file);
        previewImg.src = dataURL;
        previewPane.classList.remove('hidden');
        setStatus('預覽載入完成。');
        App.saveAppState({ rawURL: dataURL, preURL: dataURL, tokens: App.loadAppState().tokens||[] });
        nextBtn.disabled = false;
      }catch(e){
        console.error(e); setStatus('載入失敗，請確認檔案或網路。','error');
      }
    }

    nextBtn.addEventListener('click', ()=> location.href = 'recognize.html');
  </script>
</body>
</html>