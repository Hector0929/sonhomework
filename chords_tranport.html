<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ç°¡è­œå’Œå¼¦è½‰æ›</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif; 
      background-color: #f9f9f9;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .hidden { display: none; }
    
    /* æ¨™é¡Œæ¨£å¼ */
    .app-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .app-title {
      font-size: 36px;
      font-weight: bold;
      color: #0891b2;
      margin-bottom: 20px;
    }
    
    /* åˆ†é æŒ‰éˆ•æ¨£å¼ */
    .tabs {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 25px;
    }
    .tab-btn {
      min-width: 120px;
      padding: 12px 20px;
      border: 2px solid #22c3ee;
      border-radius: 25px;
      background: white;
      color: #22c3ee;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
    }
    .tab-btn:hover {
      background: #f0f9ff;
    }
    .tab-btn[aria-selected="true"] {
      background: #e0f2fe;
      box-shadow: 0 0 0 3px rgba(34,195,238,0.2) inset;
    }
    
    /* å·¥ä½œå€åŸŸæ¨£å¼ */
    .workspace-frame {
      border: 4px solid #22c3ee;
      border-radius: 48px;
      padding: 30px;
      background: white;
      min-height: 400px;
      max-width: 1100px;
      margin: 0 auto;
      position: relative;
    }
    
    /* åŸæœ‰çš„ç–Šåœ–æ¨£å¼ */
    .overlay-stage { position: relative; display: inline-block; }
    .overlay-stage > img { display: block; max-width: 100%; height: auto; }
    .tag { position: absolute; box-sizing: border-box; border-radius: 4px; padding: 0 4px; line-height: 1; display: flex; align-items: center; justify-content: center; font-family: monospace; }
    .tag.chord { background: rgba(0,0,0,.88); color: #ffd700; font-weight: 700; }
    .tag.lyric { background: rgba(255,255,255,.75); color: #111; border: 1px solid #e5e7eb; }
    
    /* æŒ‰éˆ•æ¨£å¼ */
    #to-export-btn, #to-transpose-btn, #transpose-btn, #recognize-btn {
      position: relative;
      z-index: 10;
      cursor: pointer;
      padding: 8px 16px;
      background: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 10px;
    }
    
    /* ç¢ºä¿ç–Šåœ–ä¸­çš„æ¨™ç±¤ä¸æœƒæ””æˆªé»æ“Šäº‹ä»¶ */
    .overlay-stage .tag {
      pointer-events: none;
    }
    .overlay-stage:hover .tag {
      pointer-events: auto;
    }
    
    /* ä¸Šå‚³å€åŸŸèˆ‡æª”æ¡ˆé è¦½æ¨£å¼ */
    .upload-area {
      border: 2px dashed #22c3ee;
      border-radius: 10px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .upload-area:hover {
      background-color: #f0f9ff;
      border-color: #0891b2;
    }
    .upload-area .upload-icon {
      margin: 0 auto 15px;
    }

    /* å·¥ä½œå€æç¤ºæ–‡å­— */
    .workspace-hint {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #0891b2;
      font-size: 18px;
    }

    /* æª”æ¡ˆé è¦½æ¨£å¼ */
    .file-preview-area {
      margin: 20px 0;
      border-radius: 10px;
      overflow: hidden;
      background: #f8f8f8;
    }
    .file-info {
      padding: 10px 15px;
      background: #e0f2fe;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .file-name {
      font-weight: bold;
      color: #0891b2;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .file-size {
      color: #555;
      font-size: 0.9em;
    }
    .preview-container {
      padding: 15px;
      text-align: center;
      overflow: hidden; /* ç¢ºä¿æº¢å‡ºçš„å…§å®¹è¢«éš±è— */
      min-height: 600px; /* æä¾›è¶³å¤ çš„ç©ºé–“çµ¦æ”¾å¤§å¾Œçš„åœ–ç‰‡ */
    }
    .preview-container img {
      max-width: 100%;  /* ä¿æŒå¯¬åº¦é©æ‡‰å®¹å™¨ */
      max-height: 600px; /* å¾åŸæœ¬çš„ 300px æ”¾å¤§åˆ° 600px */
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: scale(2); /* åŠ å…¥ç¸®æ”¾æ•ˆæœ */
      transform-origin: center top; /* å¾ä¸­å¤®é ‚éƒ¨é–‹å§‹ç¸®æ”¾ */
      margin: 80px 0; /* å¢åŠ ä¸Šä¸‹é‚Šè·ä»¥å®¹ç´æ”¾å¤§çš„å…§å®¹ */
    }

    /* æŒ‰éˆ•æ¨£å¼çµ±ä¸€ */
    #recognize-btn, #to-transpose-btn, #transpose-btn, #to-export-btn {
      background-color: #22c3ee;
      color: white;
      border: none;
      border-radius: 25px;
      padding: 10px 20px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 15px;
    }
    #recognize-btn:hover, #to-transpose-btn:hover, #transpose-btn:hover, #to-export-btn:hover {
      background-color: #0891b2;
    }
    #recognize-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    /* è¾¨è­˜ç·¨è¼¯åˆ†é æ¨£å¼ */
    .recognition-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 20px;
    }
    .recognition-compare-area {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }
    .original-image-container,
    .recognition-result-container {
      flex: 1;
      min-width: 0;
    }
    .recognition-result-area {
      flex: 3;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .edit-panel {
      width: 100%;
      background: #f8f8f8;
      border-radius: 10px;
      padding: 15px;
    }
    #text-editor {
      width: 100%;
      min-height: 600px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
    }
    .original-image-container,
    .recognition-result-container {
      flex: 1;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
      min-height: 400px;
      display: flex;
      flex-direction: column;
    }
    .original-image-container h3,
    .recognition-result-container h3 {
      margin-top: 0;
      color: #0891b2;
      font-size: 18px;
      margin-bottom: 10px;
    }
    #recognition-status {
      font-size: 14px;
      color: #888;
      font-weight: normal;
    }
    .recognition-controls {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .overlay-container {
      flex: 1;
      position: relative;
      border: 1px dashed #ccc;
      background-color: #fcfcfc;
      overflow: auto;
    }
    .edit-tools {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }
    .edit-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: #e0f2fe;
      color: #0891b2;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
    }
    .edit-btn:hover {
      background-color: #bae6fd;
    }
    .edit-options {
      margin-top: 15px;
      padding: 12px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .edit-option {
      margin-bottom: 12px;
    }
    .edit-option label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-size: 14px;
    }
    .edit-option select, 
    .edit-option input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .edit-actions {
      display: flex;
      gap: 10px;
    }
    .edit-action-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 4px;
      background-color: #22c3ee;
      color: white;
      cursor: pointer;
    }
    .edit-action-btn.danger {
      background-color: #ff6b6b;
    }
    .edit-action-btn:hover {
      opacity: 0.9;
    }
    .edit-help {
      background: #f0f9ff;
      border-radius: 8px;
      padding: 12px;
      margin-top: 20px;
    }
    .edit-help h4 {
      margin-top: 0;
      color: #0891b2;
      font-size: 16px;
      margin-bottom: 8px;
    }
    .edit-help ul {
      margin: 0;
      padding-left: 20px;
      color: #555;
    }
    .edit-help li {
      margin-bottom: 6px;
      font-size: 14px;
    }
    .action-btn {
      padding: 10px 20px;
      border-radius: 25px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    .action-btn.primary {
      background-color: #22c3ee;
      color: white;
    }
    .action-btn.secondary {
      background-color: #e0f2fe;
      color: #0891b2;
      border: 1px solid #bae6fd;
    }
    .action-btn:hover {
      opacity: 0.9;
    }
    /* å’Œå¼¦èˆ‡æ­Œè©çš„å¯ç·¨è¼¯æ¨£å¼ */
    .tag.editable {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .tag.editable:hover {
      box-shadow: 0 0 0 2px rgba(34, 195, 238, 0.5);
    }
    .tag.editable.selected {
      box-shadow: 0 0 0 3px #22c3ee;
    }
    .tag.chord.editable {
      border: 1px dashed #ffd700;
    }
    .tag.lyric.editable {
      border: 1px dashed #22c3ee;
    }
    /* æ–°å¢é …ç›®çš„æç¤ºæ¨£å¼ */
    .add-item-hint {
      position: absolute;
      background-color: rgba(34, 195, 238, 0.1);
      border: 2px dashed #22c3ee;
      padding: 15px;
      border-radius: 8px;
      color: #0891b2;
      font-size: 14px;
      text-align: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .overlay-container.edit-mode:hover .add-item-hint {
      opacity: 1;
    }

    /* è¾¨è­˜ç·¨è¼¯é é¢ä¸¦æ’é¡¯ç¤ºæ¨£å¼ */
    .recognition-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 20px;
    }

    /* åŸå§‹åœ–èˆ‡è¾¨è­˜çµæœä¸¦æ’ */
    .recognition-compare-area {
      display: flex;
      gap: 20px;
      width: 100%;
    }

    .original-image-container,
    .recognition-result-container {
      flex: 1;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
      min-height: 400px;
      display: flex;
      flex-direction: column;
    }

    .original-image-container h3,
    .recognition-result-container h3 {
      margin-top: 0;
      color: #0891b2;
      font-size: 18px;
      margin-bottom: 10px;
    }

    /* åœ–ç‰‡å®¹å™¨æ¨£å¼ */
    .image-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .image-container img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    /* è¾¨è­˜çµæœå®¹å™¨ */
    .overlay-container {
      flex: 1;
      position: relative;
      border: 1px dashed #ccc;
      background-color: #fcfcfc;
      overflow: auto;
    }

    /* ç·¨è¼¯é¢æ¿ç½®æ–¼ä¸‹æ–¹ */
    .edit-panel {
      width: 100%;
      background: #f8f8f8;
      border-radius: 10px;
      padding: 15px;
    }

    /* å·¥å…·åˆ—æ’æˆæ°´å¹³ */
    .edit-tools {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* å¯ç·¨è¼¯æ¨™ç±¤æ¨£å¼ */
    .tag.editable {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tag.editable:hover {
      box-shadow: 0 0 0 2px rgba(34, 195, 238, 0.5);
    }

    .tag.editable.selected {
      box-shadow: 0 0 0 3px #22c3ee;
    }
    .tag.chord.editable {
      border: 1px dashed #ffd700;
    }
    .tag.lyric.editable {
      border: 1px dashed #22c3ee;
    }
    /* æ–‡å­—æ¨¡å¼åˆ‡æ›åˆ— */
    .result-mode-switch { display:flex; gap:8px; align-items:center; margin:6px 0 10px; }
    .mode-btn {
      padding:6px 10px; border:1px solid #bae6fd; border-radius:9999px;
      background:#e0f2fe; color:#0891b2; font-weight:700; cursor:pointer;
    }
    .mode-btn.active { background:#22c3ee; color:#fff; border-color:#22c3ee; }

    /* ç´”æ–‡å­—ç·¨è¼¯å™¨ */
    #text-editor-wrap { margin-top:8px; }
    #text-editor {
      width:100%;
      /* è¨­å®šåŸºæœ¬é«˜åº¦ï¼Œå¯¦éš›é«˜åº¦ç”± JS ä¾å…§å®¹è‡ªå‹•èª¿æ•´ */
      min-height:360px;
      height:auto;
      resize:vertical; /* ä»å…è¨±æ‰‹å‹•æ‹‰é«˜ */
      white-space:pre;
      line-height:1.6;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      border:1px solid #e5e7eb;
      border-radius:8px;
      padding:10px;
      background:#fff;
      overflow-y:auto;
    }

    /* æ–‡å­—å·¥å…·åˆ— */
    .text-tools { display:flex; gap:8px; justify-content:flex-end; margin:6px 0; }
    .tool-btn { padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:12px; }
    .tool-btn:hover { background:#f3f4f6; }
    .tool-btn.primary { background:#22c3ee; color:#fff; border-color:#22c3ee; }

    /* Gemini API Key å¡ç‰‡ */
    .apikey-card { border:1px solid #e5e7eb; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    #gemini-api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* æ–°å¢çš„æ¨£å¼å€åŸŸ */
    /* å®‰å…¨é ç·¨è­¯ï¼šå–®ä¸€ä¾†æºï¼Œé¿å…å­—ä¸²æ‹¼æ¥éºå¤±è·³è„« */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }
  </style>
</head>
<body>
  <!-- é é¢æ¨™é¡Œèˆ‡åˆ†é å°èˆª -->
  <header class="app-header">
    <h1 class="app-title">ç°¡è­œå’Œå¼¦è½‰æ›</h1>
    <nav class="tabs" role="tablist">
      <button class="tab-btn" role="tab" id="tab-upload" data-view="upload" aria-selected="true">è®€å–</button>
      <button class="tab-btn" role="tab" id="tab-recognition" data-view="recognition" aria-selected="false">è¾¨è­˜ç·¨è¼¯</button>
      <button class="tab-btn" role="tab" id="tab-transpose" data-view="transpose" aria-selected="false">ç§»èª¿</button>
      <button class="tab-btn" role="tab" id="tab-export" data-view="export" aria-selected="false">åŒ¯å‡º</button>
    </nav>
  </header>

  <!-- å·¥ä½œå€æ¡†æ¶ -->
  <main class="workspace-frame">
    <!-- è®€å–åˆ†é  -->
    <section id="upload-section">
      <!-- ä¸Šå‚³å€åŸŸ -->
      <div class="upload-area" id="drop-area">
        <input id="file-input" type="file" accept=".jpg,.jpeg,.png,.pdf" style="display: none;" />
        <div class="upload-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 16.5V6.5M12 6.5L7.5 11M12 6.5L16.5 11" stroke="#22c3ee" stroke-width="2" stroke-linecap="round"/>
            <path d="M3 15v4a2 2 0 002 2h14a2 2 0 002-2v-4" stroke="#22c3ee" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <p>æ‹–æ›±æª”æ¡ˆåˆ°é€™è£¡æˆ–é»æ“Šä¸Šå‚³</p>
        <p><small>æ”¯æ´æ ¼å¼ï¼šJPG, PNG, PDF</small></p>
      </div>
      
      <!-- æª”æ¡ˆè³‡è¨Šèˆ‡é è¦½å€åŸŸ (åˆå§‹éš±è—) -->
      <div class="file-preview-area hidden" id="file-preview-area">
        <div class="file-info">
          <span class="file-name" id="file-name">æœªé¸æ“‡æª”æ¡ˆ</span>
          <span class="file-size" id="file-size"></span>
        </div>
        <div class="preview-container" id="file-preview-container">
          <!-- é è¦½åœ–å°‡ç”± JS æ’å…¥ -->
        </div>
      </div>
      
      <!-- Gemini AI è¾¨è­˜å€åŸŸ -->
      <div class="apikey-card" id="gemini-card">
        <h3>AI è¾¨è­˜ï¼ˆGoogle Geminiï¼‰</h3>
        <div class="apikey-row">
          <input id="gemini-api-key" type="password" placeholder="è¼¸å…¥ä½ çš„ Gemini API keyï¼ˆåƒ…å­˜æ–¼æœ¬æ©Ÿï¼‰" />
          <button id="save-gemini-key" class="key-btn">å„²å­˜é‡‘é‘°</button>
          <button id="clear-gemini-key" class="key-btn">æ¸…é™¤</button>
        </div>
        <div class="apikey-row">
          <label><input type="checkbox" id="use-gemini-ai" /> å•Ÿç”¨ AI è¾¨è­˜</label>
          <button id="recognize-ai-btn" type="button" class="primary" disabled>ä½¿ç”¨ AI è¾¨è­˜</button>
          <span id="gemini-status"></span>
        </div>
      </div>
    </section>

    <!-- è¾¨è­˜ç·¨è¼¯åˆ†é  -->
    <section id="recognition-section" class="hidden">
      <div class="recognition-container">
        <!-- å·¦å³å°ç…§å€åŸŸ -->
        <div class="recognition-compare-area">
          <div class="original-image-container">
            <h3>åŸå§‹åœ–ç‰‡</h3>
            <div id="original-image" class="image-container"></div>
          </div>
          <div class="recognition-result-container">
            <h3>è¾¨è­˜çµæœ <span id="recognition-status">(å¾…é–‹å§‹)</span></h3>
            <div id="text-editor-wrap">
              <div class="text-tools">
                <button id="copy-text" class="tool-btn">è¤‡è£½</button>
                <button id="clear-text" class="tool-btn">æ¸…ç©º</button>
                <button id="apply-text" class="tool-btn primary">å¥—ç”¨åˆ°åŒ¯å‡º</button>
                <button id="show-log" class="tool-btn">é¡¯ç¤º Log</button>
              </div>
              <textarea id="text-editor" placeholder="è¾¨è­˜å®Œæˆå¾Œæœƒè‡ªå‹•è½‰æ›ç‚ºæ–‡å­—ï¼Œæ‚¨å¯ç›´æ¥ç·¨è¼¯â€¦"></textarea>
              <!-- Gemini API Log é¡¯ç¤ºå€åŸŸ -->
              <div id="gemini-log" class="hidden" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px; max-height: 200px; overflow-y: auto;">
                <h4 style="margin: 0 0 10px 0; color: #666;">Gemini API å›å‚³ Logï¼š</h4>
                <pre id="gemini-log-content" style="margin: 0; font-size: 12px; color: #333; white-space: pre-wrap;"></pre>
              </div>
            </div>
          </div>
        </div>
        <!-- åº•éƒ¨ï¼šç·¨è¼¯å·¥å…·é¢æ¿ -->
        <div class="edit-panel"></div>
      </div>
      <div class="recognition-controls">
        <button id="recognize-again" class="action-btn secondary">é‡æ–°è¾¨è­˜</button>
        <button id="to-transpose-btn" class="action-btn primary">ä¸‹ä¸€æ­¥ï¼šç§»èª¿</button>
      </div>
    </section>

    <!-- ç§»èª¿åˆ†é  -->
    <section id="transpose-section" class="hidden">
      <div>
        <label>åŸèª¿
          <select id="original-key">
            <option>C</option><option>C#</option><option>D</option><option>D#</option><option>E</option><option>F</option>
            <option>F#</option><option>G</option><option>G#</option><option>A</option><option>A#</option><option>B</option>
          </select>
        </label>
        <label>â†’ ç›®æ¨™
          <select id="target-key">
            <option>C</option><option>C#</option><option>D</option><option>D#</option><option>E</option><option>F</option>
            <option>F#</option><option>G</option><option>G#</option><option>A</option><option>A#</option><option>B</option>
          </select>
        </label>
        <button id="transpose-btn">å¥—ç”¨ç§»èª¿</button>
      </div>
      <div id="transposed-result" style="margin-top:15px;"></div>
      <button id="to-export-btn" style="margin-top:15px;">ä¸‹ä¸€æ­¥ï¼šåŒ¯å‡º</button>
    </section>

    <!-- åŒ¯å‡ºåˆ†é  -->
    <section id="export-section" class="hidden">
      <div id="final-preview"></div>
    </section>
    

    
  </main>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <script src="https://docs.opencv.org/4.8.0/opencv.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/music-chord-parser@0.1.2/dist/music-chord-parser.min.js"></script>
  <!-- æ–°å¢æ¨¡çµ„è…³æœ¬ï¼ˆä¸Šå‚³ / ç§»èª¿ / åŒ¯å‡ºï¼‰ -->
  <script src="public/js/upload-module.js"></script>
  <script src="public/js/transpose-module.js"></script>
  <script src="public/js/export-module.js"></script>
  <!-- AI ç›´æ¥è¾¨è­˜æ¨¡çµ„ï¼ˆå–ä»£ OCR å¼·åŒ–è™•ç†ï¼‰ -->
  <script src="public/js/ai-direct-recognition.js"></script>
  <script type="module">
    import {
      buildPrompt,
      processGeminiText,
      formatGeminiResponse
    } from './public/js/ai-utils.js';

    // å°‡æ¨¡çµ„å‡½å¼æ›åˆ°å…¨åŸŸï¼Œä¾›ä¸‹æ–¹éæ¨¡çµ„è…³æœ¬ä½¿ç”¨
    window.formatGeminiResponse = formatGeminiResponse;
    //ï¼ˆå¯é¸ï¼‰å¦å¤–å°å‡ºä¾›é™¤éŒ¯ï¼Œä¸è¦†è“‹æ—¢æœ‰å…¨åŸŸåŒåå‡½å¼
    window.__AIUtils__ = { buildPrompt, processGeminiText, formatGeminiResponse };

    // ========================================================================
    // å…¨åŸŸç‹€æ…‹ç®¡ç†
    // ========================================================================
    window.AppState = {
        preURL: null,
        tokens: [],
        currentTranspose: 0
    };

    // ========================================================================
    // DOM å…ƒç´ åƒè€ƒ
    // ========================================================================
    const elements = {
        fileInput: document.getElementById('file-input'),
        startBtn: document.getElementById('start-recognition-btn'),
        aiBtn: document.getElementById('recognize-ai-btn'),
        apiKeyInput: document.getElementById('gemini-api-key'),
        useAiCheckbox: document.getElementById('use-gemini-ai'),
        recognitionStatus: document.getElementById('recognition-status'),
        geminiStatus: document.getElementById('gemini-status'),
        originalImage: document.getElementById('original-image'),
        recognitionResult: document.getElementById('recognition-result'),
        textEditor: document.getElementById('text-editor'),
    };

    // ========================================================================
    // äº‹ä»¶ç›£è½èˆ‡ UI æ›´æ–°
    // ========================================================================

    // æª”æ¡ˆé¸æ“‡è™•ç†
    elements.fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                window.AppState.preURL = e.target.result;
                elements.originalImage.innerHTML = `<img src="${e.target.result}" alt="åŸå§‹åœ–ç‰‡" style="max-width: 100%; height: auto;">`;
                updateAIButtonState();
            };
            reader.readAsDataURL(file);
        } else {
            window.AppState.preURL = null;
            elements.originalImage.innerHTML = '';
            updateAIButtonState();
        }
    });

    // æ›´æ–° AI æŒ‰éˆ•ç‹€æ…‹çš„é‚è¼¯
    function updateAIButtonState() {
        const hasFile = !!window.AppState.preURL;
        const hasKey = elements.apiKeyInput.value.trim().length > 0;
        const useAI = elements.useAiCheckbox.checked;
        elements.aiBtn.disabled = !(hasFile && hasKey && useAI);
    }

    elements.apiKeyInput.addEventListener('input', updateAIButtonState);
    elements.useAiCheckbox.addEventListener('change', updateAIButtonState);
    // ç§»é™¤æ­¤æ®µå…§å»º AI æŒ‰éˆ•ç¶å®šï¼ˆæ”¹ç”±ä¸‹æ–¹å–®ä¸€è™•ç†é‚è¼¯ç¶å®šï¼Œé¿å…é‡è¤‡èˆ‡æœªå®šç¾©è®Šæ•¸ï¼‰
    // ...existing code...
  </script>
  <script>
// é˜²é‡å…¥
(function (g, d) {
  if (g.__GeminiUIBootLoaded) return; g.__GeminiUIBootLoaded = true;

  // 1) å¿½ç•¥ Pouch 404 éŒ¯èª¤ï¼Œé¿å…ä¸­æ–·
  function isPouchErr(e) {
    const n = (e && e.name) || '';
    const m = (e && (e.message || e.reason || '')) + '';
    const s = (e && e.status) || 0;
    return /pouch/i.test(n + m) || n === 'not_found' || s === 404;
  }
  g.addEventListener('error', ev => { const e = ev.error || ev.message || {}; if (isPouchErr(e)) { ev.preventDefault?.(); console.warn('[ignore] Pouch error', e); } });
  g.addEventListener('unhandledrejection', ev => { const r = ev.reason || {}; if (isPouchErr(r)) { ev.preventDefault?.(); console.warn('[ignore] Pouch rejection', r); } });

  // 2) å…ƒä»¶
  const $ = id => d.getElementById(id);
  const keyInput = $('gemini-api-key');
  const useCk    = $('use-gemini-ai');
  const aiBtn    = $('recognize-ai-btn');
  const recBtn   = $('recognize-btn');
  const fileIn   = $('file-input');
  const statusAI = $('gemini-status');
  const statusR  = $('recognition-status') || $('upload-status');
  const imgBox   = $('original-image') || $('recognition-result');
  const textArea = $('text-editor');

  // è‡ªå‹•é«˜åº¦èª¿æ•´ï¼šæ ¹æ“šå…§å®¹è®ŠåŒ–è‡ªé©æ‡‰é«˜åº¦ï¼Œä¿ç•™æœ€å°é«˜åº¦é–€æª»
  function autoResizeTextEditor() {
    if (!textArea) return;
    const min = 360; // èˆ‡ CSS min-height å°é½Š
    textArea.style.height = 'auto';
    const next = Math.max(min, textArea.scrollHeight + 2);
    textArea.style.height = next + 'px';
  }
  // å°å‡ºåˆ°å…¨åŸŸï¼Œä¾›å…¶ä»–è…³æœ¬å­˜å–
  g.autoResizeTextEditor = autoResizeTextEditor;

  // 3) å•Ÿç”¨é‚è¼¯
  function syncRecognizeBtn() {
    if (!fileIn || !recBtn) return;
    recBtn.disabled = !(fileIn.files && fileIn.files.length > 0);
  }
  function syncAIBtn() {
    if (!aiBtn) return;
    const hasKey = !!(keyInput && keyInput.value.trim());
    const enabled = (!!useCk ? useCk.checked : true) && hasKey;
    aiBtn.disabled = !enabled;
  }

  // è¼¸å…¥æ™‚å³æ™‚èª¿æ•´é«˜åº¦
  if (textArea && !textArea.__autoresize) {
    textArea.addEventListener('input', autoResizeTextEditor);
    textArea.__autoresize = true;
    // åˆå§‹åŒ–èª¿æ•´ä¸€æ¬¡ï¼Œé¿å…ç©ºå…§å®¹ä½†é«˜åº¦å¤ªå°
    d.addEventListener('DOMContentLoaded', autoResizeTextEditor, { once: true });
    // è‹¥é é¢å·²è¼‰å…¥å®Œæˆå‰‡ç›´æ¥èª¿æ•´
    if (d.readyState !== 'loading') autoResizeTextEditor();
  }

  // 4) å–å¾—ç›®å‰å½±åƒ URLï¼ˆæª”æ¡ˆ/å·²æœ‰é è¦½/AppStateï¼‰
  function currentImageURL() {
    if (fileIn && fileIn.files && fileIn.files[0]) {
      try { return URL.createObjectURL(fileIn.files[0]); } catch (_) {}
    }
    if (g.AppState && g.AppState.preURL) return g.AppState.preURL;
    const img = imgBox && imgBox.querySelector && imgBox.querySelector('img');
    if (img && img.src) return img.src;
    return '';
  }

  // 5) å¾Œå‚™é¡¯ç¤ºï¼ˆç•¶æ²’æœ‰ performRecognitionï¼‰
  function fallbackPreview(url) {
    if (!imgBox || !url) return;
    imgBox.innerHTML = '';
    const img = new Image();
    img.src = url;
    img.style.maxWidth = '100%';
    img.style.height = 'auto';
    imgBox.appendChild(img);
  }

  // 6) é»æ“Šè™•ç†ï¼šé–‹å§‹è¾¨è­˜ï¼ˆæ²¿ç”¨æ—¢æœ‰ recBtnï¼‰
  async function onRecognizeClick() {
    try {
      const url = currentImageURL();
      if (!url) { statusR && (statusR.textContent = 'å°šæœªé¸æ“‡æª”æ¡ˆ'); return; }
      g.AppState = g.AppState || {}; g.AppState.preURL = url;
      if (typeof g.performRecognition === 'function') {
        statusR && (statusR.textContent = 'é–‹å§‹è¾¨è­˜ä¸­...');
        await g.performRecognition(url);
        statusR && (statusR.textContent = 'è¾¨è­˜å®Œæˆ');
        d.dispatchEvent(new CustomEvent('app:recognition-finished'));
      } else {
        fallbackPreview(url);
        statusR && (statusR.textContent = '(å¾Œå‚™) è¾¨è­˜å®Œæˆ');
        d.dispatchEvent(new CustomEvent('app:recognition-finished'));
      }
    } catch (e) {
      console.error('[recognize]', e);
      statusR && (statusR.textContent = 'è¾¨è­˜éŒ¯èª¤ï¼š' + (e.message || e));
    }
  }

  // 7) é»æ“Šè™•ç†ï¼šAI è¾¨è­˜ï¼ˆGeminiï¼‰
  async function onAIClick() {
    try {
      const key = keyInput ? keyInput.value.trim() : '';
      if (!key) { statusAI && (statusAI.textContent = 'è«‹è¼¸å…¥ API key'); return; }
      const url = currentImageURL();
      if (!url) { statusAI && (statusAI.textContent = 'è«‹å…ˆé¸æ“‡æˆ–è¼‰å…¥å½±åƒ'); return; }

      statusAI && (statusAI.textContent = 'AI è¾¨è­˜åŸ·è¡Œä¸­...');
      statusR && (statusR.textContent = 'é–‹å§‹ AI è¾¨è­˜...');
      g.AppState = g.AppState || {}; g.AppState.preURL = url;

      // é¡¯ç¤ºåŸåœ–
      fallbackPreview(url);

      try {
        // å‘¼å«çœŸæ­£çš„ Gemini API
        const result = await callGeminiAPI(key, url);
        
        // è¨˜éŒ„ API å›å‚³çµæœ
        if (typeof g.setGeminiLog === 'function') {
          g.setGeminiLog({
            timestamp: new Date().toISOString(),
            request: {
              apiKey: key.substring(0, 10) + '...',
              imageUrl: url.substring(0, 50) + '...',
              model: 'gemini-2.5-flash'
            },
            response: result
          });
        }

        // è§£æ API å›æ‡‰ä¸¦è½‰æ›ç‚º tokens
        const tokens = parseGeminiResponse(result);
        g.AppState.tokens = tokens;

        // æ›´æ–°æ–‡å­—ç·¨è¼¯å™¨
        if (typeof g.updateTextEditor === 'function') {
          g.updateTextEditor(tokens);
          autoResizeTextEditor();
        } else {
          autoResizeTextEditor();
        }

        statusR && (statusR.textContent = `AI è¾¨è­˜å®Œæˆï¼Œæ‰¾åˆ° ${tokens.length} å€‹é …ç›®`);
        statusAI && (statusAI.textContent = 'AI è¾¨è­˜å®Œæˆ');
        
      } catch (apiError) {
        console.error('[Gemini API]', apiError);
        
        // è¨˜éŒ„éŒ¯èª¤
        if (typeof g.setGeminiLog === 'function') {
          g.setGeminiLog({
            timestamp: new Date().toISOString(),
            request: {
              apiKey: key.substring(0, 10) + '...',
              imageUrl: url.substring(0, 50) + '...',
              model: 'gemini-1.5-flash'
            },
            error: {
              message: apiError.message,
              stack: apiError.stack
            }
          });
        }

        // API å¤±æ•—æ™‚ä½¿ç”¨å¾Œå‚™æ–¹æ¡ˆ
        statusAI && (statusAI.textContent = 'API å‘¼å«å¤±æ•—ï¼Œä½¿ç”¨å¾Œå‚™è¾¨è­˜');
        g.AppState.tokens = [
          { kind: 'chord', x: 20, y: 20, w: 40, h: 20, text: 'C' },
          { kind: 'chord', x: 80, y: 20, w: 40, h: 20, text: 'F' },
          { kind: 'chord', x: 140, y: 20, w: 40, h: 20, text: 'G' },
          { kind: 'lyric', x: 20, y: 50, w: 160, h: 20, text: 'å¾Œå‚™è¾¨è­˜çµæœ' },
        ];
        
        if (typeof g.updateTextEditor === 'function') {
          g.updateTextEditor(g.AppState.tokens);
          autoResizeTextEditor();
        } else {
          autoResizeTextEditor();
        }
        statusR && (statusR.textContent = '(å¾Œå‚™) è¾¨è­˜å®Œæˆ');
      }

      d.dispatchEvent(new CustomEvent('app:recognition-finished'));
    } catch (e) {
      console.error('[gemini]', e);
      statusAI && (statusAI.textContent = 'AI è¾¨è­˜éŒ¯èª¤ï¼š' + (e.message || e));
    }
  }

  // Gemini API å‘¼å«å‡½å¼
  async function callGeminiAPI(apiKey, imageUrl) {
    // å°‡ data URL è½‰æ›ç‚º base64
    const base64Data = imageUrl.split(',')[1];
    
    const payload = {
      contents: [{
        parts: [{
          text: g.buildPrompt()
        }, {
          inline_data: {
            mime_type: "image/png",
            data: base64Data
          }
        }]
      }]
    };

    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(`Gemini API éŒ¯èª¤: ${response.status} - ${errorData.error?.message || response.statusText}`);
    }

    const data = await response.json();
    return data;
  }

  // è§£æ Gemini å›æ‡‰
  function parseGeminiResponse(response) {
    try {
      const text = response.candidates?.[0]?.content?.parts?.[0]?.text || '';
      console.log('[Gemini Response Text]', text);
      
      // å˜—è©¦å¾å›æ‡‰ä¸­æå–å’Œå¼¦å’Œæ­Œè©
      const lines = text.split('\n').filter(line => line.trim());
      const tokens = [];
      let yPos = 20;
      
      lines.forEach((line, index) => {
        const trimmedLine = line.trim();
        if (!trimmedLine) return;
        
        // æ›´å…¨é¢çš„å’Œå¼¦è¾¨è­˜æ¨¡å¼ï¼ŒåŒ…æ‹¬ä¸­æ–‡æ¨‚è­œå¸¸è¦‹çš„æ ¼å¼
        const chordPatterns = [
          // åŸºæœ¬å’Œå¼¦æ¨¡å¼ï¼šA, Am, A7, Amaj7, A#, Bb/D ç­‰
          /\|([A-G][#b]?(?:maj|min|m|sus|dim|aug|add|[0-9]+)*(?:\/[A-G][#b]?)?)[\s]*\|/g,
          // ç°¡å–®å’Œå¼¦æ¨¡å¼ï¼ˆç„¡ç¸±ç·šï¼‰
          /\b([A-G][#b]?(?:maj|min|m|sus|dim|aug|add|[0-9]+)*(?:\/[A-G][#b]?)?)\b/g
        ];
        
        let isChordLine = false;
        let chords = [];
        
        // å˜—è©¦ç”¨ä¸åŒçš„æ¨¡å¼åŒ¹é…å’Œå¼¦
        for (const pattern of chordPatterns) {
          const matches = trimmedLine.match(pattern);
          if (matches && matches.length > 0) {
            chords = matches.map(match => match.replace(/[\|\s]/g, '').trim()).filter(c => c);
            if (chords.length > 0) {
              isChordLine = true;
              break;
            }
          }
        }
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºå’Œå¼¦è¡Œï¼ˆåŒ…å«ç¸±ç·šæˆ–å¤šå€‹å¤§å¯«å­—æ¯ï¼‰
        if (!isChordLine) {
          isChordLine = /\|.*\|/.test(trimmedLine) || 
                       (trimmedLine.match(/[A-G]/g) || []).length >= 2;
        }
        
        if (isChordLine && chords.length > 0) {
          // é€™è¡ŒåŒ…å«å’Œå¼¦
          let xPos = 20;
          chords.forEach(chord => {
            if (chord && chord.length > 0) {
              tokens.push({
                kind: 'chord',
                x: xPos,
                y: yPos,
                w: Math.max(30, chord.length * 12),
                h: 20,
                text: chord
              });
              xPos += Math.max(40, chord.length * 15);
            }
          });
        } else if (trimmedLine.length > 0) {
          // é€™è¡Œæ˜¯æ­Œè©æˆ–å…¶ä»–æ–‡å­—
          tokens.push({
            kind: 'lyric',
            x: 20,
            y: yPos,
            w: Math.max(100, trimmedLine.length * 10),
            h: 20,
            text: trimmedLine
          });
        }
        yPos += 35;
      });
      
      return tokens.length > 0 ? tokens : [
        { kind: 'lyric', x: 20, y: 20, w: 200, h: 20, text: 'ç„¡æ³•è§£æ Gemini å›æ‡‰\n\nåŸå§‹å›æ‡‰ï¼š' + text.substring(0, 100) + '...' }
      ];
      
    } catch (e) {
      console.error('[Parse Gemini Response]', e);
      return [
        { kind: 'lyric', x: 20, y: 20, w: 200, h: 20, text: 'è§£æå›æ‡‰æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + e.message }
      ];
    }
  }

  // 8) ç¶å®šäº‹ä»¶
  function wire() {
    if (fileIn)  fileIn.addEventListener('change', () => { syncRecognizeBtn(); /* é¸æª”å¾Œé å­˜ URL */ g.AppState = g.AppState || {}; g.AppState.preURL = currentImageURL(); });
    if (recBtn && !recBtn.__wired) { recBtn.addEventListener('click', onRecognizeClick); recBtn.__wired = true; }
    if (keyInput) keyInput.addEventListener('input', syncAIBtn);
    if (useCk)    useCk.addEventListener('change', syncAIBtn);
    if (aiBtn && !aiBtn.__wired) { aiBtn.addEventListener('click', onAIClick); aiBtn.__wired = true; }

    // åˆ†é åˆ‡æ›ï¼šå®šç¾©ä¸¦å°å‡º switchView
    if (typeof g.switchView !== 'function') {
      g.switchView = function(view){
        const views = {
          upload: 'upload-section',
          recognition: 'recognition-section',
          transpose: 'transpose-section',
          export: 'export-section'
        };
        const tabs = {
          upload: d.getElementById('tab-upload'),
          recognition: d.getElementById('tab-recognition'),
          transpose: d.getElementById('tab-transpose'),
          export: d.getElementById('tab-export')
        };
        // åˆ‡æ›å€å¡Šé¡¯ç¤º
        Object.values(views).forEach(id => { const el = d.getElementById(id); el && el.classList.add('hidden'); });
        const targetId = views[view];
        const target = targetId ? d.getElementById(targetId) : null;
        if (target) target.classList.remove('hidden');
        // åˆ‡æ› tab æ¨£å¼
        Object.values(tabs).forEach(tb => { if (tb) tb.setAttribute('aria-selected', 'false'); });
        const activeTab = tabs[view];
        if (activeTab) activeTab.setAttribute('aria-selected', 'true');
        return view;
      };
    }

    // Tab é»æ“Šå°è¦½
    const tabBtns = d.querySelectorAll('.tab-btn[data-view]');
    tabBtns.forEach(btn => {
      if (!btn.__wired) {
        btn.addEventListener('click', () => { const v = btn.getAttribute('data-view'); if (v) g.switchView(v); });
        btn.__wired = true;
      }
    });

    // ä¸‹ä¸€æ­¥æŒ‰éˆ•ï¼šè¾¨è­˜ â†’ ç§»èª¿ã€ç§»èª¿ â†’ åŒ¯å‡º
    const toTranspose = d.getElementById('to-transpose-btn');
    if (toTranspose && !toTranspose.__wired) { toTranspose.addEventListener('click', () => g.switchView('transpose')); toTranspose.__wired = true; }
    const toExport = d.getElementById('to-export-btn');
    if (toExport && !toExport.__wired) { toExport.addEventListener('click', () => g.switchView('export')); toExport.__wired = true; }

    // è¾¨è­˜å®Œæˆå¾Œï¼Œè‡ªå‹•åˆ‡åˆ°ã€Œè¾¨è­˜ç·¨è¼¯ã€åˆ†é ï¼Œç¢ºä¿å¯è¦‹ï¼Œä¸¦æ›´æ–°æ–‡å­—ç·¨è¼¯å™¨
    d.addEventListener('app:recognition-finished', () => { 
      g.switchView('recognition'); 
      // ç¢ºä¿æ–‡å­—ç·¨è¼¯å™¨é¡¯ç¤ºæœ€æ–°çš„è¾¨è­˜çµæœ
      if (typeof g.updateTextEditor === 'function' && g.AppState?.tokens) {
        g.updateTextEditor(g.AppState.tokens);
      }
      autoResizeTextEditor();
    });

    syncRecognizeBtn(); syncAIBtn();
  }
  if (d.readyState === 'loading') d.addEventListener('DOMContentLoaded', wire, { once: true }); else wire();

  // 9) buildPrompt å‡½å¼ï¼ˆç‚º Gemini API æä¾›è©³ç´°æç¤ºï¼‰
  if (typeof g.buildPrompt !== 'function') {
    g.buildPrompt = function () {
      return `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„éŸ³æ¨‚è­œè¾¨è­˜å°ˆå®¶ã€‚è«‹ä»”ç´°è¾¨è­˜é€™å¼µä¸­æ–‡æ­Œè­œåœ–ç‰‡ä¸­çš„æ‰€æœ‰å…§å®¹ã€‚

**è¾¨è­˜è¦å‰‡ï¼š**
1. è¾¨è­˜æ‰€æœ‰çš„å’Œå¼¦ç¬¦è™Ÿï¼ˆé€šå¸¸åœ¨æ­Œè©ä¸Šæ–¹ï¼Œå¦‚ï¼šF, C, Dm7, Bb2, G#ç­‰ï¼‰
2. è¾¨è­˜æ‰€æœ‰çš„ä¸­æ–‡æ­Œè©
3. è«‹æŒ‰ç…§å¾ä¸Šåˆ°ä¸‹ã€å¾å·¦åˆ°å³çš„é †åºè®€å–

**è¼¸å‡ºæ ¼å¼ï¼š**
ç›´æ¥è¼¸å‡ºæ¯ä¸€è¡Œçš„å…§å®¹ï¼Œå’Œå¼¦å’Œæ­Œè©å„è‡ªä¸€è¡Œã€‚

**ç¯„ä¾‹ï¼š**
|F  |C  |Dm7 /C |Bb2 |
åœ¨ä½ çš„é™¢å®‡ä¸­æ­Œå”±
|F  |C  |Dm7    |Bb  |
è®šç¾ä½ çš„è–å

**é‡è¦ï¼š**
- å¦‚æœçœ‹åˆ°ç±»ä¼¼ |F2 |  |æˆ– |Csus| çš„æ ¼å¼ï¼Œè«‹å®Œæ•´ä¿ç•™è±ç·š|
- ä¸è¦å¿½ç•¥ä»»ä½•æ­Œè©æˆ–å’Œå¼¦
- ä¿æŒåŸæœ‰çš„è¡Œçš„çµæ§‹å’Œæ ¼å¼
- ç›´æ¥è¼¸å‡ºï¼Œä¸è¦åŠ ä»»ä½•è§£é‡‹æˆ–èªªæ˜`;
    };
  }
})(window, document);
</script>
<!-- OCR æ”¹å–„è…³æœ¬å·²ç§»é™¤ï¼Œç¾åœ¨ä¸»è¦ä½¿ç”¨ Gemini API é€²è¡Œè¾¨è­˜ -->
<script src="public/js/recognition-skip-ocr-when-tokens.js"></script>
<script>
(function (g, d) {
  if (g.__GeminiAPIFixLoaded) return;
  g.__GeminiAPIFixLoaded = true;

  const log = (...a) => console.log('[GeminiFix]', ...a);
  const warn = (...a) => console.warn('[GeminiFix]', ...a);
  const err = (...a) => console.error('[GeminiFix]', ...a);

  // å°‡ä»»æ„ä¾†æºè½‰æˆ { mimeType, base64 }
  async function resolveImageToBase64(src) {
    try {
      // 1) data:URL
      if (typeof src === 'string' && src.startsWith('data:')) {
        const m = src.match(/^data:([^;]+);base64,(.*)$/);
        if (!m || !m[2]) throw new Error('data:URL å…§å®¹ç‚ºç©º');
        return { mimeType: m[1] || 'image/png', base64: m[2] };
      }

      // 2) blob: URL æˆ– http(s) URL
      if (typeof src === 'string' && (src.startsWith('blob:') || /^https?:/.test(src))) {
        const resp = await fetch(src);
        if (!resp.ok) throw new Error(`fetch å¤±æ•—: ${resp.status}`);
        const blob = await resp.blob();
        return blobToResolvedImage(blob);
      }

      // 3) Blob/File
      if (src instanceof Blob) {
        const { mimeType, base64 } = await blobToResolvedImage(src);
        return { mimeType, base64 };
      }

      // 4) å¾Œå‚™ï¼šè‹¥æ²’æä¾›æˆ–æ ¼å¼ä¸ç¬¦ï¼Œå˜—è©¦ä½¿ç”¨ AppState.preURL
      if (g.AppState?.preURL) {
        return await resolveImageToBase64(g.AppState.preURL);
      }

      throw new Error('ä¸æ”¯æ´çš„å½±åƒä¾†æºï¼Œä¸”æ‰¾ä¸åˆ° AppState.preURL');
    } catch (e) {
      err('resolveImageToBase64 å¤±æ•—', e);
      throw e;
    }
  }

  function blobToResolvedImage(blob) {
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onerror = () => reject(new Error('FileReader è®€å–å¤±æ•—'));
      fr.onloadend = () => {
        const result = fr.result;
        if (typeof result !== 'string') return reject(new Error('FileReader çµæœç„¡æ•ˆ'));
        const m = result.match(/^data:([^;]+);base64,(.*)$/);
        if (!m || !m[2]) return reject(new Error('ç„¡æ³•è‡ª data:URL æå– base64'));
        resolve({ mimeType: m[1] || (blob.type || 'image/png'), base64: m[2] });
      };
      fr.readAsDataURL(blob);
    });
  }

  async function callGeminiAPIFixed(imageUrlOrBlob, apiKey, prompt) {
    const startedAt = Date.now();
    try {
      // çµ±ä¸€å¾ä¾†æºå–å¾— base64 èˆ‡æ­£ç¢ºçš„ mime
      const source = g.AppState?.preURL || imageUrlOrBlob;
      const { mimeType, base64 } = await resolveImageToBase64(source);
      if (!base64) throw new Error('inlineData base64 ç‚ºç©º');

      const body = {
        contents: [{
          parts: [
            { text: prompt || (typeof g.buildPrompt === 'function' ? g.buildPrompt() : 'è«‹èƒå–å’Œå¼¦èˆ‡æ­Œè©') },
            { inlineData: {
                mimeType,
                data: base64
              }
            }
          ]
        }],
        generationConfig: { temperature: 0.1, topK: 32, topP: 1, maxOutputTokens: 4096 }
      };

      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
      const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });

      if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error(`Gemini API éŒ¯èª¤: ${res.status} - ${text || 'æœªçŸ¥éŒ¯èª¤'}`);
      }

      const json = await res.json();
      log('API æˆåŠŸï¼Œç”¨æ™‚(ms):', Date.now() - startedAt);
      // å–ç¬¬ä¸€æ®µæ–‡å­—
      const text = json?.candidates?.[0]?.content?.parts?.map(p => p.text).filter(Boolean).join('\n');
      if (!text) warn('å›å‚³æ²’æœ‰æ–‡å­—éƒ¨åˆ†ï¼ŒåŸæ¨£å›å‚³ JSON');
      return text || JSON.stringify(json);
    } catch (e) {
      const errorLog = {
        timestamp: new Date().toISOString(),
        request: {
          apiKey: apiKey ? String(apiKey).slice(0, 8) + '...' : 'æœªæä¾›',
          imageUrl: typeof imageUrlOrBlob === 'string' ? imageUrlOrBlob : (g.AppState?.preURL ? '[AppState.preURL]' : '[Blob]'),
          model: 'gemini-1.5-flash'
        },
        error: { message: e.message, stack: e.stack }
      };
      err('Gemini API å›å‚³ Logï¼š\n' + JSON.stringify(errorLog, null, 2));
      throw e;
    }
  }

 

  // è¦†å¯«å…¨åŸŸå‘¼å«
  const prev = g.callGeminiAPI;
  g.callGeminiAPI = callGeminiAPIFixed;
  log('ä¿®æ­£è¼‰å…¥å®Œæˆï¼ŒåŸå‡½å¼å‹åˆ¥:', typeof prev);
})(window, document);
</script>
<script>
  // ç¢ºä¿æ‰€æœ‰ç¨‹å¼ç¢¼åœ¨ä¸€å€‹ç«‹å³åŸ·è¡Œçš„å‡½å¼ (IIFE) ä¸­ï¼Œé¿å…æ±™æŸ“å…¨åŸŸç¯„åœ
  (function (g, d) {
    // é˜²æ­¢è…³æœ¬é‡è¤‡è¼‰å…¥
    if (g.__CHORD_TRANSPOSE_APP_LOADED__) return;
    g.__CHORD_TRANSPOSE_APP_LOADED__ = true;

    console.log('[App] è…³æœ¬å•Ÿå‹•');

    // å…¨åŸŸç‹€æ…‹
    g.AppState = g.AppState || {
      rawURL: null, // åŸå§‹æª”æ¡ˆçš„ URL
      preURL: null, // é è™•ç†å¾Œçš„åœ–ç‰‡ URL (æ­¤è™•ç­‰æ–¼ rawURL)
      tokens: [],   // è¾¨è­˜å‡ºçš„ token
      geminiLog: null // Gemini API çš„æ—¥èªŒ
    };

    // DOM å…ƒç´ å¿«å–
    const $ = id => d.getElementById(id);
    const elements = {
      fileInput: $('file-input'),
      apiKeyInput: $('gemini-api-key'),
      useAiCheckbox: $('use-gemini-ai'),
      aiBtn: $('recognize-ai-btn'),
      recBtn: $('recognize-btn'),
      geminiStatus: $('gemini-status'),
      recognitionStatus: $('recognition-status'),
      originalImage: $('original-image'),
      recognitionResult: $('recognition-result'),
      textEditor: $('text-editor'),
      showLogBtn: $('show-log'),
      geminiLogDiv: $('gemini-log'),
      geminiLogContent: $('gemini-log-content')
    };

    /**
     * æ›´æ–° AI è¾¨è­˜æŒ‰éˆ•çš„ç‹€æ…‹
     */
    function syncAIBtn() {
      if (!elements.aiBtn) return;
      const hasKey = !!(elements.apiKeyInput && elements.apiKeyInput.value.trim());
      const useAI = !!(elements.useAiCheckbox && elements.useAiCheckbox.checked);
      const hasFile = !!(elements.fileInput && elements.fileInput.files.length > 0);
      elements.aiBtn.disabled = !(useAI && hasKey && hasFile);
    }

    /**
     * å–å¾—ç›®å‰è¦è¾¨è­˜çš„åœ–ç‰‡ URL
     */
    function getCurrentImageURL() {
      if (g.AppState.preURL) return g.AppState.preURL;
      if (elements.fileInput && elements.fileInput.files[0]) {
        try {
          const url = URL.createObjectURL(elements.fileInput.files[0]);
          g.AppState.preURL = url; // å¿«å– URL
          return url;
        } catch (e) {
          console.error('ç„¡æ³•å»ºç«‹ Object URL', e);
          return null;
        }
      }
      return null;
    }

    /**
     * å°‡ Blob æˆ– data:URL è½‰æ›ç‚º Base64 å­—ä¸²
     */
    function blobToResolvedImage(blob) {
      return new Promise((resolve, reject) => {
        if (!blob || blob.size === 0) {
          return reject(new Error('Blob ç‰©ä»¶ç‚ºç©º'));
        }
        const reader = new FileReader();
        reader.onerror = () => reject(new Error('FileReader è®€å–æ™‚ç™¼ç”ŸéŒ¯èª¤'));
        reader.onloadend = () => {
          const result = reader.result;
          if (typeof result !== 'string') {
            return reject(new Error('FileReader è®€å–çµæœç„¡æ•ˆ'));
          }
          const match = result.match(/^data:([^;]+);base64,(.*)$/);
          if (!match || !match[2]) {
            return reject(new Error('ç„¡æ³•å¾ data:URL è§£æ base64 è³‡æ–™'));
          }
          resolve({ mimeType: match[1] || blob.type, base64: match[2] });
        };
        reader.readAsDataURL(blob);
      });
    }

    /**
     * è§£æå„ç¨®å½±åƒä¾†æºï¼Œæœ€çµ‚å›å‚³ { mimeType, base64 }
     */
    async function resolveImageSource(src) {
      if (typeof src !== 'string' || !src) {
        throw new Error('ç„¡æ•ˆçš„å½±åƒä¾†æº');
      }
      if (src.startsWith('data:')) {
        const match = src.match(/^data:([^;]+);base64,(.*)$/);
        if (!match || !match[2]) throw new Error('ç„¡æ•ˆçš„ data:URL æ ¼å¼');
        return { mimeType: match[1], base64: match[2] };
      }
      if (src.startsWith('blob:') || src.startsWith('http')) {
        const response = await fetch(src);
        if (!response.ok) throw new Error(`ç„¡æ³•æ“·å–è³‡æº: ${response.status}`);
        const blob = await response.blob();
        return blobToResolvedImage(blob);
      }
      throw new Error('ä¸æ”¯æ´çš„å½±åƒä¾†æºæ ¼å¼');
    }

    /**
     * å»ºç«‹å‚³é€çµ¦ Gemini API çš„æç¤º
     */
    function buildPrompt() {
      return `è«‹ä½ æ‰®æ¼”ä¸€ä½ç²¾æº–çš„æ¨‚è­œæ–‡å­—è¾¨è­˜å°ˆå®¶ã€‚ä½ çš„ä»»å‹™æ˜¯å°‡æˆ‘ä¸Šå‚³çš„æ¨‚è­œåœ–ç‰‡ï¼Œè½‰æ›ç‚ºæ’ç‰ˆç²¾ç¢ºã€æ˜“äºè¤‡è£½çš„ç´”æ–‡å­—æ ¼å¼ã€‚

è«‹åš´æ ¼éµå®ˆä»¥ä¸‹æ’ç‰ˆè¦å‰‡ï¼š

å®Œæ•´æ¨™é¡Œè³‡è¨Šï¼šæ“·å–ä¸¦æ”¾åœ¨æœ€ä¸Šæ–¹ï¼ŒåŒ…å«æ­Œæ›²åç¨±ã€èª¿æ€§ (Key) å’Œé€Ÿåº¦ (BPM)ã€‚

ä¾ç…§æ‰€æä¾›çš„è­œï¼Œä¿ç•™æ­Œæ›²çµæ§‹ï¼šæ¸…æ¥šæ¨™ç¤ºå‡ºæ‰€æœ‰æœ¬ä¾†è­œä¸­æ‰€æœ‰æ®µè½æ¨™é¡Œï¼Œä¾‹å¦‚ï¼šIntro (å‰å¥)ã€Verse (ä¸»æ­Œ)ã€Pre-Chorus (å°æ­Œ)ã€Chorus (å‰¯æ­Œ)ã€Bridge (æ©‹æ®µ)ã€Outro (å°¾å¥) ç­‰ã€‚

å’Œå¼¦åœ¨ä¸Šï¼Œæ­Œè©åœ¨ä¸‹ï¼šå’Œå¼¦å¿…é ˆåœ¨æ­Œè©çš„æ­£ä¸Šæ–¹ï¼Œä¸¦ä¸”åˆ†æˆå…©è¡Œç¨ç«‹å‘ˆç¾ã€‚

ç²¾æº–å°ä½ï¼šå°‡æ¯å€‹æ­Œè©ï¼ˆæˆ–å–®å­—ï¼‰ç²¾ç¢ºåœ°å°é½Šåœ¨ä¸Šæ–¹çš„å’Œå¼¦ï¼Œä½¿ç”¨ç©ºæ ¼ä¾†èª¿æ•´æ­Œè©ä½ç½®ï¼Œé€™æ˜¯æœ€é‡è¦çš„è¦æ±‚ã€‚

ä¿ç•™æ‰€æœ‰éŸ³æ¨‚ç¬¦è™Ÿï¼šå®Œæ•´ä¿ç•™åœ–ç‰‡ä¸­çš„æ‰€æœ‰éŸ³æ¨‚ç¬¦è™Ÿï¼Œç‰¹åˆ¥æ˜¯ï¼š

å°ç¯€ç·šï¼š|

å’Œå¼¦è®ŠåŒ–ï¼šä¾‹å¦‚ Dm7, Csus4, G/B ç­‰è¤‡é›œå’Œå¼¦ï¼Œå¯ä»¥å¯«æˆDm, Csus4, G/Bå°±å¥½ï¼Œä¸è¦åŠ ä¸Š<sup>ï¼Œä¾‹å¦‚D<sup>m7</sup>ã€‚æ¯ä¸€æ ¼å’Œå¼¦éƒ½è¦ç”¨è±ç·š | åŒ…èµ·ä¾†ã€‚æ¯å€‹å’Œå¼¦ä¹‹é–“è‡³å°‘ä¿ç•™ä¸€å€‹ç©ºæ ¼ã€‚æ¯å°ç¯€çš„é•·åº¦ç‚º8å€‹ç©ºæ ¼ã€‚é‡åˆ°å°ç¯€é–“æ²’æœ‰å¡«å¯«ä»»ä½•å’Œå¼¦çš„æƒ…æ³ï¼Œè«‹ç”¨ |    | ä¾†è¡¨ç¤ºã€‚  

é‡è¤‡è¨˜è™Ÿï¼šå¦‚æœæœ‰ ğ„† ğ„‡ï¼Œè¨˜å¾—å–ä»£å°ç¯€ç·š

æ­Œè©çš„è¦æ±‚ï¼šä¿ç•™æ‰€æœ‰æ¨™é»ç¬¦è™Ÿå’Œç©ºæ ¼ï¼Œç¢ºä¿æ­Œè©çš„å®Œæ•´æ€§ï¼Œä½†ä¸éœ€è¦å°ç¯€ç·šï¼Œé€™å¾ˆé‡è¦ã€‚

ä½¿ç”¨ç­‰å¯¬å­—é«”æ ¼å¼ï¼šè«‹å°‡æœ€çµ‚çµæœæ”¾å…¥ä¸€å€‹ç¨‹å¼ç¢¼å€å¡Š (Code Block) ä¸­ï¼Œä»¥ç¢ºä¿å°é½Šä¸æœƒå› å­—é«”è€Œè·‘æ‰ã€‚

æ ¼å¼ç¯„ä¾‹å¦‚ä¸‹ï¼š

[æ­Œæ›²åç¨±]

[æ®µè½æ¨™é¡Œ]
|[å’Œå¼¦]  |[å’Œå¼¦]      |[å’Œå¼¦]
 [æ­Œè©]    [æ­Œè©]      [æ­Œè©]


æ­£ç¢ºç¯„ä¾‹ï¼ˆç¤ºæ„ï¼Œæ³¨æ„å°é½Šèˆ‡ç©ºå°ç¯€ï¼‰ï¼š
"chords": "|F2      |Csus       |Dm7  /C     |Bb2      |"
"lyrics": " å¥” å‘ ç¥¢ çš„ æ®¿ ä¸­ è®“ è®š ç¾   æ¹§ æµ åœ¨ æˆ‘ å¿ƒ é ­"
`;
    }

    /**
     * å‘¼å« Gemini API
     */
    async function callGeminiAPI(imageUrl, apiKey, prompt) {
      console.log('[API] æº–å‚™è§£æå½±åƒä¾†æº...');
      const { mimeType, base64 } = await resolveImageSource(imageUrl);
      console.log('[API] mimeType=', mimeType, 'base64Len=', base64.length);
      if (base64.length < 50) throw new Error('å½±åƒ base64 é•·åº¦ç•°å¸¸ï¼Œå¯èƒ½è®€å–å¤±æ•—');

      const body = {
        contents: [{
          parts: [
            { text: prompt },
            { inlineData: { mimeType, data: base64 } }
          ]
        }],
        generationConfig: { temperature: 0.1, maxOutputTokens: 4096 }
      };
      console.log('[API] è«‹æ±‚å…§å®¹ (æˆªæ–·):', JSON.stringify(body).slice(0, 180) + '...');

      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      if (!resp.ok) {
        const txt=await resp.text().catch(()=> '');
        throw new Error(`Gemini API éŒ¯èª¤ ${resp.status}: ${txt}`);
      }
      const json=await resp.json();
      const text=json?.candidates?.[0]?.content?.parts?.map(p=>p.text).filter(Boolean).join('\n')||'';
      console.log('[API] å›å‚³æ–‡å­—é•·åº¦=', text.length);
      return text || JSON.stringify(json);
    }

    /**
     * è§£æ Gemini å›å‚³çš„ç´”æ–‡å­— (é€™éƒ¨åˆ†æ˜¯ä¹‹å‰è§£æå¤±æ•—çš„åœ°æ–¹)
     */
    function parseGeminiResponseToTokens(responseText) {
        // é€™å€‹è§£æå™¨å¾ˆåŸºæœ¬ï¼Œæ‰€ä»¥å¯èƒ½æœƒå¤±æ•—ï¼Œä½†æˆ‘å€‘ä¿ç•™å®ƒä¾†é‡ç¾ä¹‹å‰çš„ç‹€æ…‹
        console.log('[Parser] å˜—è©¦è§£æç´”æ–‡å­—:', responseText);
        const tokens = [{
            kind: 'lyric',
            text: `ç„¡æ³•è§£æ Gemini å›æ‡‰\n\nåŸå§‹å›æ‡‰ï¼š\n${responseText}`,
            x: 10, y: 10, w: 400, h: 100
        }];
        // å³ä½¿è§£æå¤±æ•—ï¼Œæˆ‘å€‘ä¹Ÿå›å‚³ä¸€å€‹ tokenï¼Œè®“ UI é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        return tokens;
    }

    /**
     * æ¸²æŸ“ Tokens åˆ°ç•«é¢ä¸Š
     */
    function renderTokens(tokens) {
        if (!elements.recognitionResult) return;
        elements.recognitionResult.innerHTML = '';
        (tokens || []).forEach(token => {
            const el = document.createElement('div');
            el.className = `tag ${token.kind}`;
            el.textContent = token.text;
            el.style.cssText = `position: absolute; left: ${token.x}px; top: ${token.y}px; width: ${token.w}px; height: ${token.h}px;`;
            elements.recognitionResult.appendChild(el);
        });
        // åŒæ™‚æ›´æ–°æ–‡å­—ç·¨è¼¯å™¨
        if (elements.textEditor) {
            elements.textEditor.value = (tokens || []).map(t => t.text).join('\n');
      // å…§å®¹æ›´æ–°å¾Œèª¿æ•´é«˜åº¦
      try { if (typeof window.autoResizeTextEditor === 'function') window.autoResizeTextEditor(); } catch(_) {}
        }
    }

    // --- äº‹ä»¶ç¶å®š ---

    // æª”æ¡ˆè¼¸å…¥
    elements.fileInput?.addEventListener('change', () => {
      g.AppState.preURL = null; // æ¸…é™¤èˆŠçš„ URL
      const url = getCurrentImageURL();
      if (url && elements.originalImage) {
        elements.originalImage.innerHTML = `<img src="${url}" style="max-width:100%; height:auto;">`;
      }
      syncAIBtn();
    });

    // å°‡ Gemini å›å‚³ï¼ˆå¯èƒ½æ˜¯ JSON æˆ–ç´”æ–‡å­—ï¼‰æ ¼å¼åŒ–ç‚ºé¡¯ç¤ºç”¨æ–‡å­—ï¼š
    // - å’Œå¼¦è¡Œï¼šä¿ç•™è±ç·š |ï¼Œç§»é™¤ [F] é€™é¡æ–¹æ‹¬è™Ÿ
    // - æ­Œè©è¡Œï¼šç§»é™¤æ‰€æœ‰è±ç·š | ä»¥åŠæ–¹æ‹¬è™Ÿå’Œå¼¦ï¼Œå…¶ä»–ç©ºç™½ä¿ç•™
    function formatGeminiDisplay(raw) {
      // ä½¿ç”¨å…¨åŸŸæ›è¼‰çš„ formatGeminiResponseï¼›è‹¥ä¸å­˜åœ¨å‰‡åŸæ¨£å›å‚³å­—ä¸²
      return (typeof window.formatGeminiResponse === 'function')
        ? window.formatGeminiResponse(raw)
        : String(raw ?? '');
    }

    // AI è¾¨è­˜æŒ‰éˆ•ï¼ˆé¿å…é‡è¤‡ç¶å®šï¼‰
    if (elements.aiBtn && elements.aiBtn.__wired) {
      // å·²ç”±å‰ä¸€æ®µç¨‹å¼ç¢¼ç¶å®šï¼Œé¿å…é‡è¤‡
    } else if (elements.aiBtn) {
      elements.aiBtn.__wired = true;
      elements.aiBtn.addEventListener('click', async () => {
      const apiKey = elements.apiKeyInput?.value.trim();
      const imageUrl = getCurrentImageURL();

      if (!apiKey) {
        elements.geminiStatus.textContent = 'è«‹è¼¸å…¥ API é‡‘é‘°';
        return;
      }
      if (!imageUrl) {
        elements.geminiStatus.textContent = 'è«‹å…ˆé¸æ“‡ä¸€å€‹å½±åƒæª”æ¡ˆ';
        return;
      }

      elements.geminiStatus.textContent = 'AI è¾¨è­˜åŸ·è¡Œä¸­...';
      try {
        const responseText = await callGeminiAPI(imageUrl, apiKey, buildPrompt());
        console.log('[AI] Gemini åŸå§‹å›å‚³:', responseText);
        
        const tokens = parseGeminiResponseToTokens(responseText);
        g.AppState.tokens = tokens;
        
        // å¯«å…¥æ–‡å­—ç·¨è¼¯å™¨ï¼ˆæ­Œè©ä¸åŒ…å« |ï¼Œå’Œå¼¦ä¿ç•™ |ï¼‰
        if (elements.textEditor) {
          const display = formatGeminiDisplay(responseText);
          elements.textEditor.value = display;
          try { if (typeof window.autoResizeTextEditor === 'function') window.autoResizeTextEditor(); } catch(_) {}
        }

        renderTokens(tokens);
        elements.geminiStatus.textContent = 'AI è¾¨è­˜å®Œæˆ';
        
        // æˆåŠŸå¾Œåˆ‡æ›åˆ°ã€Œè¾¨è­˜ç·¨è¼¯ã€åˆ†é 
        if (typeof g.switchView === 'function') {
          g.switchView('recognition');
        } else if (typeof window.switchView === 'function') {
          window.switchView('recognition');
        }
        
      } catch (error) {
        console.error('[AI] è¾¨è­˜æµç¨‹å¤±æ•—:', error);
        elements.geminiStatus.textContent = `éŒ¯èª¤: ${error.message}`;
        renderTokens([{ kind: 'error', text: `è¾¨è­˜å¤±æ•—ï¼š${error.message}`, x:10, y:10, w:400, h:50 }]);
        try { if (typeof window.autoResizeTextEditor === 'function') window.autoResizeTextEditor(); } catch(_) {}
      }
    });
    }

    // é¡¯ç¤º Log æŒ‰éˆ•
    elements.showLogBtn?.addEventListener('click', () => {
        if (!elements.geminiLogDiv || !elements.geminiLogContent) return;

        if (elements.geminiLogDiv.classList.toggle('hidden')) {
            return; // å¦‚æœæ˜¯éš±è—ï¼Œå°±ç›´æ¥çµæŸ
        }

        if (g.AppState.geminiLog) {
            elements.geminiLogContent.textContent = JSON.stringify(g.AppState.geminiLog, null, 2);
        } else {
            elements.geminiLogContent.textContent = 'å°šç„¡ Gemini API çš„æ—¥èªŒç´€éŒ„ã€‚';
        }
    });

    // åˆå§‹åŒ–æŒ‰éˆ•ç‹€æ…‹
    syncAIBtn();
    console.log('[App] åˆå§‹åŒ–å®Œæˆ');

  })(window, document);
</script>
