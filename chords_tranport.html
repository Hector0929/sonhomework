<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ç°¡è­œå’Œå¼¦è½‰æ›</title>
  <style>
    :root {
  /* è‰²å½©ï¼ˆApple é¢¨æ ¼ï¼šä½å½©åº¦ + é«˜å°æ¯”æ–‡å­—ï¼‰ */
  --color-bg: #f5f5f7;
  --color-surface: #ffffff;
  --color-surface-alt: #fbfbfd;
  --color-border: #e5e5ea;
  --color-text: #1d1d1f;
  --color-text-secondary: #6e6e73;
  --color-accent: #0066cc;        /* äº’å‹•è— */
  --color-accent-hover: #004f9e;
  --color-danger: #c62828;
  --color-focus: #1d7afc;

  /* é™°å½±ï¼ˆç´°ç·»åˆ†å±¤è€Œéå·¨å¤§æŠ•å½±ï¼‰ */
  --shadow-sm: 0 1px 2px rgba(0,0,0,.05), 0 0 0 1px rgba(0,0,0,.04);
  --shadow-md: 0 4px 18px rgba(0,0,0,.08);
  --shadow-focus: 0 0 0 3px rgba(0,102,204,.35);

  /* åœ“è§’èˆ‡é‚Šæ¡† */
  --radius-xs: 4px;
  --radius-sm: 8px;
  --radius-lg: 18px;

  /* é–“è·ï¼ˆæ¡ 4/8 åŸºåº•éšæ¢¯ï¼‰ */
  --space-1: 4px;
  --space-2: 8px;
  --space-3: 12px;
  --space-4: 16px;
  --space-5: 24px;
  --space-6: 32px;
  --space-7: 48px;
  --space-8: 64px;

  /* å­—å‹éšå±¤ï¼ˆæµé«”æ’ç‰ˆï¼‰ */
  --font-sans: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, 'Noto Sans TC', 'Helvetica Neue', Arial, sans-serif;
  --fs-caption: clamp(11px, 0.72vw, 12px);
  --fs-body: clamp(14px, 0.9vw, 16px);
  --fs-subtitle: clamp(16px, 1.1vw, 18px);
  --fs-title-sm: clamp(20px, 2vw, 28px);
  --fs-title: clamp(28px, 3.5vw, 44px);
  --fs-hero: clamp(40px, 6vw, 64px);
  --font-weight-regular: 400;
  --font-weight-semibold: 600;
  --font-weight-bold: 700;

  /* å‹•ç•«/æ™‚é–“æ›²ç·šï¼ˆApple æ„Ÿï¼šæŸ”å’Œ / åŠ é€Ÿå¾Œæ¸›é€Ÿï¼‰ */
  --ease-standard: cubic-bezier(.4,.0,.2,1);
  --ease-emphasized: cubic-bezier(.2,.0,.0,1);
  --dur-fast: 120ms;
  --dur-base: 220ms;
  --dur-slow: 480ms;

  /* ç‰ˆå¯¬ */
  --layout-max: 1280px;
  --layout-narrow: 960px;
}

 /* === Step A: åŸºç¤ Reset + Header / Hero é¢¨æ ¼æ³¨å…¥ (ä¸ç ´å£åŸæµç¨‹) === */
 *,*::before,*::after{box-sizing:border-box;}
 html{scroll-behavior:smooth;}
 body{margin:0;background:var(--color-bg);color:var(--color-text);font-family:var(--font-sans);-webkit-font-smoothing:antialiased;}
 img{max-width:100%;display:block;}
 h1,h2,h3,h4,p{margin:0;font-weight:var(--font-weight-regular);} 
 a{text-decoration:none;color:inherit;}
 .site-header{position:sticky;top:0;z-index:60;background:rgba(255,255,255,.85);backdrop-filter:saturate(180%) blur(18px);border-bottom:1px solid var(--color-border);} 
 .nav{max-width:var(--layout-max);margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 28px;} 
 .nav__brand{font-size:18px;font-weight:600;letter-spacing:.5px;} 
 .nav__links{list-style:none;display:flex;gap:24px;padding:0;margin:0;} 
 .nav__links a{font-size:14px;position:relative;padding:6px 4px;} 
 .nav__links a::after{content:"";position:absolute;left:0;right:0;bottom:0;height:2px;background:var(--color-accent);transform:scaleX(0);transition:transform .25s var(--ease-standard);} 
 .nav__links a:hover::after{transform:scaleX(1);} 
 .hero{max-width:var(--layout-max);margin:0 auto;padding:72px 32px 40px;display:grid;gap:56px;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));align-items:center;} 
 .hero__text h1{font-size:var(--fs-hero);font-weight:600;letter-spacing:-.5px;} 
 .hero__lead{margin-top:18px;font-size:var(--fs-subtitle);color:var(--color-text-secondary);max-width:520px;line-height:1.5;} 
 .hero__actions{margin-top:30px;display:flex;gap:16px;flex-wrap:wrap;} 
 .upload-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border:1px solid var(--color-border);background:var(--color-surface);border-radius:var(--radius-sm);cursor:pointer;font-size:14px;font-weight:500;transition:background .25s;} 
 .upload-btn:hover{background:var(--color-surface-alt);} 
 .btn-primary{background:var(--color-accent);color:#fff;border:none;padding:12px 24px;border-radius:var(--radius-sm);font-size:15px;font-weight:600;cursor:pointer;box-shadow:var(--shadow-sm);display:inline-flex;align-items:center;gap:6px;transition:background .25s, box-shadow .25s;} 
 .btn-primary:hover{background:var(--color-accent-hover);} 
 .btn-primary:focus-visible{outline:none;box-shadow:var(--shadow-focus);} 
 .hero__preview{background:linear-gradient(145deg,#fff,#f2f2f5);border:1px solid var(--color-border);border-radius:24px;min-height:340px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;box-shadow:var(--shadow-md);} 
 .hero__preview::after{content:"é è¦½";position:absolute;bottom:14px;right:18px;font-size:12px;color:var(--color-text-secondary);letter-spacing:.5px;} 
 .hero__placeholder{color:var(--color-text-secondary);font-size:14px;letter-spacing:.5px;display:flex;flex-direction:column;align-items:center;gap:12px;} 
 .badge-flow{display:inline-flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--color-border);padding:4px 10px;border-radius:999px;font-size:12px;font-weight:500;letter-spacing:.5px;margin-top:20px;color:var(--color-text-secondary);} 
 @media (max-width:760px){.hero{padding-top:56px;gap:40px;}.hero__text h1{font-size:clamp(34px,9vw,56px);} }

    /* èˆŠ body åˆå§‹é¢¨æ ¼ä¿ç•™å…¶ä»–é¡è‰²ä½¿ç”¨ï¼›padding èˆ‡åº•è‰²å·²ç”±æ–° reset è“‹é */
    body{padding:0;}
    .hidden { display: none; }
    
    /* æ¨™é¡Œæ¨£å¼ */
    .app-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .app-title {
      font-size: 36px;
      font-weight: bold;
      color: #0891b2;
      margin-bottom: 20px;
    }
    
    /* åˆ†é æŒ‰éˆ•æ¨£å¼ */
    .tabs {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 25px;
    }
    .tab-btn {
      min-width: 120px;
      padding: 12px 20px;
      border: 2px solid #22c3ee;
      border-radius: 25px;
      background: white;
      color: #22c3ee;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
    }
    .tab-btn:hover {
      background: #f0f9ff;
    }
    .tab-btn[aria-selected="true"] {
      background: #e0f2fe;
      box-shadow: 0 0 0 3px rgba(34,195,238,0.2) inset;
    }
    
    /* å·¥ä½œå€åŸŸæ¨£å¼ */
    .workspace-frame {
      border: 4px solid #22c3ee;
      border-radius: 48px;
      padding: 30px;
      background: white;
      min-height: 400px;
      max-width: 1100px;
      margin: 0 auto;
      position: relative;
    }
    
    /* åŸæœ‰çš„ç–Šåœ–æ¨£å¼ */
    .overlay-stage { position: relative; display: inline-block; }
    .overlay-stage > img { display: block; max-width: 100%; height: auto; }
    .tag { position: absolute; box-sizing: border-box; border-radius: 4px; padding: 0 4px; line-height: 1; display: flex; align-items: center; justify-content: center; font-family: monospace; }
    .tag.chord { background: rgba(0,0,0,.88); color: #ffd700; font-weight: 700; }
    .tag.lyric { background: rgba(255,255,255,.75); color: #111; border: 1px solid #e5e7eb; }
    
    /* æŒ‰éˆ•æ¨£å¼ */
    #to-export-btn, #to-transpose-btn, #transpose-btn, #recognize-btn {
      position: relative;
      z-index: 10;
      cursor: pointer;
      padding: 8px 16px;
      background: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 10px;
    }
    
    /* ç¢ºä¿ç–Šåœ–ä¸­çš„æ¨™ç±¤ä¸æœƒæ””æˆªé»æ“Šäº‹ä»¶ */
    .overlay-stage .tag {
      pointer-events: none;
    }
    .overlay-stage:hover .tag {
      pointer-events: auto;
    }
    
    /* ä¸Šå‚³å€åŸŸèˆ‡æª”æ¡ˆé è¦½æ¨£å¼ */
    .upload-area {
      border: 2px dashed #22c3ee;
      border-radius: 10px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .upload-area:hover {
      background-color: #f0f9ff;
      border-color: #0891b2;
    }
    .upload-area .upload-icon {
      margin: 0 auto 15px;
    }

    /* å·¥ä½œå€æç¤ºæ–‡å­— */
    .workspace-hint {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #0891b2;
      font-size: 18px;
    }

    /* æª”æ¡ˆé è¦½æ¨£å¼ */
    .file-preview-area {
      margin: 20px 0;
      border-radius: 10px;
      overflow: hidden;
      background: #f8f8f8;
    }
    .file-info {
      padding: 10px 15px;
      background: #e0f2fe;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .file-name {
      font-weight: bold;
      color: #0891b2;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .file-size {
      color: #555;
      font-size: 0.9em;
    }
    .preview-container {
      padding: 15px;
      text-align: center;
      overflow: hidden; /* ç¢ºä¿æº¢å‡ºçš„å…§å®¹è¢«éš±è— */
      min-height: 600px; /* æä¾›è¶³å¤ çš„ç©ºé–“çµ¦æ”¾å¤§å¾Œçš„åœ–ç‰‡ */
    }
    .preview-container img {
      max-width: 100%;  /* ä¿æŒå¯¬åº¦é©æ‡‰å®¹å™¨ */
      max-height: 600px; /* å¾åŸæœ¬çš„ 300px æ”¾å¤§åˆ° 600px */
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: scale(2); /* åŠ å…¥ç¸®æ”¾æ•ˆæœ */
      transform-origin: center top; /* å¾ä¸­å¤®é ‚éƒ¨é–‹å§‹ç¸®æ”¾ */
      margin: 80px 0; /* å¢åŠ ä¸Šä¸‹é‚Šè·ä»¥å®¹ç´æ”¾å¤§çš„å…§å®¹ */
    }

    /* æŒ‰éˆ•æ¨£å¼çµ±ä¸€ */
    #recognize-btn, #to-transpose-btn, #transpose-btn, #to-export-btn {
      background-color: #22c3ee;
      color: white;
      border: none;
      border-radius: 25px;
      padding: 10px 20px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 15px;
    }
    #recognize-btn:hover, #to-transpose-btn:hover, #transpose-btn:hover, #to-export-btn:hover {
      background-color: #0891b2;
    }
    #recognize-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    /* è¾¨è­˜ç·¨è¼¯åˆ†é æ¨£å¼ */
    .recognition-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 20px;
    }
    .recognition-compare-area {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }
    .original-image-container,
    .recognition-result-container {
      flex: 1;
      min-width: 0;
    }
    .recognition-result-area {
      flex: 3;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .edit-panel {
      width: 100%;
      background: #f8f8f8;
      border-radius: 10px;
      padding: 15px;
    }
    #text-editor {
      width: 100%;
      min-height: 600px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
    }
    .original-image-container,
    .recognition-result-container {
      flex: 1;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      gap: 8px; /* å…§éƒ¨å…ƒç´ é–“è·ï¼Œé¿å…èˆ‡ä¸‹æ–¹æ¡†ç·šè¦–è¦ºè²¼åˆ */
    }
    .original-image-container h3,
    .recognition-result-container h3 {
      margin-top: 0;
      color: #0891b2;
      font-size: 18px;
      margin-bottom: 10px;
    }
    #recognition-status {
      font-size: 14px;
      color: #888;
      font-weight: normal;
    }
    .recognition-controls {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .overlay-container {
      flex: 1;
      position: relative;
      border: 1px dashed #ccc;
      background-color: #fcfcfc;
      overflow: auto;
    }
    .edit-tools {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }
    .edit-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: #e0f2fe;
      color: #0891b2;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
    }
    .edit-btn:hover {
      background-color: #bae6fd;
    }
    .edit-options {
      margin-top: 15px;
      padding: 12px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .edit-option {
      margin-bottom: 12px;
    }
    .edit-option label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-size: 14px;
    }
    .edit-option select, 
    .edit-option input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .edit-actions {
      display: flex;
      gap: 10px;
    }
    .edit-action-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 4px;
      background-color: #22c3ee;
      color: white;
      cursor: pointer;
    }
    .edit-action-btn.danger {
      background-color: #ff6b6b;
    }
    .edit-action-btn:hover {
      opacity: 0.9;
    }
    .edit-help {
      background: #f0f9ff;
      border-radius: 8px;
      padding: 12px;
      margin-top: 20px;
    }
    .edit-help h4 {
      margin-top: 0;
      color: #0891b2;
      font-size: 16px;
      margin-bottom: 8px;
    }
    .edit-help ul {
      margin: 0;
      padding-left: 20px;
      color: #555;
    }
    .edit-help li {
      margin-bottom: 6px;
      font-size: 14px;
    }
    .action-btn {
      padding: 10px 20px;
      border-radius: 25px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    .action-btn.primary {
      background-color: #22c3ee;
      color: white;
    }
    .action-btn.secondary {
      background-color: #e0f2fe;
      color: #0891b2;
      border: 1px solid #bae6fd;
    }
    .action-btn:hover {
      opacity: 0.9;
    }
    /* å’Œå¼¦èˆ‡æ­Œè©çš„å¯ç·¨è¼¯æ¨£å¼ */
    .tag.editable {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .tag.editable:hover {
      box-shadow: 0 0 0 2px rgba(34, 195, 238, 0.5);
    }
    .tag.editable.selected {
      box-shadow: 0 0 0 3px #22c3ee;
    }
    .tag.chord.editable {
      border: 1px dashed #ffd700;
    }
    .tag.lyric.editable {
      border: 1px dashed #22c3ee;
    }
    /* æ–°å¢é …ç›®çš„æç¤ºæ¨£å¼ */
    .add-item-hint {
      position: absolute;
      background-color: rgba(34, 195, 238, 0.1);
      border: 2px dashed #22c3ee;
      padding: 15px;
      border-radius: 8px;
      color: #0891b2;
      font-size: 14px;
      text-align: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .overlay-container.edit-mode:hover .add-item-hint {
      opacity: 1;
    }

    /* è¾¨è­˜ç·¨è¼¯é é¢ä¸¦æ’é¡¯ç¤ºæ¨£å¼ */
    .recognition-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 20px;
    }

    /* åŸå§‹åœ–èˆ‡è¾¨è­˜çµæœä¸¦æ’ */
    .recognition-compare-area {
      display: flex;
      gap: 20px;
      width: 100%;
      align-items: stretch; /* å…©å´ç­‰é«˜ */
    }

    .original-image-container,
    .recognition-result-container {
      flex: 1;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
      min-height: 400px;
      display: flex;
      flex-direction: column;
    }

    .original-image-container h3,
    .recognition-result-container h3 {
      margin-top: 0;
      color: #0891b2;
      font-size: 18px;
      margin-bottom: 10px;
    }

    /* åœ–ç‰‡å®¹å™¨æ¨£å¼ */
    .image-container {
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .image-container img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    /* å·¦å´åŸå§‹åœ–ç‰‡ï¼šä½¿ç”¨åŸå°ºå¯¸ï¼Œè¶…å‡ºå‰‡é¡¯ç¤ºæ²è»¸ */
    .original-image-container .image-container {
      align-items: flex-start;
      justify-content: flex-start;
      overflow: auto;
    }
    /* æ¨¡å¼ä¸€ï¼šé©æ‡‰å¯¬åº¦ï¼ˆé è¨­ï¼‰ */
    .original-image-container .image-container.fit-width img,
    .original-image-container .image-container.fit-width canvas {
      width: 100%;
      height: auto;
      max-width: 100%;
      object-fit: contain;
      display: block;
    }
    /* æ¨¡å¼äºŒï¼šåŸå°ºå¯¸ */
    .original-image-container .image-container.actual-size img,
    .original-image-container .image-container.actual-size canvas {
      max-width: none;
      max-height: none;
      width: auto;
      height: auto;
      object-fit: initial;
      display: block;
      flex: 0 0 auto; /* é¿å…è¢« flex ç¸®æ”¾ */
    }

    /* è¾¨è­˜çµæœå®¹å™¨ */
    .overlay-container {
      flex: 1;
      position: relative;
      border: 1px dashed #ccc;
      background-color: #fcfcfc;
      overflow: auto;
    }

    /* ç·¨è¼¯é¢æ¿ç½®æ–¼ä¸‹æ–¹ */
    .edit-panel {
      width: 100%;
      background: #f8f8f8;
      border-radius: 10px;
      padding: 15px;
    }

    /* å·¥å…·åˆ—æ’æˆæ°´å¹³ */
    .edit-tools {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* å¯ç·¨è¼¯æ¨™ç±¤æ¨£å¼ */
    .tag.editable {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tag.editable:hover {
      box-shadow: 0 0 0 2px rgba(34, 195, 238, 0.5);
    }

    .tag.editable.selected {
      box-shadow: 0 0 0 3px #22c3ee;
    }
    .tag.chord.editable {
      border: 1px dashed #ffd700;
    }
    .tag.lyric.editable {
      border: 1px dashed #22c3ee;
    }
    /* æ–‡å­—æ¨¡å¼åˆ‡æ›åˆ— */
    .result-mode-switch { display:flex; gap:8px; align-items:center; margin:6px 0 10px; }
    .mode-btn {
      padding:6px 10px; border:1px solid #bae6fd; border-radius:9999px;
      background:#e0f2fe; color:#0891b2; font-weight:700; cursor:pointer;
    }
    .mode-btn.active { background:#22c3ee; color:#fff; border-color:#22c3ee; }

    /* ç´”æ–‡å­—ç·¨è¼¯å™¨ */
    #text-editor-wrap {
      margin-top:8px;
      margin-bottom:8px;
      display:flex;
      flex-direction:column;
      flex:1;           /* ä½”æ»¿å³å´å®¹å™¨å‰©é¤˜é«˜åº¦ */
      min-height:0;     /* å…è¨±å…§éƒ¨å­é …ç¸®æ”¾ */
    }
    #text-editor {
      width:100%;
      /* åœ¨ flex ä½ˆå±€ä¸‹ä»¥ flex æ’æ»¿ï¼Œä¸å†ç”¨å…§å®¹è‡ªå‹•é«˜åº¦ */
      flex: 1 1 auto;
      min-height:0;
      height:auto;
      resize:vertical; /* å¯æ‰‹å‹•æ‹‰é«˜ï¼Œè‹¥éœ€åš´æ ¼ç­‰é«˜å¯ç§»é™¤æ­¤è¨­å®š */
      white-space:pre;
      line-height:1.6;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      border:1px solid #e5e7eb;
      border-radius:8px;
      padding:10px;
      background:#fff;
      overflow-y:auto;
      box-sizing: border-box;
      /* å–æ¶ˆå…ˆå‰çš„ max-height é™åˆ¶ï¼Œè®“å…¶ç­‰é«˜æ–¼å·¦å´å®¹å™¨ */
    }

  /* æ–‡å­—å·¥å…·åˆ— */
    .text-tools { display:flex; gap:8px; justify-content:flex-end; margin:6px 0; }
    .tool-btn { padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:12px; }
    .tool-btn:hover { background:#f3f4f6; }
    .tool-btn.primary { background:#22c3ee; color:#fff; border-color:#22c3ee; }
  /* åªä¿ç•™è¤‡è£½æŒ‰éˆ•ï¼Œå…¶ä»–éš±è— */
  .text-tools .tool-btn:not(#copy-text) { display:none !important; }

  /* åŒ¯å‡ºé è¦½æ¨£å¼ */
  .export-toolbar { display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap; }
  .export-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:8px; background:#fff; cursor:pointer; }
  .export-btn.primary { background:#10b981; border-color:#10b981; color:#fff; }
  #export-canvas-wrap { border:1px solid #e5e7eb; border-radius:8px; background:#fff; padding:16px; overflow:auto; }
  #export-preview { white-space:pre; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; line-height:1.6; color:#111; }

  /* æ–°å¢ï¼šå¡ç‰‡èˆ‡ç‰ˆé¢å®¹å™¨ï¼ˆStep Bï¼‰ */
  .app-section-wrapper {max-width:var(--layout-max);margin:0 auto;padding:20px 32px 80px;}
  .section-title {font-size:28px;font-weight:600;letter-spacing:-.5px;margin:0 0 24px;color:#1d1d1f;}
  .panel-modern {background:var(--color-surface);border:1px solid var(--color-border);border-radius:24px;padding:32px;box-shadow:var(--shadow-sm);margin-bottom:48px;}
  .panel-modern.small-pad {padding:20px 24px;}
  .layout-split {display:grid;gap:40px;grid-template-columns:1fr 420px;align-items:start;}
  .layout-split .side-sticky {position:sticky;top:88px;align-self:start;}
  @media (max-width:1180px){.layout-split{grid-template-columns:1fr;} .layout-split .side-sticky{position:static;}}
  .paper-surface {background:#fff;border:1px solid var(--color-border);border-radius:16px;padding:20px;box-shadow:0 2px 6px rgba(0,0,0,.04);} 
  .subtle-label {font-size:12px;color:var(--color-text-secondary);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;display:block;}

    /* Gemini API Key å¡ç‰‡ */
    .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    #gemini-api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* æ–°å¢çš„æ¨£å¼å€åŸŸ */
    /* å®‰å…¨é ç·¨è­¯ï¼šå–®ä¸€ä¾†æºï¼Œé¿å…å­—ä¸²æ‹¼æ¥éºå¤±è·³è„« */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* é€šç”¨æ¨£å¼ */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans);
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var(--ease-standard),
                  color var(--dur-base) var(--ease-standard),
                  box-shadow var(--dur-fast) var(--ease-standard),
                  border-color var(--dur-base);
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    .btn.small { padding: 6px 12px; font-size: 13px; }

    /* Gemini API Key å¡ç‰‡ */
    .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    #gemini-api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* æ–°å¢çš„æ¨£å¼å€åŸŸ */
    /* å®‰å…¨é ç·¨è­¯ï¼šå–®ä¸€ä¾†æºï¼Œé¿å…å­—ä¸²æ‹¼æ¥éºå¤±è·³è„« */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* é€šç”¨æ¨£å¼ */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans);
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var(--ease-standard),
                  color var(--dur-base) var(--ease-standard),
                  box-shadow var(--dur-fast) var(--ease-standard),
                  border-color var(--dur-base);
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    .btn.small { padding: 6px 12px; font-size: 13px; }

    /* Gemini API Key å¡ç‰‡ */
    .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    #gemini-api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* æ–°å¢çš„æ¨£å¼å€åŸŸ */
    /* å®‰å…¨é ç·¨è­¯ï¼šå–®ä¸€ä¾†æºï¼Œé¿å…å­—ä¸²æ‹¼æ¥éºå¤±è·³è„« */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* é€šç”¨æ¨£å¼ */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans);
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var(--ease-standard),
                  color var(--dur-base) var(--ease-standard),
                  box-shadow var(--dur-fast) var(--ease-standard),
                  border-color var(--dur-base);
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    .btn.small { padding: 6px 12px; font-size: 13px; }

    /* Gemini API Key å¡ç‰‡ */
    .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    #gemini-api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* æ–°å¢çš„æ¨£å¼å€åŸŸ */
    /* å®‰å…¨é ç·¨è­¯ï¼šå–®ä¸€ä¾†æºï¼Œé¿å…å­—ä¸²æ‹¼æ¥éºå¤±è·³è„« */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* é€šç”¨æ¨£å¼ */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans);
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var(--ease-standard),
                  color var(--dur-base) var(--ease-standard),
                  box-shadow var(--dur-fast) var(--ease-standard),
                  border-color var(--dur-base);
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    .btn.small { padding: 6px 12px; font-size: 13px; }

    /* Gemini API Key å¡ç‰‡ */
    .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    #gemini-api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* æ–°å¢çš„æ¨£å¼å€åŸŸ */
    /* å®‰å…¨é ç·¨è­¯ï¼šå–®ä¸€ä¾†æºï¼Œé¿å…å­—ä¸²æ‹¼æ¥éºå¤±è·³è„« */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* é€šç”¨æ¨£å¼ */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans);
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var(--ease-standard),
                  color var(--dur-base) var(--ease-standard),
                  box-shadow var(--dur-fast) var(--ease-standard),
                  border-color var(--dur-base);
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    .btn.small { padding: 6px 12px; font-size: 13px; }

    /* Gemini API Key å¡ç‰‡ */
    .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    #gemini-api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* æ–°å¢çš„æ¨£å¼å€åŸŸ */
    /* å®‰å…¨é ç·¨è­¯ï¼šå–®ä¸€ä¾†æºï¼Œé¿å…å­—ä¸²æ‹¼æ¥éºå¤±è·³è„« */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* é€šç”¨æ¨£å¼ */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans);
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var(--ease-standard),
                  color var(--dur-base) var(--ease-standard),
                  box-shadow var(--dur-fast) var(--ease-standard),
                  border-color var(--dur-base) var(--ease-standard);
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    /* ---- Upload é¦–é é¡¯ç¤ºå®‰å…¨è£œä¸ ---- */
  </style>
  <body>
    <div id="upload-section" class="app-section-wrapper panel-modern" style="margin-top:40px;">
      <h2 class="section-title" style="margin-top:0;">ä¸Šå‚³æ¨‚è­œ</h2>
      <p style="color:var(--color-text-secondary);max-width:640px;">é¸æ“‡åœ–ç‰‡æˆ– PDFï¼Œå¾ŒçºŒå¯ä½¿ç”¨ AI é€²è¡Œå’Œå¼¦ / æ­Œè©è¾¨è­˜ï¼Œä¸¦é€²å…¥ç§»èª¿èˆ‡åŒ¯å‡ºæµç¨‹ã€‚</p>
      <div style="margin-top:28px;display:flex;gap:32px;flex-wrap:wrap;align-items:flex-start;">
        <div class="paper-surface" style="flex:1 1 320px;min-width:300px;">
          <label class="upload-btn" style="margin-bottom:14px;">
            <input type="file" id="file-input" hidden accept="image/*,.pdf" />
            <span>é¸æ“‡æª”æ¡ˆ</span>
          </label>
          <div style="display:flex;flex-direction:column;gap:10px;margin:8px 0 4px;">
            <input id="api-key" type="password" placeholder="è¼¸å…¥ Gemini API Key" style="padding:8px 10px;border:1px solid var(--color-border);border-radius:8px;font:14px var(--font-sans);">
            <label style="font-size:12px;color:var(--color-text-secondary);display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="show-key" style="margin:0;"> é¡¯ç¤ºé‡‘é‘°
            </label>
          </div>
          <div id="upload-hint" style="font-size:13px;color:var(--color-text-secondary);line-height:1.5;">æ”¯æ´ JPG / PNG / PDFã€‚é¸æ“‡å¾Œå¯æ–¼ä¸Šæ–¹ Hero é è¦½ï¼Œä¸¦å•Ÿç”¨ AI è¾¨è­˜ã€‚</div>
          <div style="margin-top:18px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <button id="recognize-btn-secondary" class="btn-primary" disabled>AI è¾¨è­˜</button>
            <span id="gemini-status" style="font-size:12px;color:var(--color-text-secondary);"></span>
          </div>
          <pre id="recognize-output" style="background:#111;color:#f5f5f7;padding:12px;border-radius:12px;font-size:12px;line-height:1.4;max-height:260px;overflow:auto;display:none;margin-top:16px;white-space:pre-wrap;"></pre>
        </div>
        <div id="upload-preview-box" class="paper-surface" style="flex:1 1 420px;min-height:280px;display:flex;align-items:center;justify-content:center;position:relative;">
          <div id="upload-preview-empty" style="text-align:center;color:var(--color-text-secondary);font-size:14px;">
            <div style="font-size:46px;opacity:.15;">ğŸ¼</div>
            å°šæœªé¸æ“‡æª”æ¡ˆ
          </div>
        </div>
          <!-- è¾¨è­˜ç·¨è¼¯å€ -->
          <div id="recognition-section" class="app-section-wrapper panel-modern hidden">
            <h2 class="section-title" style="margin-top:0;">AI è¾¨è­˜çµæœç·¨è¼¯</h2>
            <div style="display:flex;flex-wrap:wrap;gap:20px;margin:4px 0 28px;align-items:flex-end;">
              <div style="flex:2 1 320px;min-width:260px;display:flex;flex-direction:column;gap:6px;">
                <label class="subtle-label" for="song-title">æ­Œè­œæ¨™é¡Œ</label>
                <input id="song-title" placeholder="(AI è§£æå¾Œè‡ªå‹•å¡«å…¥ï¼Œå¯ä¿®æ”¹)" style="padding:10px 12px;border:1px solid var(--color-border);border-radius:12px;font:14px var(--font-sans);" />
              </div>
              <div style="flex:0 0 140px;display:flex;flex-direction:column;gap:6px;">
                <label class="subtle-label" for="from-key">åµæ¸¬èª¿æ€§</label>
                <input id="detected-key" placeholder="--" title="å¯æ‰‹å‹•ä¿®æ­£èª¿æ€§ (ä¾‹å¦‚: Bb, F#, Eb)" style="padding:10px 12px;border:1px solid var(--color-border);border-radius:12px;font:14px var(--font-sans);width:100%;" />
              </div>
            </div>
            <div style="display:flex;flex-direction:row;gap:32px;flex-wrap:wrap;align-items:stretch;">
              <div class="paper-surface" style="flex:1 1 380px;min-width:340px;max-height:520px;overflow:auto;">
                <span class="subtle-label">åŸå§‹å½±åƒ</span>
                <div id="recognition-original" style="border:1px solid var(--color-border);border-radius:12px;min-height:320px;display:flex;align-items:center;justify-content:center;overflow:auto;background:#fff;">
                  <div style="text-align:center;color:var(--color-text-secondary);font-size:13px;">å°šæœªè¼‰å…¥</div>
                </div>
              </div>
              <div class="paper-surface" style="flex:2 1 520px;min-width:380px;display:flex;flex-direction:column;">
                <span class="subtle-label">æ–‡å­—ç·¨è¼¯</span>
                <div id="text-editor-wrap">
                  <textarea id="text-editor" placeholder="ç­‰å¾… AI è¾¨è­˜çµæœ..." spellcheck="false"></textarea>
                </div>
                <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-end;margin-top:16px;">
                  <button class="btn ghost" id="back-to-upload">è¿”å›ä¸Šå‚³</button>
                  <button class="btn primary" id="go-to-transpose" disabled>å‰å¾€ç§»èª¿ â–¶</button>
                </div>
              </div>
            </div>
          </div>

          <!-- ç§»èª¿å€ -->
          <div id="transpose-section" class="app-section-wrapper panel-modern hidden">
            <h2 class="section-title" style="margin-top:0;">ç§»èª¿è¨­å®š</h2>
            <div style="display:flex;flex-wrap:wrap;gap:32px;align-items:flex-start;">
              <div class="paper-surface" style="flex:1 1 320px;min-width:300px;display:flex;flex-direction:column;gap:18px;">
                <div>
                  <label class="subtle-label">åŸèª¿</label>
                  <select id="from-key" style="padding:8px 10px;border:1px solid var(--color-border);border-radius:8px;">
                    <option>C</option><option>C#</option><option>D</option><option>Eb</option><option>E</option><option>F</option><option>F#</option><option>G</option><option>Ab</option><option>A</option><option>Bb</option><option>B</option>
                  </select>
                </div>
                <div>
                  <label class="subtle-label">ç›®æ¨™èª¿</label>
                  <select id="to-key" style="padding:8px 10px;border:1px solid var(--color-border);border-radius:8px;">
                    <option>C</option><option>C#</option><option>D</option><option>Eb</option><option>E</option><option>F</option><option>F#</option><option>G</option><option>Ab</option><option>A</option><option>Bb</option><option>B</option>
                  </select>
                </div>
                <button class="btn primary" id="do-transpose" disabled>åŸ·è¡Œç§»èª¿</button>
                <div style="font-size:12px;color:var(--color-text-secondary);line-height:1.5;">åƒ…å°ã€Œçœ‹èµ·ä¾†åƒå’Œå¼¦ã€çš„ token é€²è¡Œè½‰èª¿ï¼Œæ­Œè©èˆ‡å…¶å®ƒç¬¦è™Ÿä¸è®Šã€‚</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  <button class="btn ghost" id="transpose-back">â—€ è¿”å›ç·¨è¼¯</button>
                  <button class="btn" id="transpose-finish" disabled>å‰å¾€åŒ¯å‡º â–¶</button>
                </div>
              </div>
              <div class="paper-surface" style="flex:2 1 520px;min-width:380px;display:flex;flex-direction:column;">
                <span class="subtle-label">ç§»èª¿å¾Œå…§å®¹</span>
                  <textarea id="transpose-output" style="flex:1;min-height:340px;resize:vertical;font-family:ui-monospace,monospace;padding:12px;border:1px solid var(--color-border);border-radius:10px;white-space:pre;line-height:1.5;" placeholder="å°šæœªç§»èª¿"></textarea>
              </div>
            </div>
          </div>
      </div>
    </div>
  <script>
    (function(g,d){
      // éŒ¯èª¤ç›£è½ï¼ˆé˜²æ­¢éœé»˜å¤±æ•—ï¼‰
      if(!g.__UI_ERR_TRAP__){
        g.__UI_ERR_TRAP__=true;
        g.addEventListener('error',e=>{
          console.warn('[InitError]', e.message, e.filename+':'+e.lineno);
          const box = d.getElementById('gemini-status') || d.querySelector('[data-role="status"]');
          if(box) box.textContent = 'åˆå§‹åŒ–éŒ¯èª¤ï¼š' + e.message;
        });
      }

    // è‹¥ switchView ç¼ºå¤± â†’ å»ºç«‹ç°¡æ˜“ç‰ˆ
    if(typeof g.switchView !== 'function'){
      g.switchView = function(view){
        const map = { upload:'upload-section', recognition:'recognition-section', transpose:'transpose-section', export:'export-section' };
        const targetId = map[view];
        if(!targetId){
          console.warn('[switchView] æœªçŸ¥è¦–åœ–', view);
          return;
        }
        // åƒ…åœ¨èƒ½æ‰¾åˆ° target æ™‚æ‰éš±è—å…¶ä»–ï¼Œé¿å…å…¨éƒ¨ç©ºç™½
        const targetEl = d.getElementById(targetId);
        if(!targetEl){
          console.warn('[switchView] æ‰¾ä¸åˆ°ç›®æ¨™ç¯€é»', targetId);
          return;
        }
        Object.values(map).forEach(id=>{
          const el = d.getElementById(id);
          if(el) el.classList.add('hidden');
        });
        targetEl.classList.remove('hidden');
      };
    }

    function ensureUploadVisible(){
      const up = d.getElementById('upload-section');
      if(!up){
        console.warn('[Upload] æ‰¾ä¸åˆ° #upload-sectionï¼Œè«‹ç¢ºèª IDã€‚');
        return;
      }
      if(up.classList.contains('hidden')){
        up.classList.remove('hidden');
      }
      // è‹¥å…¶å®ƒè¦–åœ–å…¨é¡¯ç¤ºéŒ¯äº‚ï¼Œå¯ä¸»å‹•éš±è—å®ƒå€‘
      ['recognition-section','transpose-section','export-section'].forEach(id=>{
        const el = d.getElementById(id);
        if(el && el !== up) el.classList.add('hidden');
      });
    }

    // DOM å°±ç·’å¾Œç¢ºä¿é¡¯ç¤º
    if(d.readyState === 'loading'){
      d.addEventListener('DOMContentLoaded',()=>{
        ensureUploadVisible();
        // é è¨­åˆ‡åˆ° uploadï¼ˆä¸è¦†å¯«ä½¿ç”¨è€…ç¨å¾Œçš„æ“ä½œï¼‰
        g.switchView && g.switchView('upload');
      });
    } else {
      ensureUploadVisible();
      g.switchView && g.switchView('upload');
    }

    // è‹¥å› å…¶å®ƒè…³æœ¬å†æ¬¡æŠŠå®ƒè—èµ·ä¾† â†’ MutationObserver è‡ªå‹•æ‹‰å›
    if(!g.__UPLOAD_VIS_OBS__){
      g.__UPLOAD_VIS_OBS__ = true;
      const mo = new MutationObserver(muts=>{
        muts.forEach(m=>{
          if(m.type==='attributes' && m.target.id==='upload-section' && m.attributeName==='class'){
            if(m.target.classList.contains('hidden')){
              // è‹¥ç›®å‰æ²’æœ‰é¸æ“‡å…¶ä»–è¦–åœ–ï¼ˆåˆ¤æ–·æ¨™ç±¤ aria-selectedï¼‰ï¼Œå°±é‡æ–°é¡¯ç¤º
              const activeTab = d.querySelector('[id^="tab-"][aria-selected="true"]');
              if(!activeTab || activeTab.id==='tab-upload'){
                m.target.classList.remove('hidden');
              }
            }
          }
        });
      });
      const upNode = d.getElementById('upload-section');
      if(upNode){
        mo.observe(upNode,{ attributes:true });
      }
    }

      // --- æ–°å¢ï¼šä¸Šå‚³é è¦½èˆ‡ Hero/æ¬¡æŒ‰éˆ•åŒæ­¥é‚è¼¯ ---
      function syncPreview(file){
        const heroBox = d.getElementById('hero-preview');
        const uploadBox = d.getElementById('upload-preview-box');
        const empty1 = d.getElementById('upload-preview-empty');
        if(!file){
          empty1 && (empty1.style.display='');
          if(heroBox) heroBox.innerHTML = '<div class="hero__placeholder"><div style="font-size:46px;opacity:.12;">ğŸ¼</div><span>ç­‰å¾…ä¸Šå‚³æ¨‚è­œå½±åƒ</span></div>';
          if(uploadBox) uploadBox.innerHTML = '<div id="upload-preview-empty" style="text-align:center;color:var(--color-text-secondary);font-size:14px;"><div style="font-size:46px;opacity:.15;">ğŸ¼</div>å°šæœªé¸æ“‡æª”æ¡ˆ</div>';
          return;
        }
        const url = URL.createObjectURL(file);
        const imgHTML = file.type==='application/pdf'
          ? '<div style="text-align:center;color:var(--color-text-secondary);font-size:13px;">PDF å·²é¸æ“‡ï¼Œç¨å¾Œæ–¼è¾¨è­˜é é è¦½ç¬¬ä¸€é ã€‚</div>'
          : `<img src="${url}" alt="preview" style="max-width:100%;height:auto;display:block;">`;
        if(heroBox){
          heroBox.innerHTML = `<div style="padding:12px;width:100%;height:100%;display:flex;align-items:center;justify-content:center;">${imgHTML}</div>`;
        }
        if(uploadBox){
          uploadBox.innerHTML = `<div style="width:100%;">${imgHTML}</div>`;
        }
      }

      function enableRecognize(enable){
        const btn1 = d.getElementById('recognize-btn');
        const btn2 = d.getElementById('recognize-btn-secondary');
        [btn1,btn2].forEach(b=>{ if(b){ b.disabled = !enable; }});
      }

      const fi = d.getElementById('file-input');
      if(fi && !fi.__wired){
        fi.addEventListener('change',()=>{
          const f = fi.files && fi.files[0];
          syncPreview(f);
          enableRecognize(!!f);
        });
        fi.__wired = true;
      }

      // ä¸€é–‹å§‹æª¢æŸ¥æ˜¯å¦å·²æœ‰é å…ˆçš„æª”æ¡ˆ URLï¼ˆä¾‹å¦‚å¾ä¸Šæ¬¡ç‹€æ…‹æ¢å¾©ï¼‰
      if(fi && fi.files && fi.files[0]){
        syncPreview(fi.files[0]);
        enableRecognize(true);
      }

      // === API Key é¡¯ç¤ºåˆ‡æ› ===
      const showKeyChk = d.getElementById('show-key');
      const apiKeyInput = d.getElementById('api-key');
      if(showKeyChk && apiKeyInput && !showKeyChk.__wired){
        showKeyChk.addEventListener('change',()=>{ apiKeyInput.type = showKeyChk.checked ? 'text':'password'; });
        showKeyChk.__wired = true;
      }

      // === Gemini API å‘¼å«æ ¸å¿ƒï¼ˆç²¾ç°¡ç‰ˆï¼‰ ===
      async function fileToBase64Mime(file){
        return new Promise((resolve,reject)=>{
          const r=new FileReader();
            r.onerror=()=>reject(new Error('è®€å–æª”æ¡ˆå¤±æ•—'));
            r.onload=()=>{
              const res=r.result;
              const m=String(res).match(/^data:([^;]+);base64,(.*)$/);
              if(!m) return reject(new Error('ç„¡æ³•è§£æ base64'));
              resolve({mimeType:m[1],base64:m[2]});
            };
          r.readAsDataURL(file);
        });
      }
      function buildPrompt(){
        return (
          'ä½ æ˜¯ä¸€å€‹æ¨‚è­œ OCR å°ˆå®¶ã€‚è«‹å¾åœ–åƒåµæ¸¬ä¸¦è¼¸å‡ºï¼š\n' +
          '1) æ¨‚æ›²æ¨™é¡Œ (Title)\n' +
          '2) æ¨‚æ›²ä¸»èª¿ (Key) è‹¥ç„¡æ˜ç¤ºï¼Œæ ¹æ“šå’Œå¼¦æ¨æ¸¬æœ€å¯èƒ½èª¿æ€§ (åªè¼¸å‡ºä¸€å€‹ï¼Œå¦‚ C / G / F# / Bb)ã€‚\n' +
          '3) ä¸»è¦å…§å®¹ (å’Œå¼¦ + æ­Œè©)\n\n' +
          'è¼¸å‡ºæ ¼å¼è«‹ç”¨ä¸‹åˆ— JSON åŒ…åœ¨æœ€å¤–å±¤çš„ ```json ç¨‹å¼ç¢¼å€å¡Šï¼š\n' +
          '```json\n' +
          '{"title":"...","key":"...","content":"å¤šè¡Œå’Œå¼¦èˆ‡æ­Œè©"}\n' +
          '```\n' +
          'è¦å‰‡ï¼šå’Œå¼¦è¡Œä¿ç•™è±ç·š |ï¼Œæ­Œè©è¡Œç§»é™¤ |ï¼›ä¿æŒåŸæ®µè½é †åºèˆ‡ç©ºç™½ï¼›ä¸è¦åŠ å…¥å¤šé¤˜è¨»è§£ã€‚'
        );
      }
      async function callGeminiAPIFromFile(file, apiKey){
        const {mimeType,base64}= await fileToBase64Mime(file);
        const body={contents:[{parts:[{text:buildPrompt()},{inlineData:{mimeType,data:base64}}]}],generationConfig:{temperature:0.1,maxOutputTokens:2048}};
        const url=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${encodeURIComponent(apiKey)}`;
        const resp= await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        if(!resp.ok){ const t=await resp.text(); throw new Error('Gemini API éŒ¯èª¤ '+resp.status+': '+t.slice(0,200)); }
        const json= await resp.json();
        const text=json?.candidates?.[0]?.content?.parts?.map(p=>p.text).filter(Boolean).join('\n')||'';
        return text;
      }
      function formatDisplay(raw){
        return String(raw).split('\n').map(line=>{ if(/\|/.test(line) && /[A-G][#b]?/.test(line)) return line; return line.replace(/\|/g,''); }).join('\n');
      }
      function parseMetadataFromText(text){
        const meta={title:'',key:'',content:text};
        // å˜—è©¦æŠ“å– ```json å€å¡Š
        const blockMatch = text.match(/```json[\s\S]*?({[\s\S]*?})\s*```/i);
        if(blockMatch){
          try {
            const obj = JSON.parse(blockMatch[1]);
            meta.title = obj.title || ''; meta.key = obj.key || ''; meta.content = obj.content || text;
            return meta;
          } catch{ /* ignore */ }
        }
        // å‚™æ´ï¼šç°¡å–®æ­£å‰‡æŠ“æ¨™é¡Œèˆ‡ Key
        const titleLine = text.split(/\n/).find(l=>/title\s*[:ï¼š]/i.test(l)) || '';
        const mTitle = titleLine.match(/title\s*[:ï¼š]\s*(.+)/i);
        if(mTitle) meta.title = mTitle[1].trim();
        const keyLine = text.split(/\n/).find(l=>/key\s*[:ï¼š]/i.test(l)) || '';
        const mKey = keyLine.match(/key\s*[:ï¼š]\s*([A-G][#b]?)/i);
        if(mKey) meta.key = mKey[1].toUpperCase();
        return meta;
      }
      async function handleRecognize(){
        const file = fi?.files?.[0];
        const apiKey = apiKeyInput?.value.trim();
        const statusEl = d.getElementById('gemini-status');
        const out = d.getElementById('recognize-output');
        if(!file){ statusEl.textContent='è«‹å…ˆé¸æ“‡æª”æ¡ˆ'; return; }
        if(!apiKey){ statusEl.textContent='è«‹è¼¸å…¥ API Key'; return; }
        statusEl.textContent='è¾¨è­˜ä¸­...'; out.style.display='none'; out.textContent='';
        try { const text = await callGeminiAPIFromFile(file, apiKey); const display = formatDisplay(text); out.textContent = display || '(ç„¡å…§å®¹)'; out.style.display='block'; statusEl.textContent='å®Œæˆ'; }
        catch(err){ statusEl.textContent='éŒ¯èª¤: '+err.message; }
      }
      const rbtn1 = d.getElementById('recognize-btn');
      const rbtn2 = d.getElementById('recognize-btn-secondary');
      [rbtn1,rbtn2].forEach(btn=>{ if(btn && !btn.__wired){ btn.addEventListener('click',handleRecognize); btn.__wired=true; }});
      // åµæ¸¬èª¿æ€§æ‰‹å‹•ä¿®æ”¹åŒæ­¥
      const detectedKeyInput = d.getElementById('detected-key');
      if(detectedKeyInput && !detectedKeyInput.__wired){
        detectedKeyInput.addEventListener('change',()=>{
          let val = detectedKeyInput.value.trim();
          if(!val) return;
          // æ­£è¦åŒ–ï¼šé¦–å­—æ¯å¤§å¯« å…¶é¤˜è½‰å°å¯«ï¼Œå†è™•ç† b/#
            val = val.replace(/[^A-Ga-g#b]/g,'').toUpperCase().replace(/B(?!B)/,'B');
          // æ˜ å°„é™è™Ÿ to æ­£å¼ï¼ˆä¿ç•™åŸæ¨£è‹¥åˆæ³•ï¼‰
          const allow = ['C','C#','D','Eb','D#','E','F','F#','G','Ab','G#','A','Bb','A#','B'];
          // è‹¥åŒæ™‚å­˜åœ¨å‡é™é‡è¤‡ï¼Œå„ªå…ˆä½¿ç”¨å¸¸è¦‹é™è™Ÿåç¨±
          const preferMap={'A#':'Bb','D#':'Eb','G#':'Ab'};
          if(preferMap[val]) val = preferMap[val];
          if(!allow.includes(val)) { detectedKeyInput.style.borderColor = '#e11d48'; return; }
          detectedKeyInput.style.borderColor = 'var(--color-border)';
          const fromSel = d.getElementById('from-key');
          if(fromSel){ [...fromSel.options].forEach(o=>{ if(o.value.toUpperCase()===val.toUpperCase()) fromSel.value=o.value; }); }
        });
        detectedKeyInput.__wired = true;
      }

      // === æˆåŠŸå¾Œå¯«å…¥ç·¨è¼¯å™¨ä¸¦åˆ‡æ› ===
      const origImgBox = d.getElementById('recognition-original');
      async function handleRecognize(){
        const file = fi?.files?.[0];
        const apiKey = apiKeyInput?.value.trim();
        const statusEl = d.getElementById('gemini-status');
        const out = d.getElementById('recognize-output');
        if(!file){ statusEl.textContent='è«‹å…ˆé¸æ“‡æª”æ¡ˆ'; return; }
        if(!apiKey){ statusEl.textContent='è«‹è¼¸å…¥ API Key'; return; }
        statusEl.textContent='è¾¨è­˜ä¸­...'; out.style.display='none'; out.textContent='';
        try { 
          const text = await callGeminiAPIFromFile(file, apiKey); 
          const meta = parseMetadataFromText(text);
          let display = formatDisplay(meta.content); 
          // æ’å…¥æ¨™é¡Œèˆ‡ Key header
          const headerTitle = (meta.title||'').trim();
          const headerKey = (meta.key||'').trim();
          if(headerTitle || headerKey){
            const headerLines = [];
            if(headerTitle) headerLines.push(headerTitle);
            if(headerKey) headerLines.push('Key: ' + headerKey);
            display = headerLines.join('\n') + '\n\n' + display;
          }
          out.textContent = display || '(ç„¡å…§å®¹)'; out.style.display='block'; statusEl.textContent='å®Œæˆ';
          // å­˜å…¥å…¨åŸŸç‹€æ…‹
          g.__LAST_AI_RESULT__ = display;
          if(meta.title) { const ti = d.getElementById('song-title'); ti && (ti.value = meta.title); }
          if(meta.key) { const dk = d.getElementById('from-key'); dk && (dk.value = meta.key); const dk2=d.getElementById('detected-key'); dk2 && (dk2.value=meta.key); }
          const editor = d.getElementById('text-editor');
          if(editor){ editor.value = display; d.getElementById('go-to-transpose')?.removeAttribute('disabled'); }
          // åŸåœ–åŒæ­¥
          if(origImgBox){
            if(file.type==='application/pdf') origImgBox.innerHTML='<div style="padding:40px;text-align:center;font-size:13px;color:var(--color-text-secondary);">PDF å·²ä¸Šå‚³ï¼ˆå¯æ“´å……é è¦½ï¼‰</div>';
            else {
              const url = URL.createObjectURL(file);
              origImgBox.innerHTML = `<img src="${url}" style="max-width:100%;height:auto;display:block;">`;
            }
          }
          g.switchView && g.switchView('recognition');
        }
        catch(err){ statusEl.textContent='éŒ¯èª¤: '+err.message; }
      }

      // === ç§»èª¿åŠŸèƒ½ ===
      function transposeChord(ch, diff){
        const notes=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
        const mapFlat={'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Bb':'A#'};
        return ch.replace(/^[A-G][b#]?/,m=>{
          const norm = mapFlat[m]||m; const i=notes.indexOf(norm); if(i<0) return m; return notes[(i+diff+12)%12];
        });
      }
      function detectChordToken(tok){ return /^[A-G][#b]?[a-zA-Z0-9()/]*$/.test(tok); }
      function transposeText(txt, fromKey, toKey){
        const notes=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
        const flatToSharp={'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Bb':'A#'};
        function norm(k){return flatToSharp[k]||k;}
        const diff = (notes.indexOf(norm(toKey)) - notes.indexOf(norm(fromKey)) + 12) % 12;
        return txt.split(/\n/).map(line=>{
          // ä¿ç•™ header è¡Œï¼ˆTitle/Keyï¼‰ä¸è½‰
          if(/^Key:\s*/i.test(line) || line.trim()=== '' || line.length<2) return line;
            // åˆ¤æ–·æ˜¯å¦ç‚ºå’Œå¼¦å¯†é›†è¡Œï¼ˆå«è±ç·šæˆ–å¤šå€‹å’Œå¼¦ç‰‡æ®µï¼‰
            const chordLike = /\|/.test(line) || (line.match(/[A-G][#b]?/g)||[]).length>2;
            if(!chordLike) return line; 
            return line.replace(/([A-G][#b]?)([a-zA-Z0-9()/#]*)/g,(m,root,rest)=>{
              const token = root+rest;
              if(!detectChordToken(token)) return m;
              return transposeChord(token,diff);
            });
        }).join('\n');
      }
      const goTrans = d.getElementById('go-to-transpose');
      const backUpload = d.getElementById('back-to-upload');
      const doTrans = d.getElementById('do-transpose');
      const backEdit = d.getElementById('transpose-back');
      const finishBtn = d.getElementById('transpose-finish');
      const outArea = d.getElementById('transpose-output');
      ;[backUpload, backEdit].forEach(btn=> btn && btn.addEventListener('click',()=> g.switchView && g.switchView('upload')));
  goTrans && goTrans.addEventListener('click',()=>{ 
        doTrans && (doTrans.disabled=false); 
        g.switchView && g.switchView('transpose'); 
        const src = d.getElementById('text-editor')?.value||''; 
        outArea.value = src; 
        finishBtn && (finishBtn.disabled=false); 
        const ti = d.getElementById('song-title')?.value; if(ti) document.title = ti + ' - ç§»èª¿'; 
      });
      doTrans && doTrans.addEventListener('click',()=>{ 
        const src = d.getElementById('text-editor')?.value||''; 
        const fk = d.getElementById('from-key').value; 
        const tk = d.getElementById('to-key').value; 
        let transposed = transposeText(src,fk,tk);
        // æ›´æ–°/æ’å…¥ Key header è¡Œ
        let lines = transposed.split(/\n/);
        const keyLineIndex = lines.findIndex(l=>/^Key:\s*/i.test(l));
        const newKeyLine = 'Key: '+tk;
        if(keyLineIndex>=0) lines[keyLineIndex]=newKeyLine; else lines.splice( lines[0].trim()?1:0,0,newKeyLine );
        outArea.value = lines.join('\n');
      });

      // æ¨™é¡Œ / èª¿æ€§è®Šæ›´å³æ™‚å¥—ç”¨åˆ°æ­£æ–‡é¦–éƒ¨ï¼ˆä¸å½±éŸ¿ç§»èª¿çµæœé™¤éé‡è·‘ï¼‰
      const songTitleInput = d.getElementById('song-title');
      function updateHeaderInEditor(){
        const editor = d.getElementById('text-editor'); if(!editor) return;
        const val = editor.value.split(/\n/);
        let idxKey = val.findIndex(l=>/^Key:\s*/i.test(l));
        let idxTitle = val.findIndex(l=>l.trim() && !/^Key:/i.test(l));
        if(idxTitle<0) idxTitle=0;
        const title = (songTitleInput?.value||'').trim();
        if(title){ if(idxTitle===0) val[0]=title; else val.unshift(title); }
        if(detectedKeyInput){ const k = detectedKeyInput.value.trim(); if(k){ if(idxKey>=0) val[idxKey]='Key: '+k; else val.splice( (title?1:0),0,'Key: '+k); } }
        editor.value = val.join('\n');
      }
      songTitleInput && songTitleInput.addEventListener('change',updateHeaderInEditor);
      detectedKeyInput && detectedKeyInput.addEventListener('change',updateHeaderInEditor);

  })(window,document);
</script>
</body>
</html>