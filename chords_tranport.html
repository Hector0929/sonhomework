<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>簡譜和弦轉換</title>
  <style>
    :root {
  /* 色彩（Apple 風格：低彩度 + 高對比文字） */
  --color-bg: #f5f5f7;
  --color-surface: #ffffff;
  --color-surface-alt: #fbfbfd;
  --color-border: #e5e5ea;
  --color-text: #1d1d1f;
  --color-text-secondary: #6e6e73;
  --color-accent: #0066cc;        /* 互動藍 */
  --color-accent-hover: #004f9e;
  --color-danger: #c62828;
  --color-focus: #1d7afc;

  /* 陰影（細緻分層而非巨大投影） */
  --shadow-sm: 0 1px 2px rgba(0,0,0,.05), 0 0 0 1px rgba(0,0,0,.04);
  --shadow-md: 0 4px 18px rgba(0,0,0,.08);
  --shadow-focus: 0 0 0 3px rgba(0,102,204,.35);

  /* 圓角與邊框 */
  --radius-xs: 4px;
  --radius-sm: 8px;
  --radius-lg: 18px;

  /* 間距（採 4/8 基底階梯） */
  --space-1: 4px;
  --space-2: 8px;
  --space-3: 12px;
  --space-4: 16px;
  --space-5: 24px;
  --space-6: 32px;
  --space-7: 48px;
  --space-8: 64px;

  /* 字型階層（流體排版） */
  --font-sans: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, 'Noto Sans TC', 'Helvetica Neue', Arial, sans-serif;
  --fs-caption: clamp(11px, 0.72vw, 12px);
  --fs-body: clamp(14px, 0.9vw, 16px);
  --fs-subtitle: clamp(16px, 1.1vw, 18px);
  --fs-title-sm: clamp(20px, 2vw, 28px);
  --fs-title: clamp(28px, 3.5vw, 44px);
  --fs-hero: clamp(40px, 6vw, 64px);
  --font-weight-regular: 400;
  --font-weight-semibold: 600;
  --font-weight-bold: 700;

  /* 動畫/時間曲線（Apple 感：柔和 / 加速後減速） */
  --ease-standard: cubic-bezier(.4,.0,.2,1);
  --ease-emphasized: cubic-bezier(.2,.0,.0,1);
  --dur-fast: 120ms;
  --dur-base: 220ms;
  --dur-slow: 480ms;

  /* 版寬 */
  --layout-max: 1280px;
  --layout-narrow: 960px;
}

 /* === Step A: 基礎 Reset + Header / Hero 風格注入 (不破壞原流程) === */
 *,*::before,*::after{box-sizing:border-box;}
 html{scroll-behavior:smooth;}
 body{margin:0;background:var(--color-bg);color:var(--color-text);font-family:var(--font-sans);-webkit-font-smoothing:antialiased;}
 img{max-width:100%;display:block;}
 h1,h2,h3,h4,p{margin:0;font-weight:var(--font-weight-regular);} 
 a{text-decoration:none;color:inherit;}
 .site-header{position:sticky;top:0;z-index:60;background:rgba(255,255,255,.85);backdrop-filter:saturate(180%) blur(18px);border-bottom:1px solid var(--color-border);} 
 .nav{max-width:var(--layout-max);margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 28px;} 
 .nav__brand{font-size:18px;font-weight:600;letter-spacing:.5px;} 
 .nav__links{list-style:none;display:flex;gap:24px;padding:0;margin:0;} 
 .nav__links a{font-size:14px;position:relative;padding:6px 4px;} 
 .nav__links a::after{content:"";position:absolute;left:0;right:0;bottom:0;height:2px;background:var(--color-accent);transform:scaleX(0);transition:transform .25s var(--ease-standard);} 
 .nav__links a:hover::after{transform:scaleX(1);} 
 .hero{max-width:var(--layout-max);margin:0 auto;padding:72px 32px 40px;display:grid;gap:56px;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));align-items:center;} 
 .hero__text h1{font-size:var(--fs-hero);font-weight:600;letter-spacing:-.5px;} 
 .hero__lead{margin-top:18px;font-size:var(--fs-subtitle);color:var(--color-text-secondary);max-width:520px;line-height:1.5;} 
 .hero__actions{margin-top:30px;display:flex;gap:16px;flex-wrap:wrap;} 
 .upload-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border:1px solid var(--color-border);background:var(--color-surface);border-radius:var(--radius-sm);cursor:pointer;font-size:14px;font-weight:500;transition:background .25s;} 
 .upload-btn:hover{background:var(--color-surface-alt);} 
 .btn-primary{background:var(--color-accent);color:#fff;border:none;padding:12px 24px;border-radius:var(--radius-sm);font-size:15px;font-weight:600;cursor:pointer;box-shadow:var(--shadow-sm);display:inline-flex;align-items:center;gap:6px;transition:background .25s, box-shadow .25s;} 
 .btn-primary:hover{background:var(--color-accent-hover);} 
 .btn-primary:focus-visible{outline:none;box-shadow:var(--shadow-focus);} 
 .hero__preview{background:linear-gradient(145deg,#fff,#f2f2f5);border:1px solid var(--color-border);border-radius:24px;min-height:340px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;box-shadow:var(--shadow-md);} 
 .hero__preview::after{content:"預覽";position:absolute;bottom:14px;right:18px;font-size:12px;color:var(--color-text-secondary);letter-spacing:.5px;} 
 .hero__placeholder{color:var(--color-text-secondary);font-size:14px;letter-spacing:.5px;display:flex;flex-direction:column;align-items:center;gap:12px;} 
 .badge-flow{display:inline-flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--color-border);padding:4px 10px;border-radius:999px;font-size:12px;font-weight:500;letter-spacing:.5px;margin-top:20px;color:var(--color-text-secondary);} 
 @media (max-width:760px){.hero{padding-top:56px;gap:40px;}.hero__text h1{font-size:clamp(34px,9vw,56px);} }

    /* 舊 body 初始風格保留其他顏色使用；padding 與底色已由新 reset 蓋過 */
    body{padding:0;}
    .hidden { display: none; }
    
    /* 標題樣式 */
    .app-header {
      text-align: center;
      margin-bottom: 20px;
    }
    .app-title {
      font-size: 36px;
      font-weight: bold;
      color: #0891b2;
      margin-bottom: 20px;
    }
    
    /* 分頁按鈕樣式 */
    .tabs {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 25px;
    }
    .tab-btn {
      min-width: 120px;
      padding: 12px 20px;
      border: 2px solid #22c3ee;
      border-radius: 25px;
      background: white;
      color: #22c3ee;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
    }
    .tab-btn:hover {
      background: #f0f9ff;
    }
    .tab-btn[aria-selected="true"] {
      background: #e0f2fe;
      box-shadow: 0 0 0 3px rgba(34,195,238,0.2) inset;
    }
    
    /* 工作區域樣式 */
    .workspace-frame {
      border: 4px solid #22c3ee;
      border-radius: 48px;
      padding: 30px;
      background: white;
      min-height: 400px;
      max-width: 1100px;
      margin: 0 auto;
      position: relative;
    }
    
    /* 原有的疊圖樣式 */
    .overlay-stage { position: relative; display: inline-block; }
    .overlay-stage > img { display: block; max-width: 100%; height: auto; }
    .tag { position: absolute; box-sizing: border-box; border-radius: 4px; padding: 0 4px; line-height: 1; display: flex; align-items: center; justify-content: center; font-family: monospace; }
    .tag.chord { background: rgba(0,0,0,.88); color: #ffd700; font-weight: 700; }
    .tag.lyric { background: rgba(255,255,255,.75); color: #111; border: 1px solid #e5e7eb; }
    
    /* 按鈕樣式 */
    #to-export-btn, #to-transpose-btn, #transpose-btn, #recognize-btn {
      position: relative;
      z-index: 10;
      cursor: pointer;
      padding: 8px 16px;
      background: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 10px;
    }
    
    /* 確保疊圖中的標籤不會攔截點擊事件 */
    .overlay-stage .tag {
      pointer-events: none;
    }
    .overlay-stage:hover .tag {
      pointer-events: auto;
    }
    
    /* 上傳區域與檔案預覽樣式 */
    .upload-area {
      border: 2px dashed #22c3ee;
      border-radius: 10px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .upload-area:hover {
      background-color: #f0f9ff;
      border-color: #0891b2;
    }
    .upload-area .upload-icon {
      margin: 0 auto 15px;
    }

    /* 工作區提示文字 */
    .workspace-hint {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #0891b2;
      font-size: 18px;
    }

    /* 檔案預覽樣式 */
    .file-preview-area {
      margin: 20px 0;
      border-radius: 10px;
      overflow: hidden;
      background: #f8f8f8;
    }
    .file-info {
      padding: 10px 15px;
      background: #e0f2fe;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .file-name {
      font-weight: bold;
      color: #0891b2;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .file-size {
      color: #555;
      font-size: 0.9em;
    }
    .preview-container {
      padding: 15px;
      text-align: center;
      overflow: hidden; /* 確保溢出的內容被隱藏 */
      min-height: 600px; /* 提供足夠的空間給放大後的圖片 */
    }
    .preview-container img {
      max-width: 100%;  /* 保持寬度適應容器 */
      max-height: 600px; /* 從原本的 300px 放大到 600px */
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: scale(2); /* 加入縮放效果 */
      transform-origin: center top; /* 從中央頂部開始縮放 */
      margin: 80px 0; /* 增加上下邊距以容納放大的內容 */
    }

    /* 按鈕樣式統一 */
    #recognize-btn, #to-transpose-btn, #transpose-btn, #to-export-btn {
      background-color: #22c3ee;
      color: white;
      border: none;
      border-radius: 25px;
      padding: 10px 20px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 15px;
    }
    #recognize-btn:hover, #to-transpose-btn:hover, #transpose-btn:hover, #to-export-btn:hover {
      background-color: #0891b2;
    }
    #recognize-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    /* 辨識編輯分頁樣式 */
    .recognition-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 20px;
    }
    .recognition-compare-area {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }
    .original-image-container,
    .recognition-result-container {
      flex: 1;
      min-width: 0;
    }
    .recognition-result-area {
      flex: 3;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .edit-panel {
      width: 100%;
      background: #f8f8f8;
      border-radius: 10px;
      padding: 15px;
    }
    #text-editor {
      width: 100%;
      min-height: 600px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
    }
    .original-image-container,
    .recognition-result-container {
      flex: 1;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      gap: 8px; /* 內部元素間距，避免與下方框線視覺貼合 */
    }
    .original-image-container h3,
    .recognition-result-container h3 {
      margin-top: 0;
      color: #0891b2;
      font-size: 18px;
      margin-bottom: 10px;
    }
    #recognition-status {
      font-size: 14px;
      color: #888;
      font-weight: normal;
    }
    .recognition-controls {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    .overlay-container {
      flex: 1;
      position: relative;
      border: 1px dashed #ccc;
      background-color: #fcfcfc;
      overflow: auto;
    }
    .edit-tools {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }
    .edit-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: #e0f2fe;
      color: #0891b2;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
    }
    .edit-btn:hover {
      background-color: #bae6fd;
    }
    .edit-options {
      margin-top: 15px;
      padding: 12px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .edit-option {
      margin-bottom: 12px;
    }
    .edit-option label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-size: 14px;
    }
    .edit-option select, 
    .edit-option input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .edit-actions {
      display: flex;
      gap: 10px;
    }
    .edit-action-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 4px;
      background-color: #22c3ee;
      color: white;
      cursor: pointer;
    }
    .edit-action-btn.danger {
      background-color: #ff6b6b;
    }
    .edit-action-btn:hover {
      opacity: 0.9;
    }
    .edit-help {
      background: #f0f9ff;
      border-radius: 8px;
      padding: 12px;
      margin-top: 20px;
    }
    .edit-help h4 {
      margin-top: 0;
      color: #0891b2;
      font-size: 16px;
      margin-bottom: 8px;
    }
    .edit-help ul {
      margin: 0;
      padding-left: 20px;
      color: #555;
    }
    .edit-help li {
      margin-bottom: 6px;
      font-size: 14px;
    }
    .action-btn {
      padding: 10px 20px;
      border-radius: 25px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    .action-btn.primary {
      background-color: #22c3ee;
      color: white;
    }
    .action-btn.secondary {
      background-color: #e0f2fe;
      color: #0891b2;
      border: 1px solid #bae6fd;
    }
    .action-btn:hover {
      opacity: 0.9;
    }
    /* 和弦與歌詞的可編輯樣式 */
    .tag.editable {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .tag.editable:hover {
      box-shadow: 0 0 0 2px rgba(34, 195, 238, 0.5);
    }
    .tag.editable.selected {
      box-shadow: 0 0 0 3px #22c3ee;
    }
    .tag.chord.editable {
      border: 1px dashed #ffd700;
    }
    .tag.lyric.editable {
      border: 1px dashed #22c3ee;
    }
    /* 新增項目的提示樣式 */
    .add-item-hint {
      position: absolute;
      background-color: rgba(34, 195, 238, 0.1);
      border: 2px dashed #22c3ee;
      padding: 15px;
      border-radius: 8px;
      color: #0891b2;
      font-size: 14px;
      text-align: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .overlay-container.edit-mode:hover .add-item-hint {
      opacity: 1;
    }

    /* 辨識編輯頁面並排顯示樣式 */
    .recognition-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 20px;
    }

    /* 原始圖與辨識結果並排 */
    .recognition-compare-area {
      display: flex;
      gap: 20px;
      width: 100%;
      align-items: stretch; /* 兩側等高 */
    }

    .original-image-container,
    .recognition-result-container {
      flex: 1;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
      min-height: 400px;
      display: flex;
      flex-direction: column;
    }

    .original-image-container h3,
    .recognition-result-container h3 {
      margin-top: 0;
      color: #0891b2;
      font-size: 18px;
      margin-bottom: 10px;
    }

    /* 圖片容器樣式 */
    .image-container {
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .image-container img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    /* 左側原始圖片：使用原尺寸，超出則顯示捲軸 */
    .original-image-container .image-container {
      align-items: flex-start;
      justify-content: flex-start;
      overflow: auto;
    }
    /* 模式一：適應寬度（預設） */
    .original-image-container .image-container.fit-width img,
    .original-image-container .image-container.fit-width canvas {
      width: 100%;
      height: auto;
      max-width: 100%;
      object-fit: contain;
      display: block;
    }
    /* 模式二：原尺寸 */
    .original-image-container .image-container.actual-size img,
    .original-image-container .image-container.actual-size canvas {
      max-width: none;
      max-height: none;
      width: auto;
      height: auto;
      object-fit: initial;
      display: block;
      flex: 0 0 auto; /* 避免被 flex 縮放 */
    }

    /* 辨識結果容器 */
    .overlay-container {
      flex: 1;
      position: relative;
      border: 1px dashed #ccc;
      background-color: #fcfcfc;
      overflow: auto;
    }

    /* 編輯面板置於下方 */
    .edit-panel {
      width: 100%;
      background: #f8f8f8;
      border-radius: 10px;
      padding: 15px;
    }

    /* 工具列排成水平 */
    .edit-tools {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* 可編輯標籤樣式 */
    .tag.editable {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tag.editable:hover {
      box-shadow: 0 0 0 2px rgba(34, 195, 238, 0.5);
    }

    .tag.editable.selected {
      box-shadow: 0 0 0 3px #22c3ee;
    }
    .tag.chord.editable {
      border: 1px dashed #ffd700;
    }
    .tag.lyric.editable {
      border: 1px dashed #22c3ee;
    }
    /* 文字模式切換列 */
    .result-mode-switch { display:flex; gap:8px; align-items:center; margin:6px 0 10px; }
    .mode-btn {
      padding:6px 10px; border:1px solid #bae6fd; border-radius:9999px;
      background:#e0f2fe; color:#0891b2; font-weight:700; cursor:pointer;
    }
    .mode-btn.active { background:#22c3ee; color:#fff; border-color:#22c3ee; }

    /* 純文字編輯器 */
    #text-editor-wrap {
      margin-top:8px;
      margin-bottom:8px;
      display:flex;
      flex-direction:column;
      flex:1;           /* 佔滿右側容器剩餘高度 */
      min-height:0;     /* 允許內部子項縮放 */
    }
    #text-editor {
      width:100%;
      /* 在 flex 佈局下以 flex 撐滿，不再用內容自動高度 */
      flex: 1 1 auto;
      min-height:0;
      height:auto;
      resize:vertical; /* 可手動拉高，若需嚴格等高可移除此設定 */
      white-space:pre;
      line-height:1.6;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      border:1px solid #e5e7eb;
      border-radius:8px;
      padding:10px;
      background:#fff;
      overflow-y:auto;
      box-sizing: border-box;
      /* 取消先前的 max-height 限制，讓其等高於左側容器 */
    }

  /* 文字工具列 */
    .text-tools { display:flex; gap:8px; justify-content:flex-end; margin:6px 0; }
    .tool-btn { padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; font-size:12px; }
    .tool-btn:hover { background:#f3f4f6; }
    .tool-btn.primary { background:#22c3ee; color:#fff; border-color:#22c3ee; }
  /* 只保留複製按鈕，其他隱藏 */
  .text-tools .tool-btn:not(#copy-text) { display:none !important; }

  /* 匯出預覽樣式 */
  .export-toolbar { display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap; }
  .export-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:8px; background:#fff; cursor:pointer; }
  .export-btn.primary { background:#10b981; border-color:#10b981; color:#fff; }
  #export-canvas-wrap { border:1px solid #e5e7eb; border-radius:8px; background:#fff; padding:16px; overflow:auto; }
  #export-preview { white-space:pre; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; line-height:1.6; color:#111; }

  /* 新增：卡片與版面容器（Step B） */
  .app-section-wrapper {max-width:var(--layout-max);margin:0 auto;padding:20px 32px 80px;}
  .section-title {font-size:28px;font-weight:600;letter-spacing:-.5px;margin:0 0 24px;color:#1d1d1f;}
  .panel-modern {background:var(--color-surface);border:1px solid var(--color-border);border-radius:24px;padding:32px;box-shadow:var(--shadow-sm);margin-bottom:48px;}
  .panel-modern.small-pad {padding:20px 24px;}
  .layout-split {display:grid;gap:40px;grid-template-columns:1fr 420px;align-items:start;}
  .layout-split .side-sticky {position:sticky;top:88px;align-self:start;}
  @media (max-width:1180px){.layout-split{grid-template-columns:1fr;} .layout-split .side-sticky{position:static;}}
  .paper-surface {background:#fff;border:1px solid var(--color-border);border-radius:16px;padding:20px;box-shadow:0 2px 6px rgba(0,0,0,.04);} 
  .subtle-label {font-size:12px;color:var(--color-text-secondary);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;display:block;}

  /* Gemini API Key 卡片（僅保留狀態與按鈕） */
  .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
  .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
  .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
  .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
  .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
  #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
  #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* 新增的樣式區域 */
    /* 安全預編譯：單一來源，避免字串拼接遺失跳脫 */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* 通用樣式 */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* 按鈕樣式 */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans);
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var(--ease-standard),
                  color var(--dur-base) var(--ease-standard),
                  box-shadow var(--dur-fast) var,--ease-standard),
                  border-color var,--dur-base;
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    .btn.small { padding: 6px 12px; font-size: 13px; }

  /* Gemini API Key 卡片（僅保留狀態與按鈕） */
  .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
  .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
  .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
  .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
  .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
  #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
  #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* 新增的樣式區域 */
    /* 安全預編譯：單一來源，避免字串拼接遺失跳脫 */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* 通用樣式 */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* 按鈕樣式 */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans);
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var(--ease-standard),
                  color var(--dur-base) var,--ease-standard),
                  box-shadow var,--dur-fast) var,--ease-standard),
                  border-color var,--dur-base;
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    .btn.small { padding: 6px 12px; font-size: 13px; }

    /* Gemini API Key 卡片 */
    .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    #gemini-api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* 新增的樣式區域 */
    /* 安全預編譯：單一來源，避免字串拼接遺失跳脫 */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* 通用樣式 */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* 按鈕樣式 */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans);
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var,--ease-standard),
                  color var,--dur-base) var,--ease-standard),
                  box-shadow var,--dur-fast) var,--ease-standard),
                  border-color var,--dur-base;
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    .btn.small { padding: 6px 12px; font-size: 13px; }

    /* Gemini API Key 卡片 */
    .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    #gemini-api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* 新增的樣式區域 */
    /* 安全預編譯：單一來源，避免字串拼接遺失跳脫 */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* 通用樣式 */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* 按鈕樣式 */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans);
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var,--ease-standard),
                  color var,--dur-base) var,--ease-standard),
                  box-shadow var,--dur-fast) var,--ease-standard),
                  border-color var,--dur-base;
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    .btn.small { padding: 6px 12px; font-size: 13px; }

    /* Gemini API Key 卡片 */
    .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    #gemini-api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* 新增的樣式區域 */
    /* 安全預編譯：單一來源，避免字串拼接遺失跳脫 */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* 通用樣式 */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* 按鈕樣式 */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans);
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var,--ease-standard),
                  color var,--dur-base) var,--ease-standard),
                  box-shadow var,--dur-fast) var,--ease-standard),
                  border-color var,--dur-base;
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    .btn.small { padding: 6px 12px; font-size: 13px; }

    /* Gemini API Key 卡片 */
    .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    #gemini-api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* 新增的樣式區域 */
    /* 安全預編譯：單一來源，避免字串拼接遺失跳脫 */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* 通用樣式 */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* 按鈕樣式 */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans);
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var,--ease-standard),
                  color var,--dur-base) var,--ease-standard),
                  box-shadow var,--dur-fast) var,--ease-standard),
                  border-color var,--dur-base;
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    .btn.small { padding: 6px 12px; font-size: 13px; }

    /* Gemini API Key 卡片 */
    .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    #gemini-api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* 新增的樣式區域 */
    /* 安全預編譯：單一來源，避免字串拼接遺失跳脫 */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* 通用樣式 */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* 按鈕樣式 */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans;
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var,--ease-standard),
                  color var,--dur-base) var,--ease-standard),
                  box-shadow var,--dur-fast) var,--ease-standard),
                  border-color var,--dur-base;
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    .btn.small { padding: 6px 12px; font-size: 13px; }

    /* Gemini API Key 卡片 */
    .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    #gemini-api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* 新增的樣式區域 */
    /* 安全預編譯：單一來源，避免字串拼接遺失跳脫 */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* 通用樣式 */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* 按鈕樣式 */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans;
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var,--ease-standard),
                  color var,--dur-base) var,--ease-standard),
                  box-shadow var,--dur-fast) var,--ease-standard),
                  border-color var,--dur-base;
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    .btn.small { padding: 6px 12px; font-size: 13px; }

    /* Gemini API Key 卡片 */
    .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    #gemini-api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* 新增的樣式區域 */
    /* 安全預編譯：單一來源，避免字串拼接遺失跳脫 */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* 通用樣式 */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* 按鈕樣式 */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans;
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var,--ease-standard),
                  color var,--dur-base) var,--ease-standard),
                  box-shadow var,--dur-fast) var,--ease-standard),
                  border-color var,--dur-base;
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    .btn.small { padding: 6px 12px; font-size: 13px; }

    /* Gemini API Key 卡片 */
    .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    #gemini-api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* 新增的樣式區域 */
    /* 安全預編譯：單一來源，避免字串拼接遺失跳脫 */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* 通用樣式 */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* 按鈕樣式 */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans;
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var,--ease-standard),
                  color var,--dur-base) var,--ease-standard),
                  box-shadow var,--dur-fast) var,--ease-standard),
                  border-color var,--dur-base;
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    .btn.small { padding: 6px 12px; font-size: 13px; }

    /* Gemini API Key 卡片 */
    .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    #gemini-api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* 新增的樣式區域 */
    /* 安全預編譯：單一來源，避免字串拼接遺失跳脫 */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* 通用樣式 */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* 按鈕樣式 */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans;
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var,--ease-standard),
                  color var,--dur-base) var,--ease-standard),
                  box-shadow var,--dur-fast) var,--ease-standard),
                  border-color var,--dur-base;
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    .btn.small { padding: 6px 12px; font-size: 13px; }

    /* Gemini API Key 卡片 */
    .apikey-card { border:1px solid #e7eaf0; border-radius:10px; padding:12px; margin:14px 0; background:#f9fafb; }
    .apikey-card h3 { margin:0 0 8px; font-size:16px; color:#374151; }
    .apikey-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    #gemini-api-key { flex:1; min-width:280px; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; }
    .key-btn, #recognize-ai-btn { padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; background:#fff; cursor:pointer; }
    .key-btn:hover, #recognize-ai-btn:hover { background:#f3f4f6; }
    #recognize-ai-btn.primary { background:#10b981; color:#fff; border-color:#10b981; }
    #gemini-status { font-size:12px; color:#6b7280; min-height:18px; }

    /* 新增的樣式區域 */
    /* 安全預編譯：單一來源，避免字串拼接遺失跳脫 */
    .chord-token-re {
      display: none;
    }
    .chord-line-re {
      display: none;
    }

    /* 通用樣式 */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background-color: #f5f5f7;
      color: #333;
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0;
      color: #0891b2;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 22px;
      margin-bottom: 8px;
    }
    h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    p {
      margin: 0 0 10px;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    /* 按鈕樣式 */
    .btn {
      --btn-bg: var(--color-surface);
      --btn-color: var(--color-text);
      --btn-border: var(--color-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font: var(--font-weight-semibold) var(--fs-body)/1.2 var(--font-sans;
      padding: 10px 18px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--dur-base) var,--ease-standard),
                  color var,--dur-base) var,--ease-standard),
                  box-shadow var,--dur-fast) var,--ease-standard),
                  border-color var,--dur-base;
    }
    .btn:hover {
      background: var(--color-surface-alt);
    }
    .btn:focus-visible {
      outline: none;
      box-shadow: var(--shadow-focus);
    }
    .btn.primary {
      --btn-bg: var(--color-accent);
      --btn-color: #fff;
      --btn-border: var(--color-accent);
    }
    .btn.primary:hover {
      background: var(--color-accent-hover);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid transparent;
    }
    .btn.ghost:hover {
      background: rgba(0,0,0,.06);
    }

    /* ---- Upload 首頁顯示安全補丁 ---- */
  </style>
  <body>
      <style>
        /* 水平流程版型 */
        #flow-container{position:relative;width:100%;overflow:hidden;max-width:var(--layout-max);margin:0 auto;padding:0 32px;}
  /* 水平流程：加入 gap 產生各面板左右分隔陰影縫隙 */
  .flow-track{display:flex;transition:transform .6s var(--ease-emphasized);will-change:transform;gap:10px;padding:0 4px;}
  /* 每個頁面寬度扣除 gap 重新計算：使用 calc 讓 translateX 還是以 100% chunk 運作 */
  .flow-page{flex:0 0 calc(100% - 40px);padding:8px 0 96px;box-sizing:border-box;}
        .flow-page-inner{height:100%;}
        .flow-nav-inline{display:flex;gap:12px;margin:8px 0 24px;}
        .flow-nav-inline button{padding:6px 14px;border:1px solid var(--color-border);background:#fff;border-radius:8px;cursor:pointer;font:500 13px var(--font-sans);} 
        .flow-nav-inline button.active{background:var(--color-accent);color:#fff;}
      </style>
    <!-- 分頁導覽列 -->
  <!-- UI 調整：加入頂部 20px 間距，符合需求 1 -->
  <nav id="app-tabs" style="max-width:var(--layout-max);margin:20px auto 8px;padding:0 32px;display:flex;gap:8px;justify-content:center;">
      <button class="tab-btn-modern" data-view="upload" aria-selected="true">上傳</button>
      <button class="tab-btn-modern" data-view="recognition" aria-selected="false">辨識</button>
      <button class="tab-btn-modern" data-view="transpose" aria-selected="false">移調</button>
      <button class="tab-btn-modern" data-view="export" aria-selected="false">匯出</button>
    </nav>
    <style>
  /* UI 調整：按鈕改為長方框圓角 (需求 2) */
  .tab-btn-modern{flex:0 0 auto;padding:10px 22px;border:1px solid var(--color-border);background:#fff;border-radius:14px;font:500 14px var(--font-sans);cursor:pointer;transition:background .25s, color .25s, box-shadow .25s;}
      .tab-btn-modern[aria-selected="true"]{background:var(--color-accent);color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.15);} 
      .tab-btn-modern:not([aria-selected="true"]):hover{background:var(--color-surface-alt);} 
      /* 轉場動畫 */
      .view-panel-enter{opacity:0;transform:translateY(12px);}
      .view-panel-active{opacity:1;transform:translateY(0);transition:opacity .38s var(--ease-standard),transform .38s var(--ease-standard);} 
  /* UI 調整：統一各頁面高度，並預留下方空白；min-height 以視窗高度計算 (需求 3 部分) */
  .flow-page{min-height:calc(100vh - 160px);} /* 160px 約略扣掉導覽與內邊距，必要時再微調 */
  #flow-container .panel-modern{margin-top:32px;} /* 調整：面板間距 32px (由 10px 提升) */
    </style>
    <div id="flow-container">
      <div class="flow-track" id="flow-track">
  <!-- 移除內嵌 margin-top:8px; 交由全域 #flow-container .panel-modern 控制 32px 間距 -->
  <section id="upload-section" class="flow-page"><div class="flow-page-inner app-section-wrapper panel-modern">
      <h2 class="section-title" style="margin-top:0;">上傳樂譜</h2>
      <p style="color:var(--color-text-secondary);max-width:640px;">選擇圖片或 PDF，後續可使用 AI 進行和弦 / 歌詞辨識，並進入移調與匯出流程。</p>
      <div style="margin-top:28px;display:flex;gap:32px;flex-wrap:wrap;align-items:flex-start;">
        <div class="paper-surface" style="flex:1 1 320px;min-width:300px;">
          <label class="upload-btn" style="margin-bottom:14px;">
            <input type="file" id="file-input" hidden accept="image/*,.pdf,text/plain,.txt,.md" />
            <span>選擇檔案</span>
          </label>
          <div style="display:flex;flex-direction:column;gap:10px;margin:8px 0 4px;">
            <input id="api-key" type="password" placeholder="輸入 Gemini API Key" style="padding:8px 10px;border:1px solid var(--color-border);border-radius:8px;font:14px var(--font-sans);">
            
            <select id="gemini-model-select" style="padding:8px 10px;border:1px solid var(--color-border);border-radius:8px;font:14px var(--font-sans);background:#fff;">
              <option value="gemini-3.0-pro">Gemini 3.0 Pro (Latest)</option>
              <option value="gemini-2.0-flash">Gemini 2.0 Flash (Fast)</option>
              <option value="gemini-1.5-flash">Gemini 1.5 Flash (Stable)</option>
              <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
            </select>

            <label style="font-size:11px;color:var(--color-text-secondary);display:flex;align-items:center;gap:4px;">
              <input type="checkbox" id="use-gemini-ai" checked style="margin:0;transform:scale(.9);" /> 啟用 Gemini (測試)
            </label>
            <label style="font-size:12px;color:var(--color-text-secondary);display:flex;align-items:center;gap:6px;">
              <input type="checkbox" id="show-key" style="margin:0;"> 顯示金鑰
            </label>
          </div>
          <div id="upload-hint" style="font-size:13px;color:var(--color-text-secondary);line-height:1.5;">支援 JPG / PNG / PDF / TXT。選擇後可於上方 Hero 預覽，並啟用 AI 辨識。</div>
          <div style="margin-top:18px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <button id="recognize-btn-secondary" class="btn-primary" disabled>AI 辨識</button>
            <!-- 測試相容主按鈕 alias -->
            <button id="recognize-ai-btn" style="display:none;" disabled>AI 辨識</button>
            <span id="gemini-status" style="font-size:12px;color:var(--color-text-secondary);"></span>
          </div>
          <pre id="recognize-output" style="background:#111;color:#f5f5f7;padding:12px;border-radius:12px;font-size:12px;line-height:1.4;max-height:260px;overflow:auto;display:none;margin-top:16px;white-space:pre-wrap;"></pre>
        </div>
        <div id="upload-preview-box" class="paper-surface" style="flex:1 1 420px;min-height:280px;display:flex;align-items:center;justify-content:center;position:relative;">
          <div id="upload-preview-empty" style="text-align:center;color:var(--color-text-secondary);font-size:14px;">
            <div style="font-size:46px;opacity:.15;">🎼</div>
            尚未選擇檔案
          </div>
        </div>
        </div></div></section>
              <section id="recognition-section" class="flow-page"><div class="flow-page-inner app-section-wrapper panel-modern">
            <h2 class="section-title" style="margin-top:0;">AI 辨識結果編輯</h2>
            <div style="display:flex;flex-wrap:wrap;gap:20px;margin:4px 0 28px;align-items:flex-end;">
              <div style="flex:2 1 320px;min-width:260px;display:flex;flex-direction:column;gap:6px;">
                <label class="subtle-label" for="song-title">歌譜標題</label>
                <input id="song-title" placeholder="(AI 解析後自動填入，可修改)" style="padding:10px 12px;border:1px solid var(--color-border);border-radius:12px;font:14px var(--font-sans);" />
              </div>
              <div style="flex:0 0 140px;display:flex;flex-direction:column;gap:6px;">
                <label class="subtle-label" for="from-key">偵測調性</label>
                <input id="detected-key" placeholder="--" title="可手動修正調性 (例如: Bb, F#, Eb)" style="padding:10px 12px;border:1px solid var(--color-border);border-radius:12px;font:14px var(--font-sans);width:100%;" />
              </div>
            </div>
            <div style="display:flex;flex-direction:row;gap:32px;flex-wrap:wrap;align-items:stretch;">
              <div class="paper-surface" style="flex:1 1 380px;min-width:340px;max-height:520px;overflow:hidden;display:flex;flex-direction:column;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;gap:8px;">
                  <span class="subtle-label" style="margin:0;">原始影像</span>
                  <div id="zoom-controls" style="display:flex;gap:6px;">
                    <button type="button" class="btn small" data-zoom="fit" title="適應寬度">適應寬</button>
                    <button type="button" class="btn small" data-zoom="actual" title="原尺寸滾動">原尺寸</button>
                  </div>
                </div>
                <div id="recognition-original" class="zoom-fit" style="border:1px solid var(--color-border);border-radius:12px;min-height:320px;flex:1 1 auto;display:flex;align-items:flex-start;justify-content:flex-start;overflow:auto;background:#fff;">
                  <div style="text-align:center;color:var(--color-text-secondary);font-size:13px;">尚未載入</div>
                </div>
              </div>
              <div class="paper-surface" style="flex:2 1 520px;min-width:380px;display:flex;flex-direction:column;">
                <span class="subtle-label">文字編輯</span>
                <div id="text-editor-wrap">
                  <textarea id="text-editor" placeholder="等待 AI 辞識結果..." spellcheck="false"></textarea>
                </div>
                <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-end;margin-top:16px;">
                  <button class="btn ghost" id="back-to-upload">返回上傳</button>
                  <button class="btn primary" id="go-to-transpose" disabled>前往移調 ▶</button>
                </div>
              </div>
            </div>
              </div></section>
              <section id="transpose-section" class="flow-page"><div class="flow-page-inner app-section-wrapper panel-modern">
            <h2 class="section-title" style="margin-top:0;">移調設定</h2>
            <div style="display:flex;flex-wrap:wrap;gap:32px;align-items:flex-start;">
              <div class="paper-surface" style="flex:1 1 320px;min-width:300px;display:flex;flex-direction:column;gap:18px;">
                <div>
                  <label class="subtle-label">原調</label>
                  <select id="from-key" style="padding:8px 10px;border:1px solid var(--color-border);border-radius:8px;">
                    <option>C</option><option>C#</option><option>D</option><option>Eb</option><option>E</option><option>F</option><option>F#</option><option>G</option><option>Ab</option><option>A</option><option>Bb</option><option>B</option>
                  </select>
                </div>
                <div>
                  <label class="subtle-label">目標調</label>
                  <select id="to-key" style="padding:8px 10px;border:1px solid var(--color-border);border-radius:8px;">
                    <option>C</option><option>C#</option><option>D</option><option>Eb</option><option>E</option><option>F</option><option>F#</option><option>G</option><option>Ab</option><option>A</option><option>Bb</option><option>B</option>
                  </select>
                </div>
                <button class="btn primary" id="do-transpose" disabled>執行移調</button>
                <div style="font-size:12px;color:var(--color-text-secondary);line-height:1.5;">僅對「看起來像和弦」的 token 進行轉調，歌詞與其它符號不變。</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  <button class="btn ghost" id="transpose-back">◀ 返回編輯</button>
                  <button class="btn" id="transpose-finish" disabled>前往匯出 ▶</button>
                </div>
              </div>
              <div class="paper-surface" style="flex:2 1 520px;min-width:380px;display:flex;flex-direction:column;">
                <span class="subtle-label">移調後內容</span>
                  <textarea id="transpose-output" class="big-textarea" placeholder="尚未移調"></textarea>
              </div>
            </div>
          </div>
        </div></section>
        <section id="export-section" class="flow-page"><div class="flow-page-inner app-section-wrapper panel-modern">
      <h2 class="section-title" style="margin-top:0;">匯出</h2>
      <div style="display:flex;flex-wrap:wrap;gap:32px;align-items:flex-start;">
        <div class="paper-surface" style="flex:1 1 100%;min-width:620px;display:flex;flex-direction:column;">
          <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between;margin-bottom:8px;">
            <span class="subtle-label">匯出預覽（使用移調後內容，若無則原始辨識）</span>
            <label style="font-size:12px;color:var(--color-text-secondary);display:inline-flex;align-items:center;gap:6px;">
              <input type="checkbox" id="export-bold-toggle" /> 粗體
            </label>
            <label style="font-size:12px;color:var(--color-text-secondary);display:inline-flex;align-items:center;gap:6px;">
              <input type="checkbox" id="export-mono-toggle" checked /> 等寬字型
            </label>
          </div>
          <textarea id="export-preview-text" class="big-textarea" placeholder="尚未有內容" style="font-family:'Microsoft JhengHei','微軟正黑體','Noto Sans TC','PingFang TC','Segoe UI',Arial,sans-serif;"></textarea>
          <div id="export-info"></div>
          <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-end;margin-top:16px;">
            <button class="btn" id="export-refresh">重新載入內容</button>
            <button class="btn primary" id="export-download-png">下載 PNG</button>
            <button class="btn" id="export-download-jpg">下載 JPG</button>
            <button class="btn" id="export-download-txt">下載 TXT</button>
            <button class="btn primary" id="export-download-pdf">下載 PDF</button>
          </div>
        </div>
      </div>
        </div></section>
      </div>
    </div>
  <script>
        // 提前載入合併後處理工具（以便下方 formatDisplay 可使用）
      </script>
      <script type="module" src="assets/js/chordUtils.js"></script>
      <script>
    (function(g,d){
      // 全域共享文字狀態（單一真實來源）
      if(!g.__CHORD_TEXT_STATE__){ g.__CHORD_TEXT_STATE__={ text:'', source:'', updatedAt:0 }; }
      g.getSharedText = function(){ return g.__CHORD_TEXT_STATE__?.text || ''; };
      g.setSharedText = function(text, source){ try{ g.__CHORD_TEXT_STATE__={ text:String(text??''), source:source||g.__CHORD_TEXT_STATE__.source||'', updatedAt:Date.now() }; }catch(_){ } };
      if(!g.__onEnterView){ g.__onEnterView = {}; }
      // 錯誤監聽（防止靜默失敗）
      if(!g.__UI_ERR_TRAP__){
        g.__UI_ERR_TRAP__=true;
        g.addEventListener('error',e=>{
          console.warn('[InitError]', e.message, e.filename+':'+e.lineno);
          const box = d.getElementById('gemini-status') || d.querySelector('[data-role="status"]');
          if(box) box.textContent = '初始化錯誤：' + e.message;
        });
      }

    // 若 switchView 缺失 → 建立簡易版
    // 移除舊版 switchView (hidden) 保留新水平切換

    // 初始定位到第一頁
    g.switchView && g.switchView('upload');

      // --- 新增：上傳預覽與 Hero/次按鈕同步邏輯 ---
      function isTextLikeFile(file){
        if(!file) return false;
        const type = (file.type || '').toLowerCase();
        if(type.startsWith('text/')) return true;
        const name = (file.name || '').toLowerCase();
        return ['.txt','.md','.lyrics','.chord','.cho'].some(ext=> name.endsWith(ext));
      }
      function escapeHtml(str){
        return String(str).replace(/[&<>"']/g, ch => ({
          '&':'&amp;',
          '<':'&lt;',
          '>':'&gt;',
          '"':'&quot;',
          "'":'&#39;'
        })[ch] || ch);
      }
      async function renderPdfFirstPage(file){
        try {
          const base='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67';
          const pdfjsUrl = base + '/pdf.min.mjs';
          const workerUrl = base + '/pdf.worker.min.mjs';
          const pdfjs = await import(pdfjsUrl);
          try { if(pdfjs?.GlobalWorkerOptions) pdfjs.GlobalWorkerOptions.workerSrc = workerUrl; } catch(_) {}
          const pdfData = await file.arrayBuffer();
          let pdf;
          try { pdf = await pdfjs.getDocument({ data: pdfData }).promise; }
          catch(firstErr){
            try { if(pdfjs?.GlobalWorkerOptions) pdfjs.GlobalWorkerOptions.workerSrc=''; pdf = await pdfjs.getDocument({ data: pdfData, useWorkerFetch:false }).promise; }
            catch(secondErr){ throw firstErr; }
          }
          const page = await pdf.getPage(1);
          const viewport = page.getViewport({ scale: 1.25 });
          const canvas=document.createElement('canvas');
          const ctx=canvas.getContext('2d');
          canvas.width=viewport.width; canvas.height=viewport.height;
          await page.render({ canvasContext: ctx, viewport }).promise;
          return canvas.toDataURL('image/png');
        } catch(err){ console.warn('[PDF 預覽失敗]', err); return null; }
      }
      async function syncPreview(file){
        const heroBox = d.getElementById('hero-preview');
        const uploadBox = d.getElementById('upload-preview-box');
        const empty1 = d.getElementById('upload-preview-empty');
        if(!file){
          empty1 && (empty1.style.display='');
          if(heroBox) heroBox.innerHTML = '<div class="hero__placeholder"><div style="font-size:46px;opacity:.12;">🎼</div><span>等待上傳樂譜影像</span></div>';
          if(uploadBox) uploadBox.innerHTML = '<div id="upload-preview-empty" style="text-align:center;color:var(--color-text-secondary);font-size:14px;"><div style="font-size:46px;opacity:.15;">🎼</div>尚未選擇檔案</div>';
          return;
        }
        let imgHTML='';
        if(isTextLikeFile(file)){
          try{
            const raw = await file.text();
            const previewLength = 2000;
            const snippet = raw.slice(0, previewLength);
            const sanitized = escapeHtml(snippet);
            const ellipsis = raw.length > previewLength ? '\n...' : '';
            const block = `<pre style="font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,'Liberation Mono',monospace;font-size:13px;line-height:1.45;white-space:pre-wrap;margin:0;">${sanitized}${ellipsis}</pre>`;
            if(heroBox){
              heroBox.innerHTML = `<div style="padding:18px;width:100%;height:100%;overflow:auto;">${block}</div>`;
            }
            if(uploadBox){
              uploadBox.innerHTML = `<div style="padding:18px;max-height:360px;overflow:auto;">${block}</div>`;
            }
          }catch(err){
            console.warn('[text preview fail]', err);
            if(heroBox) heroBox.innerHTML = '<div style="padding:24px;color:var(--color-text-secondary);font-size:13px;">無法預覽此文字檔</div>';
            if(uploadBox) uploadBox.innerHTML = '<div style="padding:24px;color:var(--color-text-secondary);font-size:13px;">無法預覽此文字檔</div>';
          }
          return;
        }
        if(file.type==='application/pdf'){
          if(heroBox) heroBox.innerHTML = '<div style="padding:24px;text-align:center;font-size:13px;color:var(--color-text-secondary);">PDF 載入中...</div>';
          if(uploadBox) uploadBox.innerHTML = '<div style="padding:24px;text-align:center;font-size:13px;color:var(--color-text-secondary);">PDF 載入中...</div>';
          const dataUrl = await renderPdfFirstPage(file);
          if(dataUrl){ imgHTML = `<img src="${dataUrl}" alt="pdf page 1" style="max-width:100%;height:auto;display:block;">`; g.__PDF_FIRST_PAGE_DATAURL__=dataUrl; }
          else { imgHTML='<div style="text-align:center;color:var(--color-text-secondary);font-size:13px;">PDF 預覽失敗，辨識時仍可上傳原檔。</div>'; }
        } else {
          const url = URL.createObjectURL(file);
          imgHTML = `<img src="${url}" alt="preview" style="max-width:100%;height:auto;display:block;">`;
        }
        if(heroBox){
          heroBox.innerHTML = `<div style="padding:12px;width:100%;height:100%;display:flex;align-items:center;justify-content:center;">${imgHTML}</div>`;
        }
        if(uploadBox){
          uploadBox.innerHTML = `<div style="width:100%;">${imgHTML}</div>`;
        }
      }

      function enableRecognize(enable){
        const btn1 = d.getElementById('recognize-btn');
        const btn2 = d.getElementById('recognize-btn-secondary');
        const btn3 = d.getElementById('recognize-ai-btn');
        [btn1,btn2,btn3].forEach(b=>{ if(b){ b.disabled = !enable; if(!enable) b.setAttribute('disabled',''); else b.removeAttribute('disabled'); }});
      }

      const fi = d.getElementById('file-input');
      if(fi && !fi.__wired){
        fi.addEventListener('change', async ()=>{
          const f = fi.files && fi.files[0];
          const statusEl = d.getElementById('gemini-status');
          const out = d.getElementById('recognize-output');
          const editor = d.getElementById('text-editor');
          const goBtn = d.getElementById('go-to-transpose');
          const outArea = d.getElementById('transpose-output');
          const doTransBtn = d.getElementById('do-transpose');
          const finishBtn = d.getElementById('transpose-finish');
          const origImgBox = d.getElementById('recognition-original');
          if(goBtn) goBtn.setAttribute('disabled','');
          if(outArea) outArea.value='';
          if(doTransBtn){ doTransBtn.disabled=true; doTransBtn.setAttribute('disabled',''); }
          if(finishBtn){ finishBtn.disabled=true; finishBtn.setAttribute('disabled',''); }
          if(out){ out.textContent=''; out.style.display='none'; }
          if(editor) editor.value='';
          if(statusEl) statusEl.textContent='';
          if(origImgBox){ origImgBox.innerHTML = '<div style="text-align:center;color:var(--color-text-secondary);font-size:13px;">尚未載入</div>'; }
          if(!f){
            await syncPreview(null);
            enableRecognize(false);
            return;
          }
          await syncPreview(f);
          const isText = isTextLikeFile(f);
          enableRecognize(!isText);
          if(isText){
            await handleTextUpload(f);
          }
        });
        fi.__wired = true;
      }

      // 一開始檢查是否已有預先的檔案 URL（例如從上次狀態恢復）
      if(fi && fi.files && fi.files[0]){
        syncPreview(fi.files[0]);
        enableRecognize(true);
      }

      // === 分頁切換控制 ===
  g.switchView = function(view){
        const order=['upload','recognition','transpose','export'];
        const idx = order.indexOf(view);
        if(idx<0){ console.warn('[switchView] unknown view', view); return; }
        const track = d.getElementById('flow-track');
        // 自我修復：確保四頁都在 track 內
        if(track){ ['upload-section','recognition-section','transpose-section','export-section'].forEach(id=>{ const el=d.getElementById(id); if(el && el.parentElement!==track) track.appendChild(el); }); }
        if(track){
          const container = d.getElementById('flow-container');
          const gapValue = 40; // 與 .flow-track gap 保持一致
          const pages = track.querySelectorAll('.flow-page');
          if(container && pages.length){
            // 取得單頁實際寬度（calc 後結果）
            const pageWidth = pages[0].getBoundingClientRect().width;
            // 計算前面頁面總位移 (每頁寬 + gap)
            const offset = idx * (pageWidth + gapValue);
            // 置中調整：容器剩餘空間的一半
            const centerAdjust = (container.clientWidth - pageWidth)/2;
            track.style.transform = `translateX(${-(offset - centerAdjust)}px)`;
          } else {
            // 回退策略
            track.style.transform = `translateX(-${idx*100}%)`;
          }
        }
        // 上方圓角 tab aria-selected 同步
        d.querySelectorAll('#app-tabs .tab-btn-modern').forEach(btn=>{
          const active = btn.getAttribute('data-view')===view;
          btn.setAttribute('aria-selected', active?'true':'false');
        });
        try{ localStorage.setItem('chordapp.activeView',view);}catch(_){ }
        // 進入頁面時回填共享內容
        try{ if(g.__onEnterView && typeof g.__onEnterView[view]==='function'){ g.__onEnterView[view](); } }catch(_){ }
        if(view==='export'){
          try { refreshExportPreview(); } catch(e){ console.warn('[switchView] refresh export fail', e); }
        }
      };
      d.querySelectorAll('#app-tabs .tab-btn-modern').forEach(btn=>{
        if(btn.__wired) return; btn.addEventListener('click',()=>{ const v=btn.getAttribute('data-view'); g.switchView(v); }); btn.__wired=true; });
      // 初始化或還原上一次頁面
      (function(){
        let first='upload';
        try{ const last=localStorage.getItem('chordapp.activeView'); if(last) first=last; }catch(_){ }
        g.switchView(first);
      })();

      // 視窗改變時重新置中當前頁
      g.addEventListener('resize',()=>{
        try{
          const current = localStorage.getItem('chordapp.activeView')||'upload';
          g.switchView(current);
        }catch(_){ }
      });

      // 方向鍵快捷切換：改為 Shift+ArrowLeft/Right，避免影響文字編輯游標
      g.addEventListener('keydown', (e)=>{
        if(e.altKey || e.metaKey || e.ctrlKey) return;
        if(!(e.shiftKey && (e.key==='ArrowLeft' || e.key==='ArrowRight'))) return; // 必須同時按 Shift
        const activeEl = d.activeElement;
        // 即使在輸入框 / textarea 也允許切換，因為已按 Shift，並阻止預設避免選字
        const order=['upload','recognition','transpose','export'];
        const current = (localStorage.getItem('chordapp.activeView')||'upload');
        const idx = order.indexOf(current);
        if(e.key==='ArrowRight' && idx < order.length-1){ e.preventDefault(); g.switchView(order[idx+1]); }
        else if(e.key==='ArrowLeft' && idx>0){ e.preventDefault(); g.switchView(order[idx-1]); }
      });

      // === 匯出功能 ===
      function ensureExportLibs(){
        if(!g.html2canvas){
          const s=d.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js'; d.head.appendChild(s); }
        if(!g.jspdf){
          const s2=d.createElement('script'); s2.src='https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js'; d.head.appendChild(s2); }
      }
      function gatherCurrentContent(){
        // 不做 trim，完整保留空白與換行
        const transOut = d.getElementById('transpose-output')?.value;
        const editor = d.getElementById('text-editor')?.value;
        const raw = d.getElementById('recognize-output')?.textContent;
        return (transOut ?? editor ?? raw ?? '');
      }
      function refreshExportPreview(){
        const box = d.getElementById('export-preview-text');
        if(box){ box.value = gatherCurrentContent(); }
        // 檢視區字型/粗體改由共享樣式函式統一套用
        try{ if(typeof g.__applySharedTextStyle==='function') g.__applySharedTextStyle(); }catch(_){ }
        // 預檢統計
        try {
          const txt = box ? box.value : '';
          const lines = txt.split(/\n/).length;
            const chars = txt.length;
            // 簡易和弦 token 檢測 (大寫字母 + 可選 #/b + 可選 m / dim / aug / sus / 7 等)
            const chordMatches = txt.match(/\b([A-G](?:#|b)?(?:m|maj7|maj|dim|aug|sus2|sus4|add9|m7|7|m9|9|m6|6|dim7)?(?:\/[A-G](?:#|b)?)?)\b/g) || [];
            // PDF 預估頁數：假設一頁約 60 行（粗估）
            const estPages = Math.max(1, Math.ceil(lines / 60));
            const infoEl = d.getElementById('export-info');
            if(infoEl){
              infoEl.innerHTML = `字元數: ${chars} | 行數: ${lines} | 偵測和弦: ${chordMatches.length} | 預估 PDF 頁數: ${estPages}`;
            }
        } catch(err){ console.warn('[export preflight] fail', err); }
        ensureExportLibs();
      }
      const refreshBtn = d.getElementById('export-refresh');
      refreshBtn && !refreshBtn.__wired && (refreshBtn.addEventListener('click',refreshExportPreview), refreshBtn.__wired=true);
      const dlPng = d.getElementById('export-download-png');
      const dlTxt = d.getElementById('export-download-txt');
      const dlPdf = d.getElementById('export-download-pdf');
      function adjustExportWrapWidth(wrap){
        try{
          if(!wrap) return;
          const pre = wrap.querySelector('pre');
          if(!pre) return;
          const previewEl = d.getElementById('export-preview-text');
          const clampWidth = Math.max(1, previewEl ? previewEl.clientWidth : 860);
          const padding = 64; // wrap padding left + right (32px each side)
          const minWidth = 420;
          const originalDisplay = pre.style.display;
          const originalWidth = pre.style.width;
          wrap.style.width = 'auto';
          wrap.style.maxWidth = clampWidth + 'px';
          pre.style.display = 'inline-block';
          pre.style.width = 'auto';
          const contentWidth = pre.scrollWidth;
          const finalWidth = Math.min(clampWidth, Math.max(minWidth, Math.ceil(contentWidth + padding)));
          wrap.style.width = finalWidth + 'px';
          pre.style.display = originalDisplay || 'block';
          pre.style.width = originalWidth || '100%';
        }catch(err){ console.warn('[export width adjust] fail', err); }
      }
      function createExportWrap(text){
        const pre = d.createElement('pre');
        pre.textContent = text; // 保留所有空白與換行
        pre.style.margin='0';
        // 匯出時以當前偏好渲染：等寬/粗體
        const useMono = (d.getElementById('export-mono-toggle')?.checked !== false);
        const useBold = !!d.getElementById('export-bold-toggle')?.checked;
        pre.style.fontFamily = useMono ? 'ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace'
                                       : '"Microsoft JhengHei","微軟正黑體","Noto Sans TC","PingFang TC","Segoe UI",Arial,sans-serif';
        pre.style.fontSize='14px';
        pre.style.lineHeight='1.55';
        pre.style.fontWeight = useBold ? '700' : '400';
        pre.style.whiteSpace='pre';
        pre.style.tabSize='4';
        const wrap = d.createElement('div');
        // 以預覽框寬度匯出，避免因寬度不同造成換行差異
        const previewEl = d.getElementById('export-preview-text');
        const w = previewEl ? Math.max(1, previewEl.clientWidth) : 860;
        wrap.style.position='fixed';wrap.style.left='-9999px';wrap.style.top='0';wrap.style.width=w+'px';wrap.style.padding='32px';wrap.style.background='#fff';wrap.style.boxSizing='border-box';
        wrap.appendChild(pre);
        return wrap;
      }
      dlPng && !dlPng.__wired && (dlPng.addEventListener('click', async ()=>{
        refreshExportPreview(); await new Promise(r=>setTimeout(r,50));
        if(!g.html2canvas){alert('html2canvas 載入中，稍後再試');return;}
        const txt = d.getElementById('export-preview-text');
        const wrap = createExportWrap(txt.value);
        d.body.appendChild(wrap);
        adjustExportWrapWidth(wrap);
        const canvas = await g.html2canvas(wrap,{scale:2,backgroundColor:'#ffffff'});
        d.body.removeChild(wrap);
        const a=d.createElement('a');
        const title = (d.getElementById('song-title')?.value||'chords').replace(/\s+/g,'_');
        const key = (d.getElementById('to-key')?.value||d.getElementById('from-key')?.value||'C');
        a.href = canvas.toDataURL('image/png'); a.download=`${title}_${key}_export.png`; a.click();
      }), dlPng.__wired=true);
      dlTxt && !dlTxt.__wired && (dlTxt.addEventListener('click', ()=>{
        refreshExportPreview();
        const box = d.getElementById('export-preview-text');
        const text = (box ? box.value : gatherCurrentContent() || '').replace(/\r?\n/g,'\r\n');
        const blob = new Blob([text],{type:'text/plain;charset=utf-8'});
        const a = d.createElement('a');
        const title = (d.getElementById('song-title')?.value||'chords').replace(/\s+/g,'_');
        const key = (d.getElementById('to-key')?.value||d.getElementById('from-key')?.value||'C');
        a.href = URL.createObjectURL(blob);
        a.download = `${title}_${key}_export.txt`;
        a.style.display = 'none';
        d.body.appendChild(a);
        a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); d.body.removeChild(a); },1000);
      }), dlTxt.__wired=true);
      dlPdf && !dlPdf.__wired && (dlPdf.addEventListener('click', async ()=>{
        refreshExportPreview(); await new Promise(r=>setTimeout(r,50));
        if(!g.jspdf || !g.html2canvas){alert('匯出函式庫載入中，稍後再試');return;}
        const { jsPDF } = g.jspdf; const txt = d.getElementById('export-preview-text');
        const wrap = createExportWrap(txt.value); d.body.appendChild(wrap);
        adjustExportWrapWidth(wrap);
        const canvas = await g.html2canvas(wrap,{scale:2,backgroundColor:'#ffffff'}); d.body.removeChild(wrap);
        const pdf = new jsPDF({unit:'pt',format:'a4'});
        const pageWidth = pdf.internal.pageSize.getWidth();
        const margin=40; const imgWidth=pageWidth-margin*2; const imgHeight = canvas.height * (imgWidth/canvas.width);
        const sliceHeight = pdf.internal.pageSize.getHeight() - margin*2;
        if(imgHeight <= sliceHeight){
          pdf.addImage(canvas.toDataURL('image/png'),'PNG',margin,margin,imgWidth,imgHeight);
        } else {
          let position=0; while(position < canvas.height){
            const pageCanvas=d.createElement('canvas'); pageCanvas.width=canvas.width; const slicePx=Math.min(canvas.height-position, Math.floor(sliceHeight*(canvas.width/imgWidth))); pageCanvas.height=slicePx; const ctx=pageCanvas.getContext('2d'); ctx.drawImage(canvas,0,position,canvas.width,slicePx,0,0,canvas.width,slicePx); const pageImg=pageCanvas.toDataURL('image/png'); if(position>0) pdf.addPage(); pdf.addImage(pageImg,'PNG',margin,margin,imgWidth,slicePx*(imgWidth/canvas.width)); position+=slicePx; }
        }
        const title = (d.getElementById('song-title')?.value||'chords').replace(/\s+/g,'_');
        const key = (d.getElementById('to-key')?.value||d.getElementById('from-key')?.value||'C');
        pdf.save(`${title}_${key}_export.pdf`);
      }), dlPdf.__wired=true);

      // === 字型偏好 / 共享樣式統一套用 ===
      g.__applySharedTextStyle = function(){
        try{
          const monoEl = d.getElementById('export-mono-toggle');
          const boldEl = d.getElementById('export-bold-toggle');
          const useMono = monoEl ? (monoEl.checked !== false) : true;
          const useBold = boldEl ? !!boldEl.checked : false;
          const FONT_SANS = '"Microsoft JhengHei","微軟正黑體","Noto Sans TC","PingFang TC","Segoe UI",Arial,sans-serif';
          const FONT_MONO = 'ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace';
          const apply = (el)=>{ if(!el) return; el.style.fontFamily = useMono?FONT_MONO:FONT_SANS; el.style.fontWeight = useBold?'700':'400'; };
          apply(d.getElementById('transpose-output'));
          apply(d.getElementById('export-preview-text'));
          apply(d.getElementById('text-editor'));
        }catch(_){ }
      };
      // 儲存與監聽偏好
      (function(){
        const monoEl = d.getElementById('export-mono-toggle');
        const boldEl = d.getElementById('export-bold-toggle');
        const saveAndApply = ()=>{
          try{
            if(monoEl) localStorage.setItem('chordapp.pref.mono', monoEl.checked ? '1' : '0');
            if(boldEl) localStorage.setItem('chordapp.pref.bold', boldEl.checked ? '1' : '0');
          }catch(_){ }
          g.__applySharedTextStyle && g.__applySharedTextStyle();
        };
        if(monoEl && !monoEl.__wired){ monoEl.addEventListener('change', saveAndApply); monoEl.__wired=true; }
        if(boldEl && !boldEl.__wired){ boldEl.addEventListener('change', saveAndApply); boldEl.__wired=true; }
        // 初始化從偏好還原
        try{
          const m = localStorage.getItem('chordapp.pref.mono');
          const b = localStorage.getItem('chordapp.pref.bold');
          if(monoEl && (m==='0' || m==='1')) monoEl.checked = (m==='1');
          if(boldEl && (b==='0' || b==='1')) boldEl.checked = (b==='1');
        }catch(_){ }
        g.__applySharedTextStyle && g.__applySharedTextStyle();
      })();

      // === 原始影像縮放控制 ===
      (function(){
        const container = d.getElementById('recognition-original');
        const controlsBox = d.getElementById('zoom-controls');
        if(!container || !controlsBox) return;
        function applyZoom(mode){
          container.classList.remove('zoom-fit','zoom-actual');
            if(mode==='actual') container.classList.add('zoom-actual'); else container.classList.add('zoom-fit');
          try{ localStorage.setItem('chordapp.zoomMode', mode);}catch(_){ }
          controlsBox.querySelectorAll('button').forEach(b=>{
            const active = b.getAttribute('data-zoom')===mode;
            b.style.background = active ? 'var(--color-accent)' : '#fff';
            b.style.color = active ? '#fff' : 'var(--color-text)';
            b.style.borderColor = active ? 'var(--color-accent)' : 'var(--color-border)';
          });
        }
        controlsBox.addEventListener('click',e=>{
          const btn = e.target.closest('button[data-zoom]'); if(!btn) return;
          applyZoom(btn.getAttribute('data-zoom'));
        });
        // 初始化 zoom 模式
        let start='fit';
        try{ const saved=localStorage.getItem('chordapp.zoomMode'); if(saved) start=saved; }catch(_){ }
        applyZoom(start);
        // 暴露以便辨識完成後不覆蓋模式
        g.__applyRecognitionZoom = applyZoom;
      })();


      // === API Key 顯示切換 ===
      const showKeyChk = d.getElementById('show-key');
      const apiKeyInput = d.getElementById('api-key');
      if(showKeyChk && apiKeyInput && !showKeyChk.__wired){
        showKeyChk.addEventListener('change',()=>{ apiKeyInput.type = showKeyChk.checked ? 'text':'password'; });
        showKeyChk.__wired = true;
      }

      // === Model Selection Persistence ===
      const modelSelect = d.getElementById('gemini-model-select');
      if(modelSelect && !modelSelect.__wired){
        try {
          const savedModel = localStorage.getItem('chordapp.pref.geminiModel');
          if(savedModel) modelSelect.value = savedModel;
        } catch(_){}
        modelSelect.addEventListener('change', ()=>{
          try { localStorage.setItem('chordapp.pref.geminiModel', modelSelect.value); } catch(_){}
        });
        modelSelect.__wired = true;
      }

      // === Gemini API 呼叫核心（精簡版） ===
      async function fileToBase64Mime(file){
        return new Promise((resolve,reject)=>{
          const r=new FileReader();
            r.onerror=()=>reject(new Error('讀取檔案失敗'));
            r.onload=()=>{
              const res=r.result;
              const m=String(res).match(/^data:([^;]+);base64,(.*)$/);
              if(!m) return reject(new Error('無法解析 base64'));
              resolve({mimeType:m[1],base64:m[2]});
            };
          r.readAsDataURL(file);
        });
      }
      function buildPrompt(){
        return (
          '你是一個樂譜 OCR 專家。請從圖像偵測並輸出：\n' +
          '1) 樂曲標題 (Title)\n' +
          '2) 樂曲主調 (Key) 若無明示，根據和弦推測最可能調性 (只輸出一個，如 C / G / F# / Bb)。\n' +
          '3) 主要內容 (和弦 + 歌詞)\n\n' +
          '輸出格式請用下列 JSON 包在最外層的 ```json 程式碼區塊：\n' +
          '```json\n' +
          '{"title":"...","key":"...","content":"多行和弦與歌詞"}\n' +
          '```\n' +
          '規則：和弦行保留豎線 |，歌詞行移除 |；保持原段落順序與空白；不要加入多餘註解。'
        );
      }
      async function callGeminiAPIFromFile(file, apiKey){
        const {mimeType,base64}= await fileToBase64Mime(file);
        const body={contents:[{parts:[{text:buildPrompt()},{inlineData:{mimeType,data:base64}}]}],generationConfig:{temperature:0.1,maxOutputTokens:2048}};
        const modelSelect = d.getElementById('gemini-model-select');
        const modelName = modelSelect ? modelSelect.value : 'gemini-1.5-flash';
        const url=`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${encodeURIComponent(apiKey)}`;
        const resp= await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        if(!resp.ok){ const t=await resp.text(); throw new Error('Gemini API 錯誤 '+resp.status+': '+t.slice(0,200)); }
        const json= await resp.json();
        const text=json?.candidates?.[0]?.content?.parts?.map(p=>p.text).filter(Boolean).join('\n')||'';
        return text;
      }
      function formatDisplay(raw){
        const basic = String(raw).split('\n').map(line=>{ if(/\|/.test(line) && /[A-G][#b]?/.test(line)) return line; return line.replace(/\|/g,''); }).join('\n');
        if(window.restructureChordLyricsBlock){
          try { return window.restructureChordLyricsBlock(basic); } catch(_){ return basic; }
        }
        return basic;
      }
      function parseMetadataFromText(text){
        const meta={title:'',key:'',content:text};
        // 嘗試抓取 ```json 區塊
        const blockMatch = text.match(/```json[\s\S]*?({[\s\S]*?})\s*```/i);
        if(blockMatch){
          try {
            const obj = JSON.parse(blockMatch[1]);
            meta.title = obj.title || ''; meta.key = obj.key || ''; meta.content = obj.content || text;
            return meta;
          } catch{ /* ignore */ }
        }
        // 備援：簡單正則抓標題與 Key
        const titleLine = text.split(/\n/).find(l=>/title\s*[:：]/i.test(l)) || '';
        const mTitle = titleLine.match(/title\s*[:：]\s*(.+)/i);
        if(mTitle) meta.title = mTitle[1].trim();
        const keyLine = text.split(/\n/).find(l=>/key\s*[:：]/i.test(l)) || '';
        const mKey = keyLine.match(/key\s*[:：]\s*([A-G][#b]?)/i);
        if(mKey) meta.key = mKey[1].toUpperCase();
        return meta;
      }
      async function handleRecognize(){
        const file = fi?.files?.[0];
        const apiKey = apiKeyInput?.value.trim();
        const statusEl = d.getElementById('gemini-status');
        const out = d.getElementById('recognize-output');
        if(!file){ statusEl.textContent='請先選擇檔案'; return; }
        if(!apiKey){ statusEl.textContent='請輸入 API Key'; return; }
        statusEl.textContent='辨識中...'; out.style.display='none'; out.textContent='';
        try { const text = await callGeminiAPIFromFile(file, apiKey); const display = formatDisplay(text); out.textContent = display || '(無內容)'; out.style.display='block'; statusEl.textContent='完成'; }
        catch(err){ statusEl.textContent='錯誤: '+err.message; }
      }
      const rbtn1 = d.getElementById('recognize-btn');
      const rbtn2 = d.getElementById('recognize-btn-secondary');
      [rbtn1,rbtn2].forEach(btn=>{ if(btn && !btn.__wired){ btn.addEventListener('click',handleRecognize); btn.__wired=true; }});
  const rbtn3 = d.getElementById('recognize-ai-btn');
  if(rbtn3 && !rbtn3.__wired){ rbtn3.addEventListener('click',handleRecognize); rbtn3.__wired=true; }

  // 移除測試別名欄位（僅保留 #api-key）
      // 偵測調性手動修改同步
      const detectedKeyInput = d.getElementById('detected-key');
      if(detectedKeyInput && !detectedKeyInput.__wired){
        detectedKeyInput.addEventListener('change',()=>{
          let val = detectedKeyInput.value.trim();
          if(!val) return;
          // 正規化：首字母大寫 其餘轉小寫，再處理 b/#
            val = val.replace(/[^A-Ga-g#b]/g,'').toUpperCase().replace(/B(?!B)/,'B');
          // 映射降號 to 正式（保留原樣若合法）
          const allow = ['C','C#','D','Eb','D#','E','F','F#','G','Ab','G#','A','Bb','A#','B'];
          // 若同時存在升降重複，優先使用常見降號名稱
          const preferMap={'A#':'Bb','D#':'Eb','G#':'Ab'};
          if(preferMap[val]) val = preferMap[val];
          if(!allow.includes(val)) { detectedKeyInput.style.borderColor = '#e11d48'; return; }
          detectedKeyInput.style.borderColor = 'var(--color-border)';
          const fromSel = d.getElementById('from-key');
          if(fromSel){ [...fromSel.options].forEach(o=>{ if(o.value.toUpperCase()===val.toUpperCase()) fromSel.value=o.value; }); }
        });
        detectedKeyInput.__wired = true;
      }

      // === 成功後寫入編輯器並切換 ===
      const origImgBox = d.getElementById('recognition-original');
      async function handleRecognize(){
        const file = fi?.files?.[0];
        const apiKey = apiKeyInput?.value.trim();
        const statusEl = d.getElementById('gemini-status');
        const out = d.getElementById('recognize-output');
        if(!file){ statusEl.textContent='請先選擇檔案'; return; }
        if(!apiKey){ statusEl.textContent='請輸入 API Key'; return; }
        statusEl.textContent='辨識中...'; out.style.display='none'; out.textContent='';
        try { 
          const text = await callGeminiAPIFromFile(file, apiKey); 
          const meta = parseMetadataFromText(text);
          let display = formatDisplay(meta.content); 
          // 插入標題與 Key header
          const headerTitle = (meta.title||'').trim();
          const headerKey = (meta.key||'').trim();
          if(headerTitle || headerKey){
            const headerLines = [];
            if(headerTitle) headerLines.push(headerTitle);
            if(headerKey) headerLines.push('Key: ' + headerKey);
            display = headerLines.join('\n') + '\n\n' + display;
          }
          out.textContent = display || '(無內容)'; out.style.display='block'; statusEl.textContent='完成';
          // 存入全域狀態
          g.__LAST_AI_RESULT__ = display;
          if(meta.title) { const ti = d.getElementById('song-title'); ti && (ti.value = meta.title); }
          if(meta.key) { const dk = d.getElementById('from-key'); dk && (dk.value = meta.key); const dk2=d.getElementById('detected-key'); dk2 && (dk2.value=meta.key); }
          const editor = d.getElementById('text-editor');
          if(editor){ editor.value = display; d.getElementById('go-to-transpose')?.removeAttribute('disabled'); }
          // 原圖同步
          if(origImgBox){
            if(file.type==='application/pdf'){
              const cached = g.__PDF_FIRST_PAGE_DATAURL__;
              if(cached) origImgBox.innerHTML=`<img src="${cached}" style="max-width:100%;height:auto;display:block;">`;
              else origImgBox.innerHTML='<div style="padding:40px;text-align:center;font-size:13px;color:var(--color-text-secondary);">PDF 已上傳 (無預覽快取)</div>';
            }
            else {
              const url = URL.createObjectURL(file);
              origImgBox.innerHTML = `<img src="${url}" style="max-width:100%;height:auto;display:block;">`;
            }
          }
          g.switchView && g.switchView('recognition');
        }
        catch(err){ statusEl.textContent='錯誤: '+err.message; }
      }

      async function handleTextUpload(file){
        if(!file) return;
        const statusEl = d.getElementById('gemini-status');
        const out = d.getElementById('recognize-output');
        const editor = d.getElementById('text-editor');
        const origImgBox = d.getElementById('recognition-original');
        const goBtn = d.getElementById('go-to-transpose');
        const outArea = d.getElementById('transpose-output');
        const doTransBtn = d.getElementById('do-transpose');
        const finishBtn = d.getElementById('transpose-finish');
        const titleInput = d.getElementById('song-title');
        const detectedKeyInput = d.getElementById('detected-key');
        try{
          const raw = await file.text();
          const normalized = raw.replace(/\r\n/g,'\n');
          if(fi && fi.files && fi.files[0] !== file) return;
          if(out){ out.textContent = normalized || '(無內容)'; out.style.display='block'; }
          if(editor){ editor.value = normalized; }
          if(statusEl) statusEl.textContent = '已載入文字檔，已略過 AI 辨識。';
          if(goBtn) goBtn.removeAttribute('disabled');
          if(outArea) outArea.value = normalized;
          if(doTransBtn){ doTransBtn.disabled=false; doTransBtn.removeAttribute('disabled'); }
          if(finishBtn){ finishBtn.disabled=false; finishBtn.removeAttribute('disabled'); }
          if(titleInput && !titleInput.value){ titleInput.value = file.name ? file.name.replace(/\.[^.]*$/, '').trim() : ''; }
          if(origImgBox){
            origImgBox.innerHTML = '<div style="padding:24px;font-size:13px;color:var(--color-text-secondary);">此為文字檔，已直接載入內容供編輯。</div>';
          }
          if(detectedKeyInput){
            let matchedKey = '';
            if(!detectedKeyInput.value){
              const keyMatch = normalized.match(/^\s*Key\s*:\s*([A-G][#b]?)/im);
              if(keyMatch) matchedKey = keyMatch[1];
            }
            if(matchedKey){
              detectedKeyInput.value = matchedKey;
              const fromSel = d.getElementById('from-key');
              if(fromSel){
                [...fromSel.options].forEach(o=>{ if(o.value.toUpperCase()===matchedKey.toUpperCase()) fromSel.value=o.value; });
              }
            }
            detectedKeyInput.style.borderColor = 'var(--color-border)';
          }
          try{ g.setSharedText && g.setSharedText(normalized,'text-upload'); g.__LAST_AI_RESULT__ = normalized; }catch(_){ }
          g.switchView && g.switchView('recognition');
        }catch(err){
          console.warn('[text upload] read fail', err);
          if(statusEl) statusEl.textContent = '文字檔讀取失敗';
        }
      }

      // === 移調功能 ===
      function transposeNote(note, diff){
        const notes=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
        const flats={'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Bb':'A#'};
        const m=String(note||'').trim().match(/^([A-Ga-g])([b#]?)/);
        if(!m) return note;
        const base=m[1].toUpperCase() + (m[2]==='#'?'#':(m[2]==='b'?'b':''));
        const n=flats[base]||base; const i=notes.indexOf(n); if(i<0) return base; return notes[(i+diff+12)%12];
      }
  function transposeChord(ch, diff){
        const m = ch.match(/^([A-G][b#]?)(.*)$/);
        if(!m) return ch;
        const root = transposeNote(m[1], diff);
        let rest = m[2]||'';
    // 轉換 slash 低音：允許半形/全形斜線與空白，保留原斜線字元與空白
    rest = rest.replace(/([\/／])(\s*)([A-G][#b]?)/g, (s, slash, sp, bass)=> slash + sp + transposeNote(bass,diff));
        return root + rest;
      }
  // 僅允許單一和弦（可選擴展）與可選 slash 低音，避免吃到下一個和弦
  function detectChordToken(tok){ return /^[A-G][#b]?(?:[a-zA-Z0-9()#]*)?(?:\s*[\/／]\s*[A-G][#b]?)?$/.test(tok); }
      function transposeText(txt, fromKey, toKey){
        const notes=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
        const flatToSharp={'Db':'C#','Eb':'D#','Gb':'F#','Ab':'G#','Bb':'A#'};
        function norm(k){return flatToSharp[k]||k;}
        const diff = (notes.indexOf(norm(toKey)) - notes.indexOf(norm(fromKey)) + 12) % 12;
        return txt.split(/\n/).map(line=>{
          // 保留 header 行（Title/Key）不轉
          if(/^Key:\s*/i.test(line) || line.trim()=== '' || line.length<2) return line;
            // 判斷是否為和弦密集行（含豎線或多個和弦片段）
            const slashChord = /[A-G][#b]?\s*[\/／]\s*[A-G][#b]?/.test(line);
            const chordLike = /\|/.test(line) || slashChord || (line.match(/[A-G][#b]?/g)||[]).length>2;
            if(!chordLike) return line; 
            // 單一和弦 token（含可選 slash 低音），避免跨越到下一個和弦（例如 "Am7  A/C#"）
            return line.replace(/([A-G][#b]?(?:[a-zA-Z0-9()#]*)?(?:\s*[\/／]\s*[A-G][#b]?)?)/g,(m)=>{
              if(!detectChordToken(m)) return m;
              return transposeChord(m,diff);
            });
        }).join('\n');
      }
  const goTrans = d.getElementById('go-to-transpose');
      const backUpload = d.getElementById('back-to-upload');
      const doTrans = d.getElementById('do-transpose');
      const backEdit = d.getElementById('transpose-back');
      const finishBtn = d.getElementById('transpose-finish');
      const outArea = d.getElementById('transpose-output');
  // 返回按鈕：上傳頁與編輯頁分開導向
  backUpload && backUpload.addEventListener('click',()=> g.switchView && g.switchView('upload'));
  backEdit && backEdit.addEventListener('click',()=> g.switchView && g.switchView('recognition'));
      goTrans && goTrans.addEventListener('click',()=>{ 
        doTrans && (doTrans.disabled=false); 
        g.switchView && g.switchView('transpose'); 
        const src = d.getElementById('text-editor')?.value||''; 
        outArea.value = src; 
        try{ g.setSharedText && g.setSharedText(outArea.value,'go-transpose'); }catch(_){ }
        finishBtn && (finishBtn.disabled=false); 
        const ti = d.getElementById('song-title')?.value; if(ti) document.title = ti + ' - 移調'; 
      });
      // 更改和弦；若存在 Key 行則僅更新其值為目標調（不新增新的 Key 行），排版原樣保留
      doTrans && doTrans.addEventListener('click',()=>{ 
        const src = (outArea?.value || d.getElementById('text-editor')?.value || ''); 
        const fk = d.getElementById('from-key').value; 
        const tk = d.getElementById('to-key').value; 
        const api = (window.__transpose__ && window.__transpose__.transposeText) || transposeText;
        let out = api(src,fk,tk);
        try{
          const lines = out.split(/\n/);
          for(let i=0;i<lines.length;i++){
            if(/^(\s*Key\s*:\s*)/i.test(lines[i])){
              lines[i] = lines[i].replace(/^(\s*Key\s*:\s*)([A-G][#b]?)(.*)$/i, (m,p1,_old,p3)=> p1+tk+p3);
              break;
            }
          }
          out = lines.join('\n');
        }catch(_){ }
        outArea.value = out;
        try{ g.setSharedText && g.setSharedText(out,'transpose'); }catch(_){ }
      });

      // 前往匯出：啟用後可直接滑到第四頁並刷新預覽
      finishBtn && finishBtn.addEventListener('click',()=>{
        try{ g.setSharedText && g.setSharedText(outArea?.value||'','transpose-finish'); }catch(_){ }
        g.switchView && g.switchView('export');
        try { typeof refreshExportPreview==='function' && refreshExportPreview(); } catch(_){ }
      });

      // 手動編輯同步：移調輸出與匯出預覽
      if(outArea && !outArea.__wired){ outArea.addEventListener('input',()=>{ try{ g.setSharedText && g.setSharedText(outArea.value,'transpose-edit'); }catch(_){ } }); outArea.__wired=true; }
      (function(){ const box=d.getElementById('export-preview-text'); if(box && !box.__wired){ box.addEventListener('input',()=>{ try{ g.setSharedText && g.setSharedText(box.value,'export-edit'); }catch(_){ } }); box.__wired=true; } })();

      // 進入各頁回填共享文字
      g.__onEnterView.transpose = function(){ try{ const t=g.getSharedText?g.getSharedText():''; if(t && outArea && outArea.value!==t) outArea.value=t; }catch(_){ } };
      g.__onEnterView.export = function(){ try{ const t=g.getSharedText?g.getSharedText():''; const box=d.getElementById('export-preview-text'); if(box && t && box.value!==t) box.value=t; }catch(_){ } };

      // 標題 / 調性變更即時套用到正文首部（不影響移調結果除非重跑）
      const songTitleInput = d.getElementById('song-title');
      function updateHeaderInEditor(){
        const editor = d.getElementById('text-editor'); if(!editor) return;
        const val = editor.value.split(/\n/);
        let idxKey = val.findIndex(l=>/^Key:\s*/i.test(l));
        let idxTitle = val.findIndex(l=>l.trim() && !/^Key:/i.test(l));
        if(idxTitle<0) idxTitle=0;
        const title = (songTitleInput?.value||'').trim();
        if(title){ if(idxTitle===0) val[0]=title; else val.unshift(title); }
        if(detectedKeyInput){ const k = detectedKeyInput.value.trim(); if(k){ if(idxKey>=0) val[idxKey]='Key: '+k; else val.splice( (title?1:0),0,'Key: '+k); } }
        editor.value = val.join('\n');
      }
      songTitleInput && songTitleInput.addEventListener('change',updateHeaderInEditor);
      detectedKeyInput && detectedKeyInput.addEventListener('change',updateHeaderInEditor);

  })(window,document);
</script>
</body>
</html>